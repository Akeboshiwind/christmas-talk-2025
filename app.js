var G9=Object.create;var{getPrototypeOf:J9,defineProperty:$w,getOwnPropertyNames:N9}=Object;var X9=Object.prototype.hasOwnProperty;var Q9=(u,W,J)=>{J=u!=null?G9(J9(u)):{};let N=W||!u||!u.__esModule?$w(J,"default",{value:u,enumerable:!0}):J;for(let H of N9(u))if(!X9.call(N,H))$w(N,H,{get:()=>u[H],enumerable:!0});return N};var w0=(u,W)=>()=>(W||u((W={exports:{}}).exports,W),W.exports);var mw=w0((Aq,S5)=>{(function(u,W){if(typeof Aq=="object"&&typeof S5=="object")S5.exports=W();else if(typeof define=="function"&&define.amd)define([],W);else if(typeof Aq=="object")Aq.Ably=W();else u.Ably=W()})(Aq,()=>{var u={},W={exports:u},J=Object.defineProperty,N=Object.defineProperties,H=Object.getOwnPropertyDescriptor,K=Object.getOwnPropertyDescriptors,V=Object.getOwnPropertyNames,h=Object.getOwnPropertySymbols,Y=Object.prototype.hasOwnProperty,S=Object.prototype.propertyIsEnumerable,b=(q,$,w)=>($ in q)?J(q,$,{enumerable:!0,configurable:!0,writable:!0,value:w}):q[$]=w,_=(q,$)=>{for(var w in $||($={}))if(Y.call($,w))b(q,w,$[w]);if(h){for(var w of h($))if(S.call($,w))b(q,w,$[w])}return q},c=(q,$)=>N(q,K($)),u0=(q,$)=>{var w={};for(var Z in q)if(Y.call(q,Z)&&$.indexOf(Z)<0)w[Z]=q[Z];if(q!=null&&h){for(var Z of h(q))if($.indexOf(Z)<0&&S.call(q,Z))w[Z]=q[Z]}return w},x=(q,$)=>{for(var w in $)J(q,w,{get:$[w],enumerable:!0})},P=(q,$,w,Z)=>{if($&&typeof $==="object"||typeof $==="function"){for(let G of V($))if(!Y.call(q,G)&&G!==w)J(q,G,{get:()=>$[G],enumerable:!(Z=H($,G))||Z.enumerable})}return q},f=(q)=>P(J({},"__esModule",{value:!0}),q),p={};x(p,{ErrorInfo:()=>D,Realtime:()=>w5,Rest:()=>r8,default:()=>W9,makeProtocolMessageFromDeserialized:()=>_7,msgpack:()=>Q5}),W.exports=f(p);var B=class{},e=typeof global<"u"?global:typeof window<"u"?window:self;function N0(q,$){return`${q}`.padStart($?3:2,"0")}function $0(q){return B.Config.logTimestamps?function($){let w=new Date;q(N0(w.getHours())+":"+N0(w.getMinutes())+":"+N0(w.getSeconds())+"."+N0(w.getMilliseconds(),1)+" "+$)}:function($){q($)}}var G0=()=>{var q;let $,w;if(typeof((q=e==null?void 0:e.console)==null?void 0:q.log)==="function")$=function(...Z){console.log.apply(console,Z)},w=console.warn?function(...Z){console.warn.apply(console,Z)}:$;else $=w=function(){};return[$,w].map($0)},l=class q{constructor(){this.deprecated=($,w)=>{this.deprecationWarning(`${$} is deprecated and will be removed in a future version. ${w}`)},this.shouldLog=($)=>{return $<=this.logLevel},this.setLog=($,w)=>{if($!==void 0)this.logLevel=$;if(w!==void 0)this.logHandler=this.logErrorHandler=w},this.logLevel=q.defaultLogLevel,this.logHandler=q.defaultLogHandler,this.logErrorHandler=q.defaultLogErrorHandler}static initLogHandlers(){let[$,w]=G0();this.defaultLogHandler=$,this.defaultLogErrorHandler=w,this.defaultLogger=new q}static logActionNoStrip($,w,Z,G){$.logAction(w,Z,G)}logAction($,w,Z){if(this.shouldLog($))($===1?this.logErrorHandler:this.logHandler)("Ably: "+w+": "+Z,$)}renamedClientOption($,w){this.deprecationWarning(`The \`${$}\` client option has been renamed to \`${w}\`. Please update your code to use \`${w}\` instead. \`${$}\` will be removed in a future version.`)}renamedMethod($,w,Z){this.deprecationWarning(`\`${$}\`’s \`${w}\` method has been renamed to \`${Z}\`. Please update your code to use \`${Z}\` instead. \`${w}\` will be removed in a future version.`)}deprecationWarning($){if(this.shouldLog(1))this.logErrorHandler(`Ably: Deprecation warning - ${$}`,1)}};l.defaultLogLevel=1,l.LOG_NONE=0,l.LOG_ERROR=1,l.LOG_MAJOR=2,l.LOG_MINOR=3,l.LOG_MICRO=4,l.logAction=(q,$,w,Z)=>{l.logActionNoStrip(q,$,w,Z)};var H0=l,Q=H0,z0={};x(z0,{Format:()=>Y$,allSame:()=>B$,allToLowerCase:()=>c8,allToUpperCase:()=>L$,arrChooseN:()=>M$,arrDeleteValue:()=>F$,arrEquals:()=>T$,arrIntersect:()=>V$,arrIntersectOb:()=>z$,arrPopRandomElement:()=>b8,arrWithoutValue:()=>Lu,cheapRandStr:()=>gq,containsValue:()=>Mu,copy:()=>Y1,createMissingPluginError:()=>vq,dataSizeBytes:()=>j$,decodeBody:()=>F0,encodeBody:()=>P0,ensureArray:()=>U$,forInOwnNonNullProperties:()=>D$,getBackoffCoefficient:()=>R$,getGlobalObject:()=>P8,getJitterCoefficient:()=>S$,getRetryTime:()=>E8,inherits:()=>Au,inspectBody:()=>I$,inspectError:()=>W0,intersect:()=>O$,isEmpty:()=>Iu,isErrorInfoOrPartialErrorInfo:()=>T8,isNil:()=>E0,isObject:()=>I1,keysArray:()=>r1,matchDerivedChannel:()=>b$,mixin:()=>y,parseQueryString:()=>iq,prototypicalClone:()=>K$,randomString:()=>A$,shallowClone:()=>ju,shallowEquals:()=>_$,throwMissingPluginError:()=>h0,toBase64:()=>pq,toQueryString:()=>a1,valuesArray:()=>h$,whenPromiseSettles:()=>j0,withTimeoutAsync:()=>c$});function i0(q){let $="["+q.constructor.name;if(q.message)$+=": "+q.message;if(q.statusCode)$+="; statusCode="+q.statusCode;if(q.code)$+="; code="+q.code;if(q.cause)$+="; cause="+W0(q.cause);if(q.href&&!(q.message&&q.message.indexOf("help.ably.io")>-1))$+="; see "+q.href+" ";return $+="]",$}var D=class q extends Error{constructor($,w,Z,G){super($);if(typeof Object.setPrototypeOf<"u")Object.setPrototypeOf(this,q.prototype);this.code=w,this.statusCode=Z,this.cause=G}toString(){return i0(this)}static fromValues($){let{message:w,code:Z,statusCode:G}=$;if(typeof w!=="string"||typeof Z!=="number"||typeof G!=="number")throw Error("ErrorInfo.fromValues(): invalid values: "+B.Config.inspect($));let X=Object.assign(new q(w,Z,G),$);if(X.code&&!X.href)X.href="https://help.ably.io/error/"+X.code;return X}},r=class q extends Error{constructor($,w,Z,G){super($);if(typeof Object.setPrototypeOf<"u")Object.setPrototypeOf(this,q.prototype);this.code=w,this.statusCode=Z,this.cause=G}toString(){return i0(this)}static fromValues($){let{message:w,code:Z,statusCode:G}=$;if(typeof w!=="string"||!E0(Z)&&typeof Z!=="number"||!E0(G)&&typeof G!=="number")throw Error("PartialErrorInfo.fromValues(): invalid values: "+B.Config.inspect($));let X=Object.assign(new q(w,Z,G),$);if(X.code&&!X.href)X.href="https://help.ably.io/error/"+X.code;return X}};function K1(q){return Math.floor(Math.random()*q.length)}function y(q,...$){for(let w=0;w<$.length;w++){let Z=$[w];if(!Z)break;for(let G in Z)if(Object.prototype.hasOwnProperty.call(Z,G))q[G]=Z[G]}return q}function Y1(q){return y({},q)}function U$(q){if(E0(q))return[];if(Array.isArray(q))return q;return[q]}function I1(q){return Object.prototype.toString.call(q)=="[object Object]"}function Iu(q){for(let $ in q)return!1;return!0}function E0(q){return q==null}function ju(q){let $={};for(let w in q)$[w]=q[w];return $}function K$(q,$){class w{}w.prototype=q;let Z=new w;if($)y(Z,$);return Z}var Au=function(q,$){if(B.Config.inherits){B.Config.inherits(q,$);return}q.super_=$,q.prototype=K$($.prototype,{constructor:q})};function Mu(q,$){for(let w in q)if(q[w]==$)return!0;return!1}function O$(q,$){return Array.isArray($)?V$(q,$):z$(q,$)}function V$(q,$){let w=[];for(let Z=0;Z<q.length;Z++){let G=q[Z];if($.indexOf(G)!=-1)w.push(G)}return w}function z$(q,$){let w=[];for(let Z=0;Z<q.length;Z++){let G=q[Z];if(G in $)w.push(G)}return w}function F$(q,$){let w=q.indexOf($),Z=w!=-1;if(Z)q.splice(w,1);return Z}function Lu(q,$){let w=q.slice();return F$(w,$),w}function r1(q,$){let w=[];for(let Z in q){if($&&!Object.prototype.hasOwnProperty.call(q,Z))continue;w.push(Z)}return w}function h$(q,$){let w=[];for(let Z in q){if($&&!Object.prototype.hasOwnProperty.call(q,Z))continue;w.push(q[Z])}return w}function D$(q,$){for(let w in q)if(Object.prototype.hasOwnProperty.call(q,w)&&q[w])$(w)}function B$(q,$){if(q.length===0)return!0;let w=q[0][$];return q.every(function(Z){return Z[$]===w})}var Y$=((q)=>{return q.msgpack="msgpack",q.json="json",q})(Y$||{});function b8(q){return q.splice(K1(q),1)[0]}function a1(q){let $=[];if(q)for(let w in q)$.push(encodeURIComponent(w)+"="+encodeURIComponent(q[w]));return $.length?"?"+$.join("&"):""}function iq(q){let $,w=/([^?&=]+)=?([^&]*)/g,Z={};while($=w.exec(q))Z[decodeURIComponent($[1])]=decodeURIComponent($[2]);return Z}function T8(q){return typeof q=="object"&&q!==null&&(q instanceof D||q instanceof r)}function W0(q){var $,w;if(q instanceof Error||(($=q==null?void 0:q.constructor)==null?void 0:$.name)==="ErrorInfo"||((w=q==null?void 0:q.constructor)==null?void 0:w.name)==="PartialErrorInfo")return q.toString();return B.Config.inspect(q)}function I$(q){if(B.BufferUtils.isBuffer(q))return q.toString();else if(typeof q==="string")return q;else return B.Config.inspect(q)}function j$(q){if(B.BufferUtils.isBuffer(q))return B.BufferUtils.byteLength(q);if(typeof q==="string")return B.Config.stringByteSize(q);if(typeof q==="number")return 8;if(typeof q==="boolean")return 1;throw Error(`Expected input of Utils.dataSizeBytes to be a string, a number, a boolean or a buffer, but was: ${typeof q}`)}function gq(){return String(Math.random()).substr(2)}var A$=async(q)=>{let $=await B.Config.getRandomArrayBuffer(q);return B.BufferUtils.base64Encode($)};function M$(q,$){let w=Math.min($,q.length),Z=q.slice(),G=[];for(let X=0;X<w;X++)G.push(b8(Z));return G}function j0(q,$){q.then((w)=>{$==null||$(null,w)}).catch((w)=>{$==null||$(w)})}function F0(q,$,w){if(w=="msgpack"){if(!$)h0("MsgPack");return $.decode(q)}return JSON.parse(String(q))}function P0(q,$,w){if(w=="msgpack"){if(!$)h0("MsgPack");return $.encode(q,!0)}return JSON.stringify(q)}function c8(q){return q.map(function($){return $&&$.toLowerCase()})}function L$(q){return q.map(function($){return $&&$.toUpperCase()})}function R$(q){return Math.min((q+2)/3,2)}function S$(){return 1-Math.random()*0.2}function E8(q,$){return q*R$($)*S$()}function P8(){if(typeof global<"u")return global;if(typeof window<"u")return window;return self}function _$(q,$){return Object.keys(q).every((w)=>q[w]===$[w])&&Object.keys($).every((w)=>$[w]===q[w])}function b$(q){let $=/^(\[([^?]*)(?:(.*))\])?(.+)$/,w=q.match($);if(!w||!w.length||w.length<5)throw new D("regex match failed",400,40010);if(w[2])throw new D(`cannot use a derived option with a ${w[2]} channel`,400,40010);return{qualifierParam:w[3]||"",channelName:w[4]}}function pq(q){let $=B.BufferUtils,w=$.utf8Encode(q);return $.base64Encode(w)}function T$(q,$){return q.length===$.length&&q.every(function(w,Z){return w===$[Z]})}function vq(q){return new D(`${q} plugin not provided`,40019,400)}function h0(q){throw vq(q)}async function c$(q,$=5000,w="Timeout expired"){let Z=new D(w,50000,500);return Promise.race([q,new Promise((G,X)=>setTimeout(()=>X(Z),$))])}var E$="2.15.0",Ru="ably-js/"+E$,C0={ENDPOINT:"main",ENVIRONMENT:"",REST_HOST:"rest.ably.io",REALTIME_HOST:"realtime.ably.io",FALLBACK_HOSTS:["main.a.fallback.ably-realtime.com","main.b.fallback.ably-realtime.com","main.c.fallback.ably-realtime.com","main.d.fallback.ably-realtime.com","main.e.fallback.ably-realtime.com"],PORT:80,TLS_PORT:443,TIMEOUTS:{disconnectedRetryTimeout:15000,suspendedRetryTimeout:30000,httpRequestTimeout:1e4,httpMaxRetryDuration:15000,channelRetryTimeout:15000,fallbackRetryTimeout:600000,connectionStateTtl:120000,realtimeRequestTimeout:1e4,recvTimeout:90000,webSocketConnectTimeout:1e4,webSocketSlowTimeout:4000},httpMaxRetryCount:3,maxMessageSize:65536,version:E$,protocolVersion:4,agent:Ru,getPort:Su,getHttpScheme:_u,getPrimaryDomainFromEndpoint:C$,getEndpointFallbackHosts:k$,getFallbackHosts:n$,getHosts:bu,checkHost:i$,objectifyOptions:cu,normaliseOptions:Pu,defaultGetHeaders:Cu,defaultPostHeaders:ku};function Su(q,$){return $||q.tls?q.tlsPort:q.port}function _u(q){return q.tls?"https://":"http://"}function P$(q){return q.includes(".")||q.includes("::")||q==="localhost"}function C$(q){if(P$(q))return q;if(q.startsWith("nonprod:"))return`${q.replace("nonprod:","")}.realtime.ably-nonprod.net`;return`${q}.realtime.ably.net`}function k$(q){if(P$(q))return[];if(q.startsWith("nonprod:")){let $=q.replace("nonprod:","");return y$($,"ably-realtime-nonprod.com")}return y$(q,"ably-realtime.com")}function y$(q,$){return["a","b","c","d","e"].map((w)=>`${q}.${w}.fallback.${$}`)}function n$(q){let $=q.fallbackHosts,w=typeof q.httpMaxRetryCount<"u"?q.httpMaxRetryCount:C0.httpMaxRetryCount;return $?M$($,w):[]}function bu(q){return[q.primaryDomain].concat(n$(q))}function i$(q){if(typeof q!=="string")throw new D("host must be a string; was a "+typeof q,40000,400);if(!q.length)throw new D("host must not be zero-length",40000,400)}function Tu(q){let $={};for(let w in C0.TIMEOUTS)$[w]=q[w]||C0.TIMEOUTS[w];return $}function C8(q){let $=C0.agent;if(q.agents)for(var w in q.agents)$+=" "+w+"/"+q.agents[w];return $}function cu(q,$,w,Z,G){if(q===void 0){let U=$?`${w} must be initialized with either a client options object, an Ably API key, or an Ably Token`:`${w} must be initialized with a client options object`;throw Q.logAction(Z,Q.LOG_ERROR,`${w}()`,U),Error(U)}let X;if(typeof q==="string")if(q.indexOf(":")==-1){if(!$){let U=`${w} cannot be initialized with just an Ably Token; you must provide a client options object with a \`plugins\` property. (Set this Ably Token as the object’s \`token\` property.)`;throw Q.logAction(Z,Q.LOG_ERROR,`${w}()`,U),Error(U)}X={token:q}}else{if(!$){let U=`${w} cannot be initialized with just an Ably API key; you must provide a client options object with a \`plugins\` property. (Set this Ably API key as the object’s \`key\` property.)`;throw Q.logAction(Z,Q.LOG_ERROR,`${w}()`,U),Error(U)}X={key:q}}else X=q;if(G)X=c(_({},X),{plugins:_(_({},G),X.plugins)});return X}function Eu(q){if(q.endpoint&&(q.environment||q.restHost||q.realtimeHost))throw new D("The `endpoint` option cannot be used in conjunction with the `environment`, `restHost`, or `realtimeHost` options.",40106,400);if(q.environment&&(q.restHost||q.realtimeHost))throw new D("The `environment` option cannot be used in conjunction with the `restHost`, or `realtimeHost` options.",40106,400)}function Pu(q,$,w){let Z=w!=null?w:Q.defaultLogger;if(q.environment)Z.deprecated("The `environment` client option","Use the `endpoint` client option instead.");if(q.restHost)Z.deprecated("The `restHost` client option","Use the `endpoint` client option instead.");if(q.realtimeHost)Z.deprecated("The `realtimeHost` client option","Use the `endpoint` client option instead.");if(Eu(q),typeof q.recover==="function"&&q.closeOnUnload===!0)Q.logAction(Z,Q.LOG_ERROR,"Defaults.normaliseOptions","closeOnUnload was true and a session recovery function was set - these are mutually exclusive, so unsetting the latter"),q.recover=void 0;if(!("closeOnUnload"in q))q.closeOnUnload=!q.recover;if(!("queueMessages"in q))q.queueMessages=!0;let G=q.endpoint||C0.ENDPOINT;if(!q.fallbackHosts&&!q.restHost&&!q.realtimeHost&&!q.port&&!q.tlsPort)q.fallbackHosts=k$(q.environment||G);let X=q.environment&&`${q.environment}.realtime.ably.net`,O=q.restHost||q.realtimeHost||X||C$(G);if((q.fallbackHosts||[]).concat(O).forEach(i$),q.port=q.port||C0.PORT,q.tlsPort=q.tlsPort||C0.TLS_PORT,!("tls"in q))q.tls=!0;let F=Tu(q);if($)if("useBinaryProtocol"in q)q.useBinaryProtocol=B.Config.supportsBinary&&q.useBinaryProtocol;else q.useBinaryProtocol=B.Config.preferBinary;else q.useBinaryProtocol=!1;let z={};if(q.clientId)z["X-Ably-ClientId"]=B.BufferUtils.base64Encode(B.BufferUtils.utf8Encode(q.clientId));if(!("idempotentRestPublishing"in q))q.idempotentRestPublishing=!0;let I=null,j=q.connectivityCheckUrl;if(q.connectivityCheckUrl){let[M,E]=q.connectivityCheckUrl.split("?");if(I=E?iq(E):{},M.indexOf("://")===-1)M="https://"+M;j=M}let A=q.wsConnectivityCheckUrl;if(A&&A.indexOf("://")===-1)A="wss://"+A;return c(_({},q),{primaryDomain:O,maxMessageSize:q.maxMessageSize||C0.maxMessageSize,timeouts:F,connectivityCheckParams:I,connectivityCheckUrl:j,wsConnectivityCheckUrl:A,headers:z})}function xq(q,$,w){let Z=w||{};if(Z.cipher){if(!q)h0("Crypto");let G=q.getCipher(Z.cipher,$);Z.cipher=G.cipherParams,Z.channelCipher=G.cipher}else if("cipher"in Z)Z.cipher=void 0,Z.channelCipher=null;return Z}var g$={json:"application/json",xml:"application/xml",html:"text/html",msgpack:"application/x-msgpack",text:"text/plain"},p$={format:"json",protocolVersion:C0.protocolVersion};function Cu(q,{format:$,protocolVersion:w=p$.protocolVersion}={}){return{accept:g$[$!=null?$:q.useBinaryProtocol?"msgpack":"json"],"X-Ably-Version":w.toString(),"Ably-Agent":C8(q)}}function ku(q,{format:$,protocolVersion:w=p$.protocolVersion}={}){let Z=g$[$!=null?$:q.useBinaryProtocol?"msgpack":"json"];return{accept:Z,"content-type":Z,"X-Ably-Version":w.toString(),"Ably-Agent":C8(q)}}var k=C0;function yu(q){return Object.assign(C0,q)}var nu=class q{constructor($,w){this.logger=$,this.members=w||[]}call($,w){for(let Z of this.members)if(Z)try{Z($,w)}catch(G){Q.logAction(this.logger,Q.LOG_ERROR,"Multicaster multiple callback handler","Unexpected exception: "+G+"; stack = "+G.stack)}}push(...$){this.members.push(...$)}createPromise(){return new Promise(($,w)=>{this.push((Z,G)=>{Z?w(Z):$(G)})})}resolveAll($){this.call(null,$)}rejectAll($){this.call($)}static create($,w){let Z=new q($,w);return Object.assign((G,X)=>Z.call(G,X),{push:(G)=>Z.push(G),createPromise:()=>Z.createPromise(),resolveAll:(G)=>Z.resolveAll(G),rejectAll:(G)=>Z.rejectAll(G)})}},k8=nu,v$=((q)=>{return q.Get="get",q.Delete="delete",q.Post="post",q.Put="put",q.Patch="patch",q})(v$||{}),U0=v$,x$=((q)=>{return q[q.Success=200]="Success",q[q.NoContent=204]="NoContent",q[q.BadRequest=400]="BadRequest",q[q.Unauthorized=401]="Unauthorized",q[q.Forbidden=403]="Forbidden",q[q.RequestTimeout=408]="RequestTimeout",q[q.InternalServerError=500]="InternalServerError",q})(x$||{});function iu(q){return q>=200&&q<400}var dq=x$,y8=Math.pow(2,17);function gu(){return("000000"+Math.floor(Math.random()*10000000000000000)).slice(-16)}function pu(q){return!!q.connection}function d$(q){if(!T8(q))return new D(W0(q),q.code||40170,q.statusCode||401);if(!q.code)if(q.statusCode===403)q.code=40300;else q.code=40170,q.statusCode=401;return q}var vu=(q,$)=>{let w=B.BufferUtils,Z=w.utf8Encode(q),G=w.utf8Encode($),X=w.hmacSha256(Z,G);return w.base64Encode(X)};function t$(q){if(!q)return"";if(typeof q=="string")q=JSON.parse(q);let $=Object.create(null),w=r1(q,!0);if(!w)return"";w.sort();for(let Z=0;Z<w.length;Z++)$[w[Z]]=q[w[Z]].sort();return JSON.stringify($)}function f$(q,$){if(q.authCallback)Q.logAction($,Q.LOG_MINOR,"Auth()","using token auth with authCallback");else if(q.authUrl)Q.logAction($,Q.LOG_MINOR,"Auth()","using token auth with authUrl");else if(q.key)Q.logAction($,Q.LOG_MINOR,"Auth()","using token auth with client-side signing");else if(q.tokenDetails)Q.logAction($,Q.LOG_MINOR,"Auth()","using token auth with supplied token only");else throw Q.logAction($,Q.LOG_ERROR,"Auth()","authOptions must include valid authentication parameters"),Error("authOptions must include valid authentication parameters")}function xu(q){return"useTokenAuth"in q&&!q.useTokenAuth}function m$(q){return q.useTokenAuth||!xu(q)&&(q.authCallback||q.authUrl||q.token||q.tokenDetails)}function du(q){return!q.key&&!q.authCallback&&!q.authUrl}var tu=0;function fu(){return tu++}var mu=class{constructor(q,$){if(this.authOptions={},this.client=q,this.tokenParams=$.defaultTokenParams||{},this.currentTokenRequestId=null,this.waitingForTokenRequest=null,m$($)){if(du($))Q.logAction(this.logger,Q.LOG_ERROR,"Auth()","Warning: library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help");this._saveTokenOptions($.defaultTokenParams,$),f$(this.authOptions,this.logger)}else{if(!$.key)throw Q.logAction(this.logger,Q.LOG_ERROR,"Auth()","No authentication options provided; need one of: key, authUrl, or authCallback (or for testing only, token or tokenDetails)"),new D("No authentication options provided; need one of: key, authUrl, or authCallback (or for testing only, token or tokenDetails)",40160,401);Q.logAction(this.logger,Q.LOG_MINOR,"Auth()","anonymous, using basic auth"),this._saveBasicOptions($)}}get logger(){return this.client.logger}async authorize(q,$){if($&&$.key&&this.authOptions.key!==$.key)throw new D("Unable to update auth options with incompatible key",40102,401);try{let w=await this._forceNewToken(q!=null?q:null,$!=null?$:null);if(pu(this.client))return new Promise((Z,G)=>{this.client.connection.connectionManager.onAuthUpdated(w,(X,U)=>X?G(X):Z(U))});else return w}catch(w){if(this.client.connection&&w.statusCode===dq.Forbidden)this.client.connection.connectionManager.actOnErrorFromAuthorize(w);throw w}}async _forceNewToken(q,$){this.tokenDetails=null,this._saveTokenOptions(q,$),f$(this.authOptions,this.logger);try{return this._ensureValidAuthCredentials(!0)}finally{delete this.tokenParams.timestamp,delete this.authOptions.queryTime}}async requestToken(q,$){let w=$||this.authOptions,Z=q||Y1(this.tokenParams),G,X=this.client;if(w.authCallback)Q.logAction(this.logger,Q.LOG_MINOR,"Auth.requestToken()","using token auth with authCallback"),G=w.authCallback;else if(w.authUrl)Q.logAction(this.logger,Q.LOG_MINOR,"Auth.requestToken()","using token auth with authUrl"),G=(O,F)=>{let z=y({accept:"application/json, text/plain"},w.authHeaders),I=w.authMethod&&w.authMethod.toLowerCase()==="post",j,A=w.authUrl.indexOf("?");if(A>-1){if(j=iq(w.authUrl.slice(A)),w.authUrl=w.authUrl.slice(0,A),!I)w.authParams=y(j,w.authParams)}let M=y({},w.authParams||{},O),E=(T)=>{var d,t;let a=(d=T.body)!=null?d:null,D0=null;if(T.error)Q.logAction(this.logger,Q.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received Error: "+W0(T.error));else{let B0=(t=T.headers["content-type"])!=null?t:null;if(Array.isArray(B0))D0=B0.join(", ");else D0=B0;Q.logAction(this.logger,Q.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Received; content-type: "+D0+"; body: "+I$(a))}if(T.error){F(T.error,null);return}if(T.unpacked){F(null,a);return}if(B.BufferUtils.isBuffer(a))a=a.toString();if(!D0){F(new D("authUrl response is missing a content-type header",40170,401),null);return}let n=D0.indexOf("application/json")>-1,S0=D0.indexOf("text/plain")>-1||D0.indexOf("application/jwt")>-1;if(!n&&!S0){F(new D("authUrl responded with unacceptable content-type "+D0+", should be either text/plain, application/jwt or application/json",40170,401),null);return}if(n){if(a.length>y8){F(new D("authUrl response exceeded max permitted length",40170,401),null);return}try{a=JSON.parse(a)}catch(B0){F(new D("Unexpected error processing authURL response; err = "+B0.message,40170,401),null);return}}F(null,a,D0)};if(Q.logAction(this.logger,Q.LOG_MICRO,"Auth.requestToken().tokenRequestCallback","Requesting token from "+w.authUrl+"; Params: "+JSON.stringify(M)+"; method: "+(I?"POST":"GET")),I){let T=z||{};T["content-type"]="application/x-www-form-urlencoded";let d=a1(M).slice(1);j0(this.client.http.doUri(U0.Post,w.authUrl,T,d,j),(t,a)=>t?E(t):E(a))}else j0(this.client.http.doUri(U0.Get,w.authUrl,z||{},null,M),(T,d)=>T?E(T):E(d))};else if(w.key)Q.logAction(this.logger,Q.LOG_MINOR,"Auth.requestToken()","using token auth with client-side signing"),G=(O,F)=>{j0(this.createTokenRequest(O,w),(z,I)=>F(z,I!=null?I:null))};else throw Q.logAction(this.logger,Q.LOG_ERROR,"Auth()","library initialized with a token literal without any way to renew the token when it expires (no authUrl, authCallback, or key). See https://help.ably.io/error/40171 for help"),new D("Need a new token, but authOptions does not include any way to request one (no authUrl, authCallback, or key)",40171,403);if("capability"in Z)Z.capability=t$(Z.capability);let U=(O,F)=>{let z=O.keyName,I="/keys/"+z+"/requestToken",j=function(M){return X.baseUri(M)+I},A=k.defaultPostHeaders(this.client.options,{format:"json"});if(w.requestHeaders)y(A,w.requestHeaders);Q.logAction(this.logger,Q.LOG_MICRO,"Auth.requestToken().requestToken","Sending POST to "+I+"; Token params: "+JSON.stringify(O)),j0(this.client.http.do(U0.Post,j,A,JSON.stringify(O),null),(M,E)=>M?F(M):F(E.error,E.body,E.unpacked))};return new Promise((O,F)=>{let z=!1,I=this.client.options.timeouts.realtimeRequestTimeout,j=setTimeout(()=>{z=!0;let A="Token request callback timed out after "+I/1000+" seconds";Q.logAction(this.logger,Q.LOG_ERROR,"Auth.requestToken()",A),F(new D(A,40170,401))},I);G(Z,(A,M,E)=>{if(z)return;if(clearTimeout(j),A){Q.logAction(this.logger,Q.LOG_ERROR,"Auth.requestToken()","token request signing call returned error; err = "+W0(A)),F(d$(A));return}if(typeof M==="string"){if(M.length===0)F(new D("Token string is empty",40170,401));else if(M.length>y8)F(new D("Token string exceeded max permitted length (was "+M.length+" bytes)",40170,401));else if(M==="undefined"||M==="null")F(new D("Token string was literal null/undefined",40170,401));else if(M[0]==="{"&&!(E&&E.indexOf("application/jwt")>-1))F(new D("Token was double-encoded; make sure you're not JSON-encoding an already encoded token request or details",40170,401));else O({token:M});return}if(typeof M!=="object"||M===null){let d="Expected token request callback to call back with a token string or token request/details object, but got a "+typeof M;Q.logAction(this.logger,Q.LOG_ERROR,"Auth.requestToken()",d),F(new D(d,40170,401));return}let T=JSON.stringify(M).length;if(T>y8&&!w.suppressMaxLengthCheck){F(new D("Token request/details object exceeded max permitted stringified size (was "+T+" bytes)",40170,401));return}if("issued"in M){O(M);return}if(!("keyName"in M)){Q.logAction(this.logger,Q.LOG_ERROR,"Auth.requestToken()","Expected token request callback to call back with a token string, token request object, or token details object"),F(new D("Expected token request callback to call back with a token string, token request object, or token details object",40170,401));return}U(M,(d,t,a)=>{if(d){Q.logAction(this.logger,Q.LOG_ERROR,"Auth.requestToken()","token request API call returned error; err = "+W0(d)),F(d$(d));return}if(!a)t=JSON.parse(t);Q.logAction(this.logger,Q.LOG_MINOR,"Auth.getToken()","token received"),O(t)})})})}async createTokenRequest(q,$){$=$||this.authOptions,q=q||Y1(this.tokenParams);let w=$.key;if(!w)throw new D("No key specified",40101,403);let Z=w.split(":"),G=Z[0],X=Z[1];if(!X)throw new D("Invalid key specified",40101,403);if(q.clientId==="")throw new D("clientId can’t be an empty string",40012,400);if("capability"in q)q.capability=t$(q.capability);let U=y({keyName:G},q),O=q.clientId||"",F=q.ttl||"",z=q.capability||"";if(!U.timestamp)U.timestamp=await this._getTimestamp($&&$.queryTime);let I=U.nonce||(U.nonce=gu()),j=U.timestamp,A=U.keyName+`
`+F+`
`+z+`
`+O+`
`+j+`
`+I+`
`;return U.mac=U.mac||vu(A,X),Q.logAction(this.logger,Q.LOG_MINOR,"Auth.getTokenRequest()","generated signed request"),U}async getAuthParams(){if(this.method=="basic")return{key:this.key};else{let q=await this._ensureValidAuthCredentials(!1);if(!q)throw Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");return{access_token:q.token}}}async getAuthHeaders(){if(this.method=="basic")return{authorization:"Basic "+this.basicKey};else{let q=await this._ensureValidAuthCredentials(!1);if(!q)throw Error("Auth.getAuthParams(): _ensureValidAuthCredentials returned no error or tokenDetails");return{authorization:"Bearer "+pq(q.token)}}}_saveBasicOptions(q){if(this.method="basic",this.key=q.key,this.basicKey=pq(q.key),this.authOptions=q||{},"clientId"in q)this._userSetClientId(q.clientId)}_saveTokenOptions(q,$){if(this.method="token",q)this.tokenParams=q;if($){if($.token)$.tokenDetails=typeof $.token==="string"?{token:$.token}:$.token;if($.tokenDetails)this.tokenDetails=$.tokenDetails;if("clientId"in $)this._userSetClientId($.clientId);this.authOptions=$}}async _ensureValidAuthCredentials(q){let $=this.tokenDetails;if($){if(this._tokenClientIdMismatch($.clientId))throw new D("Mismatch between clientId in token ("+$.clientId+") and current clientId ("+this.clientId+")",40102,403);if(!this.client.isTimeOffsetSet()||!$.expires||$.expires>=this.client.getTimestampUsingOffset())return Q.logAction(this.logger,Q.LOG_MINOR,"Auth.getToken()","using cached token; expires = "+$.expires),$;Q.logAction(this.logger,Q.LOG_MINOR,"Auth.getToken()","deleting expired token"),this.tokenDetails=null}let w=(this.waitingForTokenRequest||(this.waitingForTokenRequest=k8.create(this.logger))).createPromise();if(this.currentTokenRequestId!==null&&!q)return w;let Z=this.currentTokenRequestId=fu(),G,X=null;try{G=await this.requestToken(this.tokenParams,this.authOptions)}catch(O){X=O}if(this.currentTokenRequestId>Z)return Q.logAction(this.logger,Q.LOG_MINOR,"Auth._ensureValidAuthCredentials()","Discarding token request response; overtaken by newer one"),w;this.currentTokenRequestId=null;let U=this.waitingForTokenRequest;if(this.waitingForTokenRequest=null,X)return U==null||U.rejectAll(X),w;return U==null||U.resolveAll(this.tokenDetails=G),w}_userSetClientId(q){if(!(typeof q==="string"||q===null))throw new D("clientId must be either a string or null",40012,400);else if(q==="*")throw new D('Can’t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, instantiate the library with {defaultTokenParams: {clientId: "*"}}), or if calling authorize(), pass it in as a tokenParam: authorize({clientId: "*"}, authOptions)',40012,400);else{let $=this._uncheckedSetClientId(q);if($)throw $}}_uncheckedSetClientId(q){if(this._tokenClientIdMismatch(q)){let $="Unexpected clientId mismatch: client has "+this.clientId+", requested "+q,w=new D($,40102,401);return Q.logAction(this.logger,Q.LOG_ERROR,"Auth._uncheckedSetClientId()",$),w}else return this.clientId=this.tokenParams.clientId=q,null}_tokenClientIdMismatch(q){return!!(this.clientId&&this.clientId!=="*"&&q&&q!=="*"&&this.clientId!==q)}static isTokenErr(q){return q.code&&q.code>=40140&&q.code<40150}revokeTokens(q,$){return this.client.rest.revokeTokens(q,$)}async _getTimestamp(q){return this.client.getTimestamp(q||!!this.authOptions.queryTime)}},t0=mu;function n8(q){let $=[];if(q)for(let w in q)$.push(w+"="+q[w]);return $.join("&")}function j1(q,$){return q+($?"?":"")+n8($)}function ou(q,$,w,Z,G){if(q.error)Q.logActionNoStrip(G,Q.LOG_MICRO,"Http."+$+"()","Received Error; "+j1(w,Z)+"; Error: "+W0(q.error));else Q.logActionNoStrip(G,Q.LOG_MICRO,"Http."+$+"()","Received; "+j1(w,Z)+"; Headers: "+n8(q.headers)+"; StatusCode: "+q.statusCode+"; Body"+(B.BufferUtils.isBuffer(q.body)?" (Base64): "+B.BufferUtils.base64Encode(q.body):": "+q.body))}function lu(q,$,w,Z,G){if(G.shouldLog(Q.LOG_MICRO))Q.logActionNoStrip(G,Q.LOG_MICRO,"Http."+q+"()","Sending; "+j1($,Z)+"; Body"+(B.BufferUtils.isBuffer(w)?" (Base64): "+B.BufferUtils.base64Encode(w):": "+w))}var i8=class{constructor(q){this.client=q,this.platformHttp=new B.Http(q),this.checkConnectivity=this.platformHttp.checkConnectivity?()=>this.platformHttp.checkConnectivity():void 0}get logger(){var q,$;return($=(q=this.client)==null?void 0:q.logger)!=null?$:Q.defaultLogger}get supportsAuthHeaders(){return this.platformHttp.supportsAuthHeaders}get supportsLinkHeaders(){return this.platformHttp.supportsLinkHeaders}_getHosts(q){let $=q.connection,w=$&&$.connectionManager.host;if(w)return[w].concat(k.getFallbackHosts(q.options));return k.getHosts(q.options)}async do(q,$,w,Z,G){try{let X=this.client;if(!X)return{error:new D("http.do called without client",50000,500)};let U=typeof $==="function"?$:function(j){return X.baseUri(j)+$},O=X._currentFallback;if(O)if(O.validUntil>Date.now()){let j=await this.doUri(q,U(O.host),w,Z,G);if(j.error&&this.platformHttp.shouldFallback(j.error))return X._currentFallback=null,this.do(q,$,w,Z,G);return j}else X._currentFallback=null;let F=this._getHosts(X);if(F.length===1)return this.doUri(q,U(F[0]),w,Z,G);let z=null,I=async(j,A)=>{let M=j.shift();z=z!=null?z:new Date;let E=await this.doUri(q,U(M),w,Z,G);if(E.error&&this.platformHttp.shouldFallback(E.error)&&j.length){if(Date.now()-z.getTime()>X.options.timeouts.httpMaxRetryDuration)return{error:new D(`Timeout for trying fallback hosts retries. Total elapsed time exceeded the ${X.options.timeouts.httpMaxRetryDuration}ms limit`,50003,500)};return I(j,!0)}if(A)X._currentFallback={host:M,validUntil:Date.now()+X.options.timeouts.fallbackRetryTimeout};return E};return I(F)}catch(X){return{error:new D(`Unexpected error in Http.do: ${W0(X)}`,500,50000)}}}async doUri(q,$,w,Z,G){try{lu(q,$,Z,G,this.logger);let X=await this.platformHttp.doUri(q,$,w,Z,G);if(this.logger.shouldLog(Q.LOG_MICRO))ou(X,q,$,G,this.logger);return X}catch(X){return{error:new D(`Unexpected error in Http.doUri: ${W0(X)}`,500,50000)}}}};function ru(q,$,w,Z){try{w.apply($,Z)}catch(G){Q.logAction(q,Q.LOG_ERROR,"EventEmitter.emit()","Unexpected listener exception: "+G+"; stack = "+(G&&G.stack))}}function g8(q,$,w){let Z,G,X;for(let U=0;U<q.length;U++){if(Z=q[U],w)Z=Z[w];if(Array.isArray(Z)){while((G=Z.indexOf($))!==-1)Z.splice(G,1);if(w&&Z.length===0)delete q[U][w]}else if(I1(Z)){for(X in Z)if(Object.prototype.hasOwnProperty.call(Z,X)&&Array.isArray(Z[X]))g8([Z],$,X)}}}var au=class{constructor(q){this.logger=q,this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null)}on(...q){if(q.length===1){let $=q[0];if(typeof $==="function")this.any.push($);else throw Error("EventListener.on(): Invalid arguments: "+B.Config.inspect(q))}if(q.length===2){let[$,w]=q;if(typeof w!=="function")throw Error("EventListener.on(): Invalid arguments: "+B.Config.inspect(q));if(E0($))this.any.push(w);else if(Array.isArray($))$.forEach((Z)=>{this.on(Z,w)});else{if(typeof $!=="string")throw Error("EventListener.on(): Invalid arguments: "+B.Config.inspect(q));(this.events[$]||(this.events[$]=[])).push(w)}}}off(...q){if(q.length==0||E0(q[0])&&E0(q[1])){this.any=[],this.events=Object.create(null),this.anyOnce=[],this.eventsOnce=Object.create(null);return}let[$,w]=q,Z=null,G=null;if(q.length===1||!w)if(typeof $==="function")Z=$;else G=$;else{if(typeof w!=="function")throw Error("EventEmitter.off(): invalid arguments:"+B.Config.inspect(q));[G,Z]=[$,w]}if(Z&&E0(G)){g8([this.any,this.events,this.anyOnce,this.eventsOnce],Z);return}if(Array.isArray(G)){G.forEach((X)=>{this.off(X,Z)});return}if(typeof G!=="string")throw Error("EventEmitter.off(): invalid arguments:"+B.Config.inspect(q));if(Z)g8([this.events,this.eventsOnce],Z,G);else delete this.events[G],delete this.eventsOnce[G]}listeners(q){if(q){let $=this.events[q]||[];if(this.eventsOnce[q])Array.prototype.push.apply($,this.eventsOnce[q]);return $.length?$:null}return this.any.length?this.any:null}emit(q,...$){let w={event:q},Z=[];if(this.anyOnce.length)Array.prototype.push.apply(Z,this.anyOnce),this.anyOnce=[];if(this.any.length)Array.prototype.push.apply(Z,this.any);let G=this.eventsOnce[q];if(G)Array.prototype.push.apply(Z,G),delete this.eventsOnce[q];let X=this.events[q];if(X)Array.prototype.push.apply(Z,X);Z.forEach((U)=>{ru(this.logger,w,U,$)})}once(...q){let $=q.length;if($===0||$===1&&typeof q[0]!=="function"){let G=q[0];return new Promise((X)=>{this.once(G,X)})}let[w,Z]=q;if(q.length===1&&typeof w==="function")this.anyOnce.push(w);else if(E0(w)){if(typeof Z!=="function")throw Error("EventEmitter.once(): Invalid arguments:"+B.Config.inspect(q));this.anyOnce.push(Z)}else if(Array.isArray(w)){let G=this,X=function(){let U=Array.prototype.slice.call(arguments);if(w.forEach(function(O){G.off(O,X)}),typeof Z!=="function")throw Error("EventEmitter.once(): Invalid arguments:"+B.Config.inspect(q));Z.apply(this,U)};w.forEach(function(U){G.on(U,X)})}else{if(typeof w!=="string")throw Error("EventEmitter.once(): Invalid arguments:"+B.Config.inspect(q));let G=this.eventsOnce[w]||(this.eventsOnce[w]=[]);if(Z){if(typeof Z!=="function")throw Error("EventEmitter.once(): Invalid arguments:"+B.Config.inspect(q));G.push(Z)}}}async whenState(q,$){if(typeof q!=="string"||typeof $!=="string")throw Error("whenState requires a valid state String argument");if(q===$)return null;else return this.once(q)}},V0=au,C={HEARTBEAT:0,ACK:1,NACK:2,CONNECT:3,CONNECTED:4,DISCONNECT:5,DISCONNECTED:6,CLOSE:7,CLOSED:8,ERROR:9,ATTACH:10,ATTACHED:11,DETACH:12,DETACHED:13,PRESENCE:14,MESSAGE:15,SYNC:16,AUTH:17,ACTIVATE:18,OBJECT:19,OBJECT_SYNC:20,ANNOTATION:21},o$=[];Object.keys(C).forEach(function(q){o$[C[q]]=q});var A0={HAS_PRESENCE:1,HAS_BACKLOG:2,RESUMED:4,TRANSIENT:16,ATTACH_RESUME:32,HAS_OBJECTS:128,PRESENCE:65536,PUBLISH:131072,SUBSCRIBE:262144,PRESENCE_SUBSCRIBE:524288,ANNOTATION_PUBLISH:2097152,ANNOTATION_SUBSCRIBE:4194304,OBJECT_SUBSCRIBE:16777216,OBJECT_PUBLISH:33554432},su=Object.keys(A0);A0.MODE_ALL=A0.PRESENCE|A0.PUBLISH|A0.SUBSCRIBE|A0.PRESENCE_SUBSCRIBE|A0.ANNOTATION_PUBLISH|A0.ANNOTATION_SUBSCRIBE|A0.OBJECT_SUBSCRIBE|A0.OBJECT_PUBLISH;var l$=["PRESENCE","PUBLISH","SUBSCRIBE","PRESENCE_SUBSCRIBE","ANNOTATION_PUBLISH","ANNOTATION_SUBSCRIBE","OBJECT_SUBSCRIBE","OBJECT_PUBLISH"];function eu(q){if(!q||!q.channelOptions)return{channelOptions:q,plugins:{},baseEncodedPreviousPayload:void 0};return q}function r$(q,$,w){if(w&&w.cipher){if(!q)h0("Crypto");let Z=q.getCipher(w.cipher,$);return{cipher:Z.cipherParams,channelCipher:Z.cipher}}return w!=null?w:{}}async function q4(q,$){let{data:w,encoding:Z}=await a$(q.data,q.encoding,$);return q.data=w,q.encoding=Z,q}async function a$(q,$,w){let Z=w.channelCipher,G=q,X=$?$+"/":"";if(!B.BufferUtils.isBuffer(G))G=B.BufferUtils.utf8Encode(String(G)),X=X+"utf-8/";let U=await Z.encrypt(G);return X=X+"cipher+"+Z.algorithm,{data:U,encoding:X}}async function p8(q,$){let{data:w,encoding:Z}=s$(q.data,q.encoding);if(q.data=w,q.encoding=Z,$!=null&&$.cipher)return q4(q,$);else return q}function s$(q,$){if(typeof q=="string"||B.BufferUtils.isBuffer(q)||q===null||q===void 0)return{data:q,encoding:$};if(I1(q)||Array.isArray(q))return{data:JSON.stringify(q),encoding:$?$+"/json":"json"};throw new D("Data type is unsupported",40013,400)}async function v8(q,$){let{data:w,encoding:Z,error:G}=await e$(q.data,q.encoding,$);if(q.data=w,q.encoding=Z,G)throw G}async function e$(q,$,w){let Z=eu(w),G=q,X=q,U=$,O;if($){let F=$.split("/"),z,I=F.length,j="";try{while((z=I)>0){let A=F[--I].match(/([-\w]+)(\+([\w-]+))?/);if(!A)break;switch(j=A[1],j){case"base64":if(X=B.BufferUtils.base64Decode(String(X)),z==F.length)G=X;continue;case"utf-8":X=B.BufferUtils.utf8Decode(X);continue;case"json":X=JSON.parse(X);continue;case"cipher":if(Z.channelOptions!=null&&Z.channelOptions.cipher&&Z.channelOptions.channelCipher){let M=A[3],E=Z.channelOptions.channelCipher;if(M!=E.algorithm)throw Error("Unable to decrypt message with given cipher; incompatible cipher params");X=await E.decrypt(X);continue}else throw Error("Unable to decrypt message; not an encrypted channel");case"vcdiff":if(!Z.plugins||!Z.plugins.vcdiff)throw new D("Missing Vcdiff decoder (https://github.com/ably-forks/vcdiff-decoder)",40019,400);if(typeof Uint8Array>"u")throw new D("Delta decoding not supported on this browser (need ArrayBuffer & Uint8Array)",40020,400);try{let M=Z.baseEncodedPreviousPayload;if(typeof M==="string")M=B.BufferUtils.utf8Encode(M);let E=B.BufferUtils.toBuffer(M);X=B.BufferUtils.toBuffer(X),X=B.BufferUtils.arrayBufferViewToBuffer(Z.plugins.vcdiff.decode(X,E)),G=X}catch(M){throw new D("Vcdiff delta decode failed with "+M,40018,400)}continue;default:throw Error("Unknown encoding")}}}catch(A){let M=A;O=new D(`Error processing the ${j} encoding, decoder returned ‘${M.message}’`,M.code||40013,400)}finally{U=z<=0?null:F.slice(0,z).join("/")}}if(O)return{error:O,data:X,encoding:U};return Z.baseEncodedPreviousPayload=G,{data:X,encoding:U}}function x8(...q){let $=q.length>0?"json":"msgpack",{data:w,encoding:Z}=q7(this.data,this.encoding,$);return Object.assign({},this,{encoding:Z,data:w})}function q7(q,$,w){if(!q||!B.BufferUtils.isBuffer(q))return{data:q,encoding:$};if(w==="msgpack")return{data:B.BufferUtils.toBuffer(q),encoding:$};return{data:B.BufferUtils.base64Encode(q),encoding:$?$+"/base64":"base64"}}var tq={encryptData:a$,encodeData:s$,encodeDataForWire:q7,decodeData:e$};function fq(q){let{id:$,connectionId:w,timestamp:Z}=q,G;switch(q.action){case C.MESSAGE:{G=q.messages;break}case C.PRESENCE:case C.SYNC:G=q.presence;break;case C.ANNOTATION:G=q.annotations;break;case C.OBJECT:case C.OBJECT_SYNC:G=q.state;break;default:throw new D("Unexpected action "+q.action,40000,400)}for(let X=0;X<G.length;X++){let U=G[X];if(!U.connectionId)U.connectionId=w;if(!U.timestamp)U.timestamp=Z;if($&&!U.id)U.id=$+":"+X}}function A1(q,$){let w="["+$;for(let Z in q)if(Z==="data"){if(typeof q.data=="string")w+="; data="+q.data;else if(B.BufferUtils.isBuffer(q.data))w+="; data (buffer)="+B.BufferUtils.base64Encode(q.data);else if(typeof q.data<"u")w+="; data (json)="+JSON.stringify(q.data)}else if(Z&&(Z==="extras"||Z==="operation"))w+="; "+Z+"="+JSON.stringify(q[Z]);else if(Z==="version")w+="; version="+JSON.stringify(q[Z]);else if(Z==="annotations")w+="; annotations="+JSON.stringify(q[Z]);else if(q[Z]!==void 0)w+="; "+Z+"="+q[Z];return w+="]",w}var M1=class{},$7=class{constructor(q){this.Platform=B,this.ErrorInfo=D,this.Logger=Q,this.Defaults=k,this.Utils=z0,this.EventEmitter=V0,this.MessageEncoding=tq;var $,w,Z,G,X,U,O,F,z,I;this._additionalHTTPRequestImplementations=($=q.plugins)!=null?$:null,this.logger=new Q,this.logger.setLog(q.logLevel,q.logHandler),Q.logAction(this.logger,Q.LOG_MICRO,"BaseClient()","initialized with clientOptions "+B.Config.inspect(q)),this._MsgPack=(Z=(w=q.plugins)==null?void 0:w.MsgPack)!=null?Z:null;let j=this.options=k.normaliseOptions(q,this._MsgPack,this.logger);if(j.key){let A=j.key.match(/^([^:\s]+):([^:.\s]+)$/);if(!A)throw Q.logAction(this.logger,Q.LOG_ERROR,"BaseClient()","invalid key parameter"),new D("invalid key parameter",40400,404);j.keyName=A[1],j.keySecret=A[2]}if("clientId"in j){if(!(typeof j.clientId==="string"||j.clientId===null))throw new D("clientId must be either a string or null",40012,400);else if(j.clientId==="*")throw new D('Can’t use "*" as a clientId as that string is reserved. (To change the default token request behaviour to use a wildcard clientId, use {defaultTokenParams: {clientId: "*"}})',40012,400)}Q.logAction(this.logger,Q.LOG_MINOR,"BaseClient()","started; version = "+k.version),this._currentFallback=null,this.serverTimeOffset=null,this.http=new i8(this),this.auth=new t0(this,j),this._rest=((G=q.plugins)==null?void 0:G.Rest)?new q.plugins.Rest(this):null,this._Crypto=(U=(X=q.plugins)==null?void 0:X.Crypto)!=null?U:null,this.__FilteredSubscriptions=(F=(O=q.plugins)==null?void 0:O.MessageInteractions)!=null?F:null,this._Annotations=(I=(z=q.plugins)==null?void 0:z.Annotations)!=null?I:null}get rest(){if(!this._rest)h0("Rest");return this._rest}get _FilteredSubscriptions(){if(!this.__FilteredSubscriptions)h0("MessageInteractions");return this.__FilteredSubscriptions}get channels(){return this.rest.channels}get push(){return this.rest.push}device(){var q;if(!((q=this.options.plugins)==null?void 0:q.Push)||!this.push.LocalDevice)h0("Push");if(!this._device)this._device=this.push.LocalDevice.load(this);return this._device}baseUri(q){return k.getHttpScheme(this.options)+q+":"+k.getPort(this.options,!1)}async stats(q){return this.rest.stats(q)}async time(q){return this.rest.time(q)}async request(q,$,w,Z,G,X){return this.rest.request(q,$,w,Z,G,X)}batchPublish(q){return this.rest.batchPublish(q)}batchPresence(q){return this.rest.batchPresence(q)}setLog(q){this.logger.setLog(q.level,q.handler)}async getTimestamp(q){if(!this.isTimeOffsetSet()&&q)return this.time();return this.getTimestampUsingOffset()}getTimestampUsingOffset(){return Date.now()+(this.serverTimeOffset||0)}isTimeOffsetSet(){return this.serverTimeOffset!==null}};$7.Platform=B;var w7=$7,$4=class q{toJSON(){var $,w,Z;return{id:this.id,deviceSecret:this.deviceSecret,platform:this.platform,formFactor:this.formFactor,clientId:this.clientId,metadata:this.metadata,deviceIdentityToken:this.deviceIdentityToken,push:{recipient:($=this.push)==null?void 0:$.recipient,state:(w=this.push)==null?void 0:w.state,error:(Z=this.push)==null?void 0:Z.error}}}toString(){var $,w,Z,G;let X="[DeviceDetails";if(this.id)X+="; id="+this.id;if(this.platform)X+="; platform="+this.platform;if(this.formFactor)X+="; formFactor="+this.formFactor;if(this.clientId)X+="; clientId="+this.clientId;if(this.metadata)X+="; metadata="+this.metadata;if(this.deviceIdentityToken)X+="; deviceIdentityToken="+JSON.stringify(this.deviceIdentityToken);if(($=this.push)==null?void 0:$.recipient)X+="; push.recipient="+JSON.stringify(this.push.recipient);if((w=this.push)==null?void 0:w.state)X+="; push.state="+this.push.state;if((Z=this.push)==null?void 0:Z.error)X+="; push.error="+JSON.stringify(this.push.error);if((G=this.push)==null?void 0:G.metadata)X+="; push.metadata="+this.push.metadata;return X+="]",X}static toRequestBody($,w,Z){return P0($,w,Z)}static fromResponseBody($,w,Z){if(Z)$=F0($,w,Z);if(Array.isArray($))return q.fromValuesArray($);else return q.fromValues($)}static fromValues($){return $.error=$.error&&D.fromValues($.error),Object.assign(new q,$)}static fromLocalDevice($){return Object.assign(new q,$)}static fromValuesArray($){let w=$.length,Z=Array(w);for(let G=0;G<w;G++)Z[G]=q.fromValues($[G]);return Z}},L1=$4;async function u7(q,$,w,Z){if(q.http.supportsAuthHeaders){let G=await q.auth.getAuthHeaders();return Z(y(G,$),w)}else{let G=await q.auth.getAuthParams();return Z($,y(G,w))}}function w4(q,$,w){if(q.err&&!q.body)return{err:q.err};if(q.statusCode===dq.NoContent)return c(_({},q),{body:[],unpacked:!0});let Z=q.body;if(!q.unpacked)try{Z=F0(Z,$,w)}catch(O){if(T8(O))return{err:O};else return{err:new r(W0(O),null)}}if(!Z)return{err:new r("unenvelope(): Response body is missing",null)};let{statusCode:G,response:X,headers:U}=Z;if(G===void 0)return c(_({},q),{body:Z,unpacked:!0});if(G<200||G>=300){let O=X&&X.error||q.err;if(!O)O=Error("Error in unenveloping "+Z),O.statusCode=G;return{err:O,body:X,headers:U,unpacked:!0,statusCode:G}}return{err:q.err,body:X,headers:U,unpacked:!0,statusCode:G}}function u4(q,$,w,Z,G){if(q.err)Q.logAction(G,Q.LOG_MICRO,"Resource."+$+"()","Received Error; "+j1(w,Z)+"; Error: "+W0(q.err));else Q.logAction(G,Q.LOG_MICRO,"Resource."+$+"()","Received; "+j1(w,Z)+"; Headers: "+n8(q.headers)+"; StatusCode: "+q.statusCode+"; Body: "+(B.BufferUtils.isBuffer(q.body)?" (Base64): "+B.BufferUtils.base64Encode(q.body):": "+B.Config.inspect(q.body)))}var W4=class q{static async get($,w,Z,G,X,U){return q.do(U0.Get,$,w,null,Z,G,X,U!=null?U:!1)}static async delete($,w,Z,G,X,U){return q.do(U0.Delete,$,w,null,Z,G,X,U)}static async post($,w,Z,G,X,U,O){return q.do(U0.Post,$,w,Z,G,X,U,O)}static async patch($,w,Z,G,X,U,O){return q.do(U0.Patch,$,w,Z,G,X,U,O)}static async put($,w,Z,G,X,U,O){return q.do(U0.Put,$,w,Z,G,X,U,O)}static async do($,w,Z,G,X,U,O,F){if(O)(U=U||{}).envelope=O;let z=w.logger;async function I(A,M){var E;if(z.shouldLog(Q.LOG_MICRO)){let d=G;if(((E=A["content-type"])==null?void 0:E.indexOf("msgpack"))>0)try{if(!w._MsgPack)h0("MsgPack");d=w._MsgPack.decode(G)}catch(t){Q.logAction(z,Q.LOG_MICRO,"Resource."+$+"()","Sending MsgPack Decoding Error: "+W0(t))}Q.logAction(z,Q.LOG_MICRO,"Resource."+$+"()","Sending; "+j1(Z,M)+"; Body: "+d)}let T=await w.http.do($,Z,A,G,M);if(T.error&&t0.isTokenErr(T.error))return await w.auth.authorize(null,null),u7(w,A,M,I);return{err:T.error,body:T.body,headers:T.headers,unpacked:T.unpacked,statusCode:T.statusCode}}let j=await u7(w,X,U,I);if(O)j=w4(j,w._MsgPack,O);if(z.shouldLog(Q.LOG_MICRO))u4(j,$,Z,U,z);if(F)if(j.err)throw j.err;else{let A=_({},j);return delete A.err,A}return j}},X0=W4;function Z4(q){let $=q.match(/^\.\/(\w+)\?(.*)$/);return $&&$[2]&&iq($[2])}function G4(q){if(typeof q=="string")q=q.split(",");let $={};for(let w=0;w<q.length;w++){let Z=q[w].match(/^\s*<(.+)>;\s*rel="(\w+)"$/);if(Z){let G=Z4(Z[1]);if(G)$[Z[2]]=G}}return $}function J4(q,$,w){return!(w&&($||typeof q.code==="number"))}var N4=class{constructor(q,$,w,Z,G,X){this.client=q,this.path=$,this.headers=w,this.envelope=Z!=null?Z:null,this.bodyHandler=G,this.useHttpPaginatedResponse=X||!1}get logger(){return this.client.logger}async get(q){let $=await X0.get(this.client,this.path,this.headers,q,this.envelope,!1);return this.handlePage($)}async delete(q){let $=await X0.delete(this.client,this.path,this.headers,q,this.envelope,!1);return this.handlePage($)}async post(q,$){let w=await X0.post(this.client,this.path,$,this.headers,q,this.envelope,!1);return this.handlePage(w)}async put(q,$){let w=await X0.put(this.client,this.path,$,this.headers,q,this.envelope,!1);return this.handlePage(w)}async patch(q,$){let w=await X0.patch(this.client,this.path,$,this.headers,q,this.envelope,!1);return this.handlePage(w)}async handlePage(q){if(q.err&&J4(q.err,q.body,this.useHttpPaginatedResponse))throw Q.logAction(this.logger,Q.LOG_ERROR,"PaginatedResource.handlePage()","Unexpected error getting resource: err = "+W0(q.err)),q.err;let $,w,Z;try{$=q.statusCode==dq.NoContent?[]:await this.bodyHandler(q.body,q.headers||{},q.unpacked)}catch(G){throw q.err||G}if(q.headers&&(w=q.headers.Link||q.headers.link))Z=G4(w);if(this.useHttpPaginatedResponse)return new X4(this,$,q.headers||{},q.statusCode,Z,q.err);else return new W7(this,$,Z)}},W7=class{constructor(q,$,w){this.resource=q,this.items=$,this._relParams=w}async first(){if(this.hasFirst())return this.get(this._relParams.first);throw new D("No link to the first page of results",40400,404)}async current(){if(this.hasCurrent())return this.get(this._relParams.current);throw new D("No link to the current page of results",40400,404)}async next(){if(this.hasNext())return this.get(this._relParams.next);return null}hasFirst(){return this._relParams!=null&&"first"in this._relParams}hasCurrent(){return this._relParams!=null&&"current"in this._relParams}hasNext(){return this._relParams!=null&&"next"in this._relParams}isLast(){return!this.hasNext()}async get(q){let $=this.resource,w=await X0.get($.client,$.path,$.headers,q,$.envelope,!1);return $.handlePage(w)}},X4=class extends W7{constructor(q,$,w,Z,G,X){super(q,$,G);this.statusCode=Z,this.success=Z<300&&Z>=200,this.headers=w,this.errorCode=X&&X.code,this.errorMessage=X&&X.message}toJSON(){return{items:this.items,statusCode:this.statusCode,success:this.success,headers:this.headers,errorCode:this.errorCode,errorMessage:this.errorMessage}}},k0=N4,Z7=class q{toJSON(){return{channel:this.channel,deviceId:this.deviceId,clientId:this.clientId}}toString(){let $="[PushChannelSubscription";if(this.channel)$+="; channel="+this.channel;if(this.deviceId)$+="; deviceId="+this.deviceId;if(this.clientId)$+="; clientId="+this.clientId;return $+="]",$}static fromResponseBody($,w,Z){if(Z)$=F0($,w,Z);if(Array.isArray($))return q.fromValuesArray($);else return q.fromValues($)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){let w=$.length,Z=Array(w);for(let G=0;G<w;G++)Z[G]=q.fromValues($[G]);return Z}};Z7.toRequestBody=P0;var Q4=Z7,mq=Q4,H4=class{constructor(q){var $;if(this.client=q,this.admin=new U4(q),B.Config.push&&(($=q.options.plugins)==null?void 0:$.Push))this.stateMachine=new q.options.plugins.Push.ActivationStateMachine(q),this.LocalDevice=q.options.plugins.Push.localDeviceFactory(L1)}async activate(q,$){await new Promise((w,Z)=>{var G;if(!((G=this.client.options.plugins)==null?void 0:G.Push)){Z(vq("Push"));return}if(!this.stateMachine){Z(new D("This platform is not supported as a target of push notifications",40000,400));return}if(this.stateMachine.activatedCallback){Z(new D("Activation already in progress",40000,400));return}this.stateMachine.activatedCallback=(X)=>{if(X){Z(X);return}w()},this.stateMachine.updateFailedCallback=$,this.stateMachine.handleEvent(new this.client.options.plugins.Push.CalledActivate(this.stateMachine,q))})}async deactivate(q){await new Promise(($,w)=>{var Z;if(!((Z=this.client.options.plugins)==null?void 0:Z.Push)){w(vq("Push"));return}if(!this.stateMachine){w(new D("This platform is not supported as a target of push notifications",40000,400));return}if(this.stateMachine.deactivatedCallback){w(new D("Deactivation already in progress",40000,400));return}this.stateMachine.deactivatedCallback=(G)=>{if(G){w(G);return}$()},this.stateMachine.handleEvent(new this.client.options.plugins.Push.CalledDeactivate(this.stateMachine,q))})}},U4=class{constructor(q){this.client=q,this.deviceRegistrations=new K4(q),this.channelSubscriptions=new O4(q)}async publish(q,$){let w=this.client,Z=w.options.useBinaryProtocol?"msgpack":"json",G=k.defaultPostHeaders(w.options),X={},U=y({recipient:q},$);if(y(G,w.options.headers),w.options.pushFullWait)y(X,{fullWait:"true"});let O=P0(U,w._MsgPack,Z);await X0.post(w,"/push/publish",O,G,X,null,!0)}},K4=class{constructor(q){this.client=q}async save(q){let $=this.client,w=L1.fromValues(q),Z=$.options.useBinaryProtocol?"msgpack":"json",G=k.defaultPostHeaders($.options),X={};if(y(G,$.options.headers),$.options.pushFullWait)y(X,{fullWait:"true"});let U=P0(w,$._MsgPack,Z),O=await X0.put($,"/push/deviceRegistrations/"+encodeURIComponent(q.id),U,G,X,null,!0);return L1.fromResponseBody(O.body,$._MsgPack,O.unpacked?void 0:Z)}async get(q){let $=this.client,w=$.options.useBinaryProtocol?"msgpack":"json",Z=k.defaultGetHeaders($.options),G=q.id||q;if(typeof G!=="string"||!G.length)throw new D("First argument to DeviceRegistrations#get must be a deviceId string or DeviceDetails",40000,400);y(Z,$.options.headers);let X=await X0.get($,"/push/deviceRegistrations/"+encodeURIComponent(G),Z,{},null,!0);return L1.fromResponseBody(X.body,$._MsgPack,X.unpacked?void 0:w)}async list(q){let $=this.client,w=$.options.useBinaryProtocol?"msgpack":"json",Z=this.client.http.supportsLinkHeaders?void 0:w,G=k.defaultGetHeaders($.options);return y(G,$.options.headers),new k0($,"/push/deviceRegistrations",G,Z,async function(X,U,O){return L1.fromResponseBody(X,$._MsgPack,O?void 0:w)}).get(q)}async remove(q){let $=this.client,w=k.defaultGetHeaders($.options),Z={},G=q.id||q;if(typeof G!=="string"||!G.length)throw new D("First argument to DeviceRegistrations#remove must be a deviceId string or DeviceDetails",40000,400);if(y(w,$.options.headers),$.options.pushFullWait)y(Z,{fullWait:"true"});await X0.delete($,"/push/deviceRegistrations/"+encodeURIComponent(G),w,Z,null,!0)}async removeWhere(q){let $=this.client,w=$.options.useBinaryProtocol?"msgpack":"json",Z=k.defaultGetHeaders($.options,{format:w});if(y(Z,$.options.headers),$.options.pushFullWait)y(q,{fullWait:"true"});await X0.delete($,"/push/deviceRegistrations",Z,q,null,!0)}},O4=class q{constructor($){this.remove=q.prototype.removeWhere,this.client=$}async save($){let w=this.client,Z=mq.fromValues($),G=w.options.useBinaryProtocol?"msgpack":"json",X=k.defaultPostHeaders(w.options),U={};if(y(X,w.options.headers),w.options.pushFullWait)y(U,{fullWait:"true"});let O=P0(Z,w._MsgPack,G),F=await X0.post(w,"/push/channelSubscriptions",O,X,U,null,!0);return mq.fromResponseBody(F.body,w._MsgPack,F.unpacked?void 0:G)}async list($){let w=this.client,Z=w.options.useBinaryProtocol?"msgpack":"json",G=this.client.http.supportsLinkHeaders?void 0:Z,X=k.defaultGetHeaders(w.options);return y(X,w.options.headers),new k0(w,"/push/channelSubscriptions",X,G,async function(U,O,F){return mq.fromResponseBody(U,w._MsgPack,F?void 0:Z)}).get($)}async removeWhere($){let w=this.client,Z=w.options.useBinaryProtocol?"msgpack":"json",G=k.defaultGetHeaders(w.options,{format:Z});if(y(G,w.options.headers),w.options.pushFullWait)y($,{fullWait:"true"});await X0.delete(w,"/push/channelSubscriptions",G,$,null,!0)}async listChannels($){let w=this.client,Z=w.options.useBinaryProtocol?"msgpack":"json",G=this.client.http.supportsLinkHeaders?void 0:Z,X=k.defaultGetHeaders(w.options);if(y(X,w.options.headers),w.options.pushFullWait)y($,{fullWait:"true"});return new k0(w,"/push/channels",X,G,async function(U,O,F){let z=!F&&Z?F0(U,w._MsgPack,Z):U;for(let I=0;I<z.length;I++)z[I]=String(z[I]);return z}).get($)}},V4=H4,G7=["absent","present","enter","leave","update"];async function J7(q,$,w,Z){let G=r$($,q,Z!=null?Z:null);return s1.fromValues(w).decode(G,q)}async function z4(q,$,w,Z){return Promise.all(w.map(function(G){return J7(q,$,G,Z)}))}async function F4(q,$){return s1.fromValues(q).decode($.channelOptions,$.logger)}async function N7(q,$){return Promise.all(q.map(function(w){return F4(w,$)}))}var X7=class q extends M1{isSynthesized(){if(!this.id||!this.connectionId)return!0;return this.id.substring(this.connectionId.length,0)!==this.connectionId}parseId(){if(!this.id)throw Error("parseId(): Presence message does not contain an id");let $=this.id.split(":");return{connectionId:$[0],msgSerial:parseInt($[1],10),index:parseInt($[2],10)}}async encode($){let w=Object.assign(new s1,this,{action:G7.indexOf(this.action||"present")});return p8(w,$)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((w)=>q.fromValues(w))}static fromData($){if($ instanceof q)return $;return q.fromValues({data:$})}toString(){return A1(this,"PresenceMessage")}},s1=class q extends M1{toJSON(...$){return x8.call(this,...$)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((w)=>q.fromValues(w))}async decode($,w){let Z=Object.assign(new X7,c(_({},this),{action:G7[this.action]}));try{await v8(Z,$)}catch(G){Q.logAction(w,Q.LOG_ERROR,"WirePresenceMessage.decode()",W0(G))}return Z}toString(){return A1(this,"WirePresenceMessage")}},f0=X7,h4=class{constructor(q){this.channel=q}get logger(){return this.channel.logger}async get(q){Q.logAction(this.logger,Q.LOG_MICRO,"RestPresence.get()","channel = "+this.channel.name);let $=this.channel.client,w=$.options.useBinaryProtocol?"msgpack":"json",Z=this.channel.client.http.supportsLinkHeaders?void 0:w,G=k.defaultGetHeaders($.options);return y(G,$.options.headers),new k0($,this.channel.client.rest.presenceMixin.basePath(this),G,Z,async(X,U,O)=>{let F=O?X:F0(X,$._MsgPack,w);return N7(F,this.channel)}).get(q)}async history(q){return Q.logAction(this.logger,Q.LOG_MICRO,"RestPresence.history()","channel = "+this.channel.name),this.channel.client.rest.presenceMixin.history(this,q)}},D4=h4,Q7=["message.create","message.update","message.delete","meta","message.summary"];function B4(q){return Q7[q||0]||"unknown"}function Y4(q){let $=0;if(q.name)$+=q.name.length;if(q.clientId)$+=q.clientId.length;if(q.extras)$+=JSON.stringify(q.extras).length;if(q.data)$+=j$(q.data);return $}async function H7(q,$,w,Z){let G=r$($,q,Z!=null?Z:null);return e1.fromValues(w).decode(G,q)}async function I4(q,$,w,Z){return Promise.all(w.map(function(G){return H7(q,$,G,Z)}))}async function U7(q,$){return e1.fromValues(q).decode($.channelOptions,$.logger)}async function K7(q,$){return Promise.all(q.map(function(w){return U7(w,$)}))}async function O7(q,$){return Promise.all(q.map((w)=>w.encode($)))}var V7=P0;function d8(q){let $,w=0;for(let Z=0;Z<q.length;Z++)$=q[Z],w+=$.size||($.size=Y4($));return w}var z7=class q extends M1{expandFields(){if(!this.version)this.version={};if(!this.version.serial&&this.serial)this.version.serial=this.serial;if(!this.version.timestamp&&this.timestamp)this.version.timestamp=this.timestamp;if(!this.annotations)this.annotations={summary:{}};else if(!this.annotations.summary)this.annotations.summary={};if(this.annotations&&this.annotations.summary){for(let[$,w]of Object.entries(this.annotations.summary))if($.endsWith(":distinct.v1")||$.endsWith(":unique.v1")||$.endsWith(":multiple.v1")){for(let[,Z]of Object.entries(w))if(!Z.clipped)Z.clipped=!1}else if($.endsWith(":flag.v1")){if(!w.clipped)w.clipped=!1}}}async encode($){let w=Object.assign(new e1,this,{action:Q7.indexOf(this.action||"message.create")});return p8(w,$)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((w)=>q.fromValues(w))}toString(){return A1(this,"Message")}},e1=class q extends M1{toJSON(...$){return x8.call(this,...$)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((w)=>q.fromValues(w))}async decodeWithErr($,w){let Z=Object.assign(new z7,c(_({},this),{action:B4(this.action)})),G;try{await v8(Z,$)}catch(X){Q.logAction(w,Q.LOG_ERROR,"WireMessage.decode()",W0(X)),G=X}return Z.expandFields(),{decoded:Z,err:G}}async decode($,w){let{decoded:Z}=await this.decodeWithErr($,w);return Z}toString(){return A1(this,"WireMessage")}},m0=z7,j4=9;function A4(q){return q.every(function($){return!$.id})}var M4=class{constructor(q,$,w){this._annotations=null;var Z,G;if(Q.logAction(q.logger,Q.LOG_MINOR,"RestChannel()","started; name = "+$),this.name=$,this.client=q,this.presence=new D4(this),this.channelOptions=xq((Z=q._Crypto)!=null?Z:null,this.logger,w),(G=q.options.plugins)==null?void 0:G.Push)this._push=new q.options.plugins.Push.PushChannel(this);if(q._Annotations)this._annotations=new q._Annotations.RestAnnotations(this)}get annotations(){if(!this._annotations)h0("Annotations");return this._annotations}get push(){if(!this._push)h0("Push");return this._push}get logger(){return this.client.logger}setOptions(q){var $;this.channelOptions=xq(($=this.client._Crypto)!=null?$:null,this.logger,q)}async history(q){return Q.logAction(this.logger,Q.LOG_MICRO,"RestChannel.history()","channel = "+this.name),this.client.rest.channelMixin.history(this,q)}async publish(...q){let $=q[0],w=q[1],Z,G;if(typeof $==="string"||$===null)Z=[m0.fromValues({name:$,data:w})],G=q[2];else if(I1($))Z=[m0.fromValues($)],G=q[1];else if(Array.isArray($))Z=m0.fromValuesArray($),G=q[1];else throw new D("The single-argument form of publish() expects a message object or an array of message objects",40013,400);if(!G)G={};let X=this.client,U=X.options,O=U.useBinaryProtocol?"msgpack":"json",F=X.options.idempotentRestPublishing,z=k.defaultPostHeaders(X.options);if(y(z,U.headers),F&&A4(Z)){let M=await A$(j4);Z.forEach(function(E,T){E.id=M+":"+T.toString()})}let I=await O7(Z,this.channelOptions),j=d8(I),A=U.maxMessageSize;if(j>A)throw new D(`Maximum size of messages that can be published at once exceeded (was ${j} bytes; limit is ${A} bytes)`,40009,400);await this._publish(V7(I,X._MsgPack,O),z,G)}async _publish(q,$,w){await X0.post(this.client,this.client.rest.channelMixin.basePath(this)+"/messages",q,$,w,null,!0)}async status(){return this.client.rest.channelMixin.status(this)}async getMessage(q){return Q.logAction(this.logger,Q.LOG_MICRO,"RestChannel.getMessage()","channel = "+this.name),this.client.rest.channelMixin.getMessage(this,q)}async updateMessage(q,$,w){return Q.logAction(this.logger,Q.LOG_MICRO,"RestChannel.updateMessage()","channel = "+this.name),this.client.rest.channelMixin.updateDeleteMessage(this,{isDelete:!1},q,$,w)}async deleteMessage(q,$,w){return Q.logAction(this.logger,Q.LOG_MICRO,"RestChannel.deleteMessage()","channel = "+this.name),this.client.rest.channelMixin.updateDeleteMessage(this,{isDelete:!0},q,$,w)}async getMessageVersions(q,$){return Q.logAction(this.logger,Q.LOG_MICRO,"RestChannel.getMessageVersions()","channel = "+this.name),this.client.rest.channelMixin.getMessageVersions(this,q,$)}},L4=M4,R4=class q{constructor($){this.entries=$&&$.entries||void 0,this.schema=$&&$.schema||void 0,this.appId=$&&$.appId||void 0,this.inProgress=$&&$.inProgress||void 0,this.unit=$&&$.unit||void 0,this.intervalId=$&&$.intervalId||void 0}static fromValues($){return new q($)}},S4=R4,F7=class{static basePath(q){return"/channels/"+encodeURIComponent(q.name)}static history(q,$){let w=q.client,Z=w.options.useBinaryProtocol?"msgpack":"json",G=q.client.http.supportsLinkHeaders?void 0:Z,X=k.defaultGetHeaders(w.options);return y(X,w.options.headers),new k0(w,this.basePath(q)+"/messages",X,G,async function(U,O,F){let z=F?U:F0(U,w._MsgPack,Z);return K7(z,q)}).get($)}static async status(q){let $=q.client.options.useBinaryProtocol?"msgpack":"json",w=k.defaultPostHeaders(q.client.options);return(await X0.get(q.client,this.basePath(q),w,{},$,!0)).body}static async getMessage(q,$){let w=typeof $==="string"?$:$.serial;if(!w)throw new D('This message lacks a serial. Make sure you have enabled "Message annotations, updates, and deletes" in channel settings on your dashboard.',40003,400);let Z=q.client,G=Z.options.useBinaryProtocol?"msgpack":"json",X=k.defaultGetHeaders(Z.options);y(X,Z.options.headers);let{body:U,unpacked:O}=await X0.get(Z,this.basePath(q)+"/messages/"+encodeURIComponent(w),X,{},null,!0),F=O?U:F0(U,Z._MsgPack,G);return U7(F,q)}static async updateDeleteMessage(q,$,w,Z,G){if(!w.serial)throw new D('This message lacks a serial and cannot be updated. Make sure you have enabled "Message annotations, updates, and deletes" in channel settings on your dashboard.',40003,400);let X=q.client,U=X.options.useBinaryProtocol?"msgpack":"json",O=k.defaultPostHeaders(X.options);y(O,X.options.headers);let F=null;if(w.data!==void 0)F=await m0.fromValues(w).encode(q.channelOptions);let z={serial:w.serial,operation:Z,name:w.name,data:F&&F.data,encoding:F&&F.encoding,extras:w.extras},I=V7(z,X._MsgPack,U),j=$.isDelete?X0.post:X0.patch,A=$.isDelete?"/delete":"";await j(X,this.basePath(q)+"/messages/"+encodeURIComponent(w.serial)+A,I,O,G||{},null,!0)}static getMessageVersions(q,$,w){let Z=typeof $==="string"?$:$.serial;if(!Z)throw new D('This message lacks a serial. Make sure you have enabled "Message annotations, updates, and deletes" in channel settings on your dashboard.',40003,400);let G=q.client,X=G.options.useBinaryProtocol?"msgpack":"json",U=q.client.http.supportsLinkHeaders?void 0:X,O=k.defaultGetHeaders(G.options);return y(O,G.options.headers),new k0(G,this.basePath(q)+"/messages/"+encodeURIComponent(Z)+"/versions",O,U,async(F,z,I)=>{let j=I?F:F0(F,G._MsgPack,X);return K7(j,q)}).get(w||{})}},_4=class{static basePath(q){return F7.basePath(q.channel)+"/presence"}static async history(q,$){let w=q.channel.client,Z=w.options.useBinaryProtocol?"msgpack":"json",G=q.channel.client.http.supportsLinkHeaders?void 0:Z,X=k.defaultGetHeaders(w.options);return y(X,w.options.headers),new k0(w,this.basePath(q)+"/history",X,G,async(U,O,F)=>{let z=F?U:F0(U,w._MsgPack,Z);return N7(z,q.channel)}).get($)}},h7=class{constructor(q){this.channelMixin=F7,this.presenceMixin=_4,this.Resource=X0,this.PaginatedResource=k0,this.DeviceDetails=L1,this.PushChannelSubscription=mq,this.client=q,this.channels=new b4(this.client),this.push=new V4(this.client)}async stats(q){let $=k.defaultGetHeaders(this.client.options),w=this.client.options.useBinaryProtocol?"msgpack":"json",Z=this.client.http.supportsLinkHeaders?void 0:w;return y($,this.client.options.headers),new k0(this.client,"/stats",$,Z,async(G,X,U)=>{let O=U?G:F0(G,this.client._MsgPack,w);for(let F=0;F<O.length;F++)O[F]=S4.fromValues(O[F]);return O}).get(q)}async time(q){let $=k.defaultGetHeaders(this.client.options,{format:"json"});if(this.client.options.headers)y($,this.client.options.headers);let w=(O)=>{return this.client.baseUri(O)+"/time"},{error:Z,body:G,unpacked:X}=await this.client.http.do(U0.Get,w,$,null,q);if(Z)throw Z;if(!X)G=JSON.parse(G);let U=G[0];if(!U)throw new D("Internal error (unexpected result type from GET /time)",50000,500);return this.client.serverTimeOffset=U-Date.now(),U}async request(q,$,w,Z,G,X){var U;let[O,F,z]=(()=>{if(this.client.options.useBinaryProtocol){if(!this.client._MsgPack)h0("MsgPack");return[this.client._MsgPack.encode,this.client._MsgPack.decode,"msgpack"]}else return[JSON.stringify,JSON.parse,"json"]})(),I=this.client.http.supportsLinkHeaders?void 0:z;Z=Z||{};let j=q.toLowerCase(),A=j=="get"?k.defaultGetHeaders(this.client.options,{format:z,protocolVersion:w}):k.defaultPostHeaders(this.client.options,{format:z,protocolVersion:w});if(typeof G!=="string")G=(U=O(G))!=null?U:null;if(y(A,this.client.options.headers),X)y(A,X);let M=new k0(this.client,$,A,I,async function(E,T,d){return U$(d?E:F(E))},!0);if(!B.Http.methods.includes(j))throw new D("Unsupported method "+j,40500,405);if(B.Http.methodsWithBody.includes(j))return M[j](Z,G);else return M[j](Z)}async batchPublish(q){let $,w;if(Array.isArray(q))$=q,w=!1;else $=[q],w=!0;let Z=this.client.options.useBinaryProtocol?"msgpack":"json",G=k.defaultPostHeaders(this.client.options);if(this.client.options.headers)y(G,this.client.options.headers);let X=P0($,this.client._MsgPack,Z),U=await X0.post(this.client,"/messages",X,G,{},null,!0),O=U.unpacked?U.body:F0(U.body,this.client._MsgPack,Z);if(w)return O[0];else return O}async batchPresence(q){let $=this.client.options.useBinaryProtocol?"msgpack":"json",w=k.defaultGetHeaders(this.client.options);if(this.client.options.headers)y(w,this.client.options.headers);let Z=q.join(","),G=await X0.get(this.client,"/presence",w,{channels:Z},null,!0);return G.unpacked?G.body:F0(G.body,this.client._MsgPack,$)}async revokeTokens(q,$){if(m$(this.client.options))throw new D("Cannot revoke tokens when using token auth",40162,401);let w=this.client.options.keyName,Z=$!=null?$:{},G=_({targets:q.map((z)=>`${z.type}:${z.value}`)},Z),X=this.client.options.useBinaryProtocol?"msgpack":"json",U=k.defaultPostHeaders(this.client.options);if(this.client.options.headers)y(U,this.client.options.headers);let O=P0(G,this.client._MsgPack,X),F=await X0.post(this.client,`/keys/${w}/revokeTokens`,O,U,{},null,!0);return F.unpacked?F.body:F0(F.body,this.client._MsgPack,X)}},b4=class{constructor(q){this.client=q,this.all=Object.create(null)}get(q,$){q=String(q);let w=this.all[q];if(!w)this.all[q]=w=new L4(this.client,q,$);else if($)w.setOptions($);return w}release(q){delete this.all[String(q)]}},T4=class extends w7{constructor(q){super(k.objectifyOptions(q,!1,"BaseRest",Q.defaultLogger,{Rest:h7}))}},D7={Rest:h7},B7=class extends m0{static async fromEncoded(q,$){return H7(Q.defaultLogger,B.Crypto,q,$)}static async fromEncodedArray(q,$){return I4(Q.defaultLogger,B.Crypto,q,$)}static fromValues(q){return m0.fromValues(q)}},Y7=class extends f0{static async fromEncoded(q,$){return J7(Q.defaultLogger,B.Crypto,q,$)}static async fromEncodedArray(q,$){return z4(Q.defaultLogger,B.Crypto,q,$)}static fromValues(q){return f0.fromValues(q)}},I7=["annotation.create","annotation.delete"];async function j7(q,$,w){return R1.fromValues($).decode(w||{},q)}async function c4(q,$,w){return Promise.all($.map(function(Z){return j7(q,Z,w)}))}async function E4(q,$){return R1.fromValues(q).decode($.channelOptions,$.logger)}async function P4(q,$){return Promise.all(q.map(function(w){return E4(w,$)}))}var A7=class q extends M1{async encode(){let $=Object.assign(new R1,this,{action:I7.indexOf(this.action||"annotation.create")});return p8($,{})}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((w)=>q.fromValues(w))}toString(){return A1(this,"Annotation")}},R1=class q extends M1{toJSON(...$){return x8.call(this,...$)}static fromValues($){return Object.assign(new q,$)}static fromValuesArray($){return $.map((w)=>q.fromValues(w))}async decode($,w){let Z=Object.assign(new A7,c(_({},this),{action:I7[this.action]}));try{await v8(Z,$)}catch(G){Q.logAction(w,Q.LOG_ERROR,"WireAnnotation.decode()",W0(G))}return Z}toString(){return A1(this,"WireAnnotation")}},S1=A7,M7=class extends S1{static async fromEncoded(q,$){return j7(Q.defaultLogger,q,$)}static async fromEncodedArray(q,$){return c4(Q.defaultLogger,q,$)}static fromValues(q){return S1.fromValues(q)}};function L7(q){let $;switch(typeof q){case"string":$=q;break;case"object":$=q.serial;break}if(!$||typeof $!=="string")throw new D("First argument of annotations.publish() must be either a Message (or at least an object with a string `serial` property) or a message serial (string)",40003,400);return $}function R7(q,$){let w=L7(q);if(!$||typeof $!=="object")throw new D("Second argument of annotations.publish() must be an object (the intended annotation to publish)",40003,400);let Z=S1.fromValues($);if(Z.messageSerial=w,!Z.action)Z.action="annotation.create";return Z}function S7(q,$){return q.client.rest.channelMixin.basePath(q)+"/messages/"+encodeURIComponent($)+"/annotations"}var C4=class{constructor(q){this.channel=q}async publish(q,$){let w=R7(q,$),Z=await w.encode(),G=this.channel.client,X=G.options,U=X.useBinaryProtocol?"msgpack":"json",O=k.defaultPostHeaders(G.options),F={};y(O,G.options.headers);let z=P0([Z],G._MsgPack,U);await X0.post(G,S7(this.channel,w.messageSerial),z,O,F,null,!0)}async delete(q,$){return $.action="annotation.delete",this.publish(q,$)}async get(q,$){let w=this.channel.client,Z=L7(q),G=w.options.useBinaryProtocol?"msgpack":"json",X=w.http.supportsLinkHeaders?void 0:G,U=k.defaultGetHeaders(w.options);return y(U,w.options.headers),new k0(w,S7(this.channel,Z),U,X,async(O,F,z)=>{let I=z?O:F0(O,w._MsgPack,G);return P4(I,this.channel)}).get($)}},oq=C4,k4=P0;function lq(q){let $=[];if(q)for(let w=0;w<q.length;w++)$.push(q[w].toString());return"[ "+$.join(", ")+" ]"}function y4(q,$,w,Z,G,X){let U=F0(q,$,X);return t8(U,w,Z,G)}function t8(q,$,w,Z){let G;if(q.error)G=D.fromValues(q.error);let X;if(q.messages)X=e1.fromValuesArray(q.messages);let U;if($&&q.presence)U=$.WirePresenceMessage.fromValuesArray(q.presence);let O;if(w&&q.annotations)O=w.WireAnnotation.fromValuesArray(q.annotations);let F;if(Z&&q.state)F=Z.WireObjectMessage.fromValuesArray(q.state,z0,tq);return Object.assign(new m8,c(_({},q),{presence:U,messages:X,annotations:O,state:F,error:G}))}function _7(q){return($)=>{var w;return t8($,{PresenceMessage:f0,WirePresenceMessage:s1},{Annotation:S1,WireAnnotation:R1,RealtimeAnnotations:l8,RestAnnotations:oq},(w=q==null?void 0:q.ObjectsPlugin)!=null?w:null)}}function R0(q){return Object.assign(new m8,q)}function f8(q,$,w,Z){let G="[ProtocolMessage";if(q.action!==void 0)G+="; action="+o$[q.action]||q.action;let X=["id","channel","channelSerial","connectionId","count","msgSerial","timestamp"],U;for(let O=0;O<X.length;O++)if(U=X[O],q[U]!==void 0)G+="; "+U+"="+q[U];if(q.messages)G+="; messages="+lq(e1.fromValuesArray(q.messages));if(q.presence&&$)G+="; presence="+lq($.WirePresenceMessage.fromValuesArray(q.presence));if(q.annotations&&w)G+="; annotations="+lq(w.WireAnnotation.fromValuesArray(q.annotations));if(q.state&&Z)G+="; state="+lq(Z.WireObjectMessage.fromValuesArray(q.state,z0,tq));if(q.error)G+="; error="+D.fromValues(q.error).toString();if(q.auth&&q.auth.accessToken)G+="; token="+q.auth.accessToken;if(q.flags)G+="; flags="+su.filter(q.hasFlag).join(",");if(q.params){let O="";if(D$(q.params,function(F){if(O.length>0)O+="; ";O+=F+"="+q.params[F]}),O.length>0)G+="; params=["+O+"]"}return G+="]",G}var m8=class{constructor(){this.hasFlag=(q)=>{return(this.flags&A0[q])>0}}setFlag(q){return this.flags=this.flags|A0[q]}getMode(){return(this.flags||0)&A0.MODE_ALL}encodeModesToFlags(q){q.forEach(($)=>this.setFlag($))}decodeModesFromFlags(){let q=[];return l$.forEach(($)=>{if(this.hasFlag($))q.push($)}),q.length>0?q:void 0}},n4=m8,i4=class{constructor(q,$,w,Z,G){if(this.previous=q,this.current=$,$==="attached")this.resumed=w,this.hasBacklog=Z;if(G)this.reason=G}},o8=i4,b7=function(){};function g4(q){if(q&&"params"in q&&!I1(q.params))return new D("options.params must be an object",40000,400);if(q&&"modes"in q){if(!Array.isArray(q.modes))return new D("options.modes must be an array",40000,400);for(let $=0;$<q.modes.length;$++){let w=q.modes[$];if(!w||typeof w!=="string"||!l$.includes(String.prototype.toUpperCase.call(w)))return new D("Invalid channel mode: "+w,40000,400)}}}var p4=class q extends V0{constructor($,w,Z){var G,X,U;super($.logger);if(this._annotations=null,this._mode=0,this.retryCount=0,this.history=async function(O){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.history()","channel = "+this.name);let F=this.client.rest.channelMixin;if(O&&O.untilAttach){if(this.state!=="attached")throw new D("option untilAttach requires the channel to be attached",40000,400);if(!this.properties.attachSerial)throw new D("untilAttach was specified and channel is attached, but attachSerial is not defined",40000,400);delete O.untilAttach,O.from_serial=this.properties.attachSerial}return F.history(this,O)},this.whenState=(O)=>{return V0.prototype.whenState.call(this,O,this.state)},Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel()","started; name = "+w),this.name=w,this.channelOptions=xq((G=$._Crypto)!=null?G:null,this.logger,Z),this.client=$,this._presence=$._RealtimePresence?new $._RealtimePresence.RealtimePresence(this):null,$._Annotations)this._annotations=new $._Annotations.RealtimeAnnotations(this);if(this.connectionManager=$.connection.connectionManager,this.state="initialized",this.subscriptions=new V0(this.logger),this.syncChannelSerial=void 0,this.properties={attachSerial:void 0,channelSerial:void 0},this.setOptions(Z),this.errorReason=null,this._attachResume=!1,this._decodingContext={channelOptions:this.channelOptions,plugins:$.options.plugins||{},baseEncodedPreviousPayload:void 0},this._lastPayload={messageId:null,protocolMessageChannelSerial:null,decodeFailureRecoveryInProgress:null},this._allChannelChanges=new V0(this.logger),(X=$.options.plugins)==null?void 0:X.Push)this._push=new $.options.plugins.Push.PushChannel(this);if((U=$.options.plugins)==null?void 0:U.Objects)this._objects=new $.options.plugins.Objects.Objects(this)}get presence(){if(!this._presence)h0("RealtimePresence");return this._presence}get annotations(){if(!this._annotations)h0("Annotations");return this._annotations}get push(){if(!this._push)h0("Push");return this._push}get objects(){if(!this._objects)h0("Objects");return this._objects}invalidStateError(){return new D("Channel operation failed as channel state is "+this.state,90001,400,this.errorReason||void 0)}static processListenerArgs($){if($=Array.prototype.slice.call($),typeof $[0]==="function")$.unshift(null);return $}async setOptions($){var w;let Z=this.channelOptions,G=g4($);if(G)throw G;if(this.channelOptions=xq((w=this.client._Crypto)!=null?w:null,this.logger,$),this._decodingContext)this._decodingContext.channelOptions=this.channelOptions;if(this._shouldReattachToSetOptions($,Z))return this.attachImpl(),new Promise((X,U)=>{this._allChannelChanges.once(["attached","update","detached","failed"],function(O){switch(this.event){case"update":case"attached":X();break;default:U(O.reason)}})})}_shouldReattachToSetOptions($,w){if(!(this.state==="attached"||this.state==="attaching"))return!1;if($==null?void 0:$.params){let Z=T7($.params),G=T7(w.params);if(Object.keys(Z).length!==Object.keys(G).length)return!0;if(!_$(G,Z))return!0}if($==null?void 0:$.modes){if(!w.modes||!T$($.modes,w.modes))return!0}return!1}async publish(...$){let w;if($.length==1)if(I1($[0]))w=[m0.fromValues($[0])];else if(Array.isArray($[0]))w=m0.fromValuesArray($[0]);else throw new D("The single-argument form of publish() expects a message object or an array of message objects",40013,400);else w=[m0.fromValues({name:$[0],data:$[1]})];let G=this.client.options.maxMessageSize,X=await O7(w,this.channelOptions),U=d8(X);if(U>G)throw new D(`Maximum size of messages that can be published at once exceeded (was ${U} bytes; limit is ${G} bytes)`,40009,400);this.throwIfUnpublishableState(),Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.publish()","sending message; channel state is "+this.state+", message count = "+X.length);let O=R0({action:C.MESSAGE,channel:this.name,messages:X});return this.sendMessage(O)}throwIfUnpublishableState(){if(!this.connectionManager.activeState())throw this.connectionManager.getError();if(this.state==="failed"||this.state==="suspended")throw this.invalidStateError()}onEvent($){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.onEvent()","received message");let w=this.subscriptions;for(let Z=0;Z<$.length;Z++){let G=$[Z];w.emit(G.name,G)}}async attach(){if(this.state==="attached")return null;return new Promise(($,w)=>{this._attach(!1,null,(Z,G)=>Z?w(Z):$(G))})}_attach($,w,Z){if(!Z)Z=(X)=>{if(X)Q.logAction(this.logger,Q.LOG_ERROR,"RealtimeChannel._attach()","Channel attach failed: "+X.toString())};let G=this.connectionManager;if(!G.activeState()){Z(G.getError());return}if(this.state!=="attaching"||$)this.requestState("attaching",w);this.once(function(X){switch(this.event){case"attached":Z==null||Z(null,X);break;case"detached":case"suspended":case"failed":Z==null||Z(X.reason||G.getError()||new D("Unable to attach; reason unknown; state = "+this.event,90000,500));break;case"detaching":Z==null||Z(new D("Attach request superseded by a subsequent detach request",90000,409));break}})}attachImpl(){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.attachImpl()","sending ATTACH message");let $=R0({action:C.ATTACH,channel:this.name,params:this.channelOptions.params,channelSerial:this.properties.channelSerial});if(this.channelOptions.modes)$.encodeModesToFlags(L$(this.channelOptions.modes));if(this._attachResume)$.setFlag("ATTACH_RESUME");if(this._lastPayload.decodeFailureRecoveryInProgress)$.channelSerial=this._lastPayload.protocolMessageChannelSerial;this.sendMessage($).catch(b7)}async detach(){let $=this.connectionManager;if(!$.activeState())throw $.getError();switch(this.state){case"suspended":this.notifyState("detached");return;case"detached":return;case"failed":throw new D("Unable to detach; channel state = failed",90001,400);default:this.requestState("detaching");case"detaching":return new Promise((w,Z)=>{this.once(function(G){switch(this.event){case"detached":w();break;case"attached":case"suspended":case"failed":Z(G.reason||$.getError()||new D("Unable to detach; reason unknown; state = "+this.event,90000,500));break;case"attaching":Z(new D("Detach request superseded by a subsequent attach request",90000,409));break}})})}}detachImpl(){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.detach()","sending DETACH message");let $=R0({action:C.DETACH,channel:this.name});this.sendMessage($).catch(b7)}async subscribe(...$){let[w,Z]=q.processListenerArgs($);if(this.state==="failed")throw D.fromValues(this.invalidStateError());if(w&&typeof w==="object"&&!Array.isArray(w))this.client._FilteredSubscriptions.subscribeFilter(this,w,Z);else this.subscriptions.on(w,Z);if(this.channelOptions.attachOnSubscribe!==!1)return this.attach();else return null}unsubscribe(...$){var w;let[Z,G]=q.processListenerArgs($);if(typeof Z==="object"&&!G||((w=this.filteredSubscriptions)==null?void 0:w.has(G))){this.client._FilteredSubscriptions.getAndDeleteFilteredSubscriptions(this,Z,G).forEach((X)=>this.subscriptions.off(X));return}this.subscriptions.off(Z,G)}sync(){switch(this.state){case"initialized":case"detaching":case"detached":throw new r("Unable to sync to channel; not attached",40000);default:}let $=this.connectionManager;if(!$.activeState())throw $.getError();let w=R0({action:C.SYNC,channel:this.name});if(this.syncChannelSerial)w.channelSerial=this.syncChannelSerial;$.send(w)}async sendMessage($){return new Promise((w,Z)=>{this.connectionManager.send($,this.client.options.queueMessages,(G)=>{if(G)Z(G);else w()})})}async sendPresence($){let w=R0({action:C.PRESENCE,channel:this.name,presence:$});return this.sendMessage(w)}sendState($){let w=R0({action:C.OBJECT,channel:this.name,state:$});return this.sendMessage(w)}async processMessage($){if($.action===C.ATTACHED||$.action===C.MESSAGE||$.action===C.PRESENCE||$.action===C.OBJECT||$.action===C.ANNOTATION)this.setChannelSerial($.channelSerial);let w,Z=!1;switch($.action){case C.ATTACHED:{this.properties.attachSerial=$.channelSerial,this._mode=$.getMode(),this.params=$.params||{};let G=$.decodeModesFromFlags();this.modes=G&&c8(G)||void 0;let X=$.hasFlag("RESUMED"),U=$.hasFlag("HAS_PRESENCE"),O=$.hasFlag("HAS_BACKLOG"),F=$.hasFlag("HAS_OBJECTS");if(this.state==="attached"){if(!X){if(this._presence)this._presence.onAttached(U);if(this._objects)this._objects.onAttached(F)}let z=new o8(this.state,this.state,X,O,$.error);if(this._allChannelChanges.emit("update",z),!X||this.channelOptions.updateOnAttached)this.emit("update",z)}else if(this.state==="detaching")this.checkPendingState();else this.notifyState("attached",$.error,X,U,O,F);break}case C.DETACHED:{let G=$.error?D.fromValues($.error):new D("Channel detached",90001,404);if(this.state==="detaching")this.notifyState("detached",G);else if(this.state==="attaching")this.notifyState("suspended",G);else if(this.state==="attached"||this.state==="suspended")this.requestState("attaching",G);break}case C.SYNC:if(Z=!0,w=this.syncChannelSerial=$.channelSerial,!$.presence)break;case C.PRESENCE:{if(!$.presence)break;fq($);let G=this.channelOptions;if(this._presence){let X=await Promise.all($.presence.map((U)=>{return U.decode(G,this.logger)}));this._presence.setPresence(X,Z,w)}break}case C.OBJECT:case C.OBJECT_SYNC:{if(!this._objects||!$.state)return;fq($);let G=this.client.connection.connectionManager.getActiveTransportFormat(),X=$.state.map((U)=>U.decode(this.client,G));if($.action===C.OBJECT)this._objects.handleObjectMessages(X);else this._objects.handleObjectSyncMessages(X,$.channelSerial);break}case C.MESSAGE:{if(this.state!=="attached"){Q.logAction(this.logger,Q.LOG_MAJOR,"RealtimeChannel.processMessage()",'Message "'+$.id+'" skipped as this channel "'+this.name+'" state is not "attached" (state is "'+this.state+'").');return}fq($);let G=$.messages,X=G[0],U=G[G.length-1];if(X.extras&&X.extras.delta&&X.extras.delta.from!==this._lastPayload.messageId){let F='Delta message decode failure - previous message not available for message "'+$.id+'" on this channel "'+this.name+'".';Q.logAction(this.logger,Q.LOG_ERROR,"RealtimeChannel.processMessage()",F),this._startDecodeFailureRecovery(new D(F,40018,400));break}let O=[];for(let F=0;F<G.length;F++){let{decoded:z,err:I}=await G[F].decodeWithErr(this._decodingContext,this.logger);if(O[F]=z,I)switch(I.code){case 40018:this._startDecodeFailureRecovery(I);return;case 40019:case 40021:this.notifyState("failed",I);return;default:}}this._lastPayload.messageId=U.id,this._lastPayload.protocolMessageChannelSerial=$.channelSerial,this.onEvent(O);break}case C.ANNOTATION:{fq($);let G=this.channelOptions;if(this._annotations){let X=await Promise.all(($.annotations||[]).map((U)=>{return U.decode(G,this.logger)}));this._annotations._processIncoming(X)}break}case C.ERROR:{let G=$.error;if(G&&G.code==80016)this.checkPendingState();else this.notifyState("failed",D.fromValues(G));break}default:Q.logAction(this.logger,Q.LOG_MAJOR,"RealtimeChannel.processMessage()","Protocol error: unrecognised message action ("+$.action+")")}}_startDecodeFailureRecovery($){if(!this._lastPayload.decodeFailureRecoveryInProgress)Q.logAction(this.logger,Q.LOG_MAJOR,"RealtimeChannel.processMessage()","Starting decode failure recovery process."),this._lastPayload.decodeFailureRecoveryInProgress=!0,this._attach(!0,$,()=>{this._lastPayload.decodeFailureRecoveryInProgress=!1})}onAttached(){Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.onAttached","activating channel; name = "+this.name)}notifyState($,w,Z,G,X,U){if(Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.notifyState","name = "+this.name+", current state = "+this.state+", notifying state "+$),this.clearStateTimer(),["detached","suspended","failed"].includes($))this.properties.channelSerial=null;if($===this.state)return;if(this._presence)this._presence.actOnChannelState($,G,w);if(this._objects)this._objects.actOnChannelState($,U);if($==="suspended"&&this.connectionManager.state.sendEvents)this.startRetryTimer();else this.cancelRetryTimer();if(w)this.errorReason=w;let O=new o8(this.state,$,Z,X,w),F='Channel state for channel "'+this.name+'"',z=$+(w?"; reason: "+w:"");if($==="failed")Q.logAction(this.logger,Q.LOG_ERROR,F,z);else Q.logAction(this.logger,Q.LOG_MAJOR,F,z);if($!=="attaching"&&$!=="suspended")this.retryCount=0;if($==="attached")this.onAttached();if($==="attached")this._attachResume=!0;else if($==="detaching"||$==="failed")this._attachResume=!1;this.state=$,this._allChannelChanges.emit($,O),this.emit($,O)}requestState($,w){Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.requestState","name = "+this.name+", state = "+$),this.notifyState($,w),this.checkPendingState()}checkPendingState(){if(!this.connectionManager.state.sendEvents){Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.checkPendingState","sendEvents is false; state is "+this.connectionManager.state.state);return}switch(Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.checkPendingState","name = "+this.name+", state = "+this.state),this.state){case"attaching":this.startStateTimerIfNotRunning(),this.attachImpl();break;case"detaching":this.startStateTimerIfNotRunning(),this.detachImpl();break;case"attached":this.sync();break;default:break}}timeoutPendingState(){switch(this.state){case"attaching":{let $=new D("Channel attach timed out",90007,408);this.notifyState("suspended",$);break}case"detaching":{let $=new D("Channel detach timed out",90007,408);this.notifyState("attached",$);break}default:this.checkPendingState();break}}startStateTimerIfNotRunning(){if(!this.stateTimer)this.stateTimer=setTimeout(()=>{Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.startStateTimerIfNotRunning","timer expired"),this.stateTimer=null,this.timeoutPendingState()},this.client.options.timeouts.realtimeRequestTimeout)}clearStateTimer(){let $=this.stateTimer;if($)clearTimeout($),this.stateTimer=null}startRetryTimer(){if(this.retryTimer)return;this.retryCount++;let $=E8(this.client.options.timeouts.channelRetryTimeout,this.retryCount);this.retryTimer=setTimeout(()=>{if(this.state==="suspended"&&this.connectionManager.state.sendEvents)this.retryTimer=null,Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel retry timer expired","attempting a new attach"),this.requestState("attaching")},$)}cancelRetryTimer(){if(this.retryTimer)clearTimeout(this.retryTimer),this.retryTimer=null}getReleaseErr(){let $=this.state;if($==="initialized"||$==="detached"||$==="failed")return null;return new D("Can only release a channel in a state where there is no possibility of further updates from the server being received (initialized, detached, or failed); was "+$,90001,400)}setChannelSerial($){if(Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.setChannelSerial()","Updating channel serial; serial = "+$+"; previous = "+this.properties.channelSerial),$)this.properties.channelSerial=$}async status(){return this.client.rest.channelMixin.status(this)}async getMessage($){return Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.getMessage()","channel = "+this.name),this.client.rest.channelMixin.getMessage(this,$)}async updateMessage($,w,Z){return Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.updateMessage()","channel = "+this.name),this.client.rest.channelMixin.updateDeleteMessage(this,{isDelete:!1},$,w,Z)}async deleteMessage($,w,Z){return Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.deleteMessage()","channel = "+this.name),this.client.rest.channelMixin.updateDeleteMessage(this,{isDelete:!0},$,w,Z)}async getMessageVersions($,w){return Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeChannel.getMessageVersions()","channel = "+this.name),this.client.rest.channelMixin.getMessageVersions(this,$,w)}};function T7(q){let $=q||{},{agent:w}=$;return u0($,["agent"])}var qq=p4,v4=class{constructor(q){this.channel=q,this.logger=q.logger,this.subscriptions=new V0(this.logger)}async publish(q,$){let w=this.channel.name,Z=R7(q,$),G=await Z.encode();this.channel.throwIfUnpublishableState(),Q.logAction(this.logger,Q.LOG_MICRO,"RealtimeAnnotations.publish()","channelName = "+w+", sending annotation with messageSerial = "+Z.messageSerial+", type = "+Z.type);let X=R0({action:C.ANNOTATION,channel:w,annotations:[G]});return this.channel.sendMessage(X)}async delete(q,$){return $.action="annotation.delete",this.publish(q,$)}async subscribe(...q){let $=qq.processListenerArgs(q),w=$[0],Z=$[1],G=this.channel;if(G.state==="failed")throw D.fromValues(G.invalidStateError());if(this.subscriptions.on(w,Z),this.channel.channelOptions.attachOnSubscribe!==!1)await G.attach();if((this.channel.state==="attached"&&this.channel._mode&A0.ANNOTATION_SUBSCRIBE)===0)throw new D("You are trying to add an annotation listener, but you haven't requested the annotation_subscribe channel mode in ChannelOptions, so this won't do anything (we only deliver annotations to clients who have explicitly requested them)",93001,400)}unsubscribe(...q){let $=qq.processListenerArgs(q),w=$[0],Z=$[1];this.subscriptions.off(w,Z)}_processIncoming(q){for(let $ of q)this.subscriptions.emit($.type||"",$)}async get(q,$){return oq.prototype.get.call(this,q,$)}},l8=v4,O1=class q extends T4{constructor($){var w,Z;if(!q._MsgPack)throw Error("Expected DefaultRest._MsgPack to have been set");super(k.objectifyOptions($,!0,"Rest",Q.defaultLogger,c(_({},D7),{Crypto:(w=q.Crypto)!=null?w:void 0,MsgPack:(Z=q._MsgPack)!=null?Z:void 0,Annotations:{Annotation:S1,WireAnnotation:R1,RealtimeAnnotations:l8,RestAnnotations:oq}})))}static get Crypto(){if(this._Crypto===null)throw Error("Encryption not enabled; use ably.encryption.js instead");return this._Crypto}static set Crypto($){this._Crypto=$}};O1._Crypto=null,O1.Message=B7,O1.PresenceMessage=Y7,O1.Annotation=M7,O1._MsgPack=null,O1._Http=i8;var r8=O1,x4=class extends V0{constructor(q){super(q);this.messages=[]}count(){return this.messages.length}push(q){this.messages.push(q)}shift(){return this.messages.shift()}last(){return this.messages[this.messages.length-1]}copyAll(){return this.messages.slice()}append(q){this.messages.push.apply(this.messages,q)}prepend(q){this.messages.unshift.apply(this.messages,q)}completeMessages(q,$,w){Q.logAction(this.logger,Q.LOG_MICRO,"MessageQueue.completeMessages()","serial = "+q+"; count = "+$),w=w||null;let Z=this.messages;if(Z.length===0)throw Error("MessageQueue.completeMessages(): completeMessages called on any empty MessageQueue");let G=Z[0];if(G){let X=G.message.msgSerial,U=q+$;if(U>X){let O=Z.splice(0,U-X);for(let F of O)F.callback(w)}if(Z.length==0)this.emit("idle")}}completeAllMessages(q){this.completeMessages(0,Number.MAX_SAFE_INTEGER||Number.MAX_VALUE,q)}resetSendAttempted(){for(let q of this.messages)q.sendAttempted=!1}clear(){Q.logAction(this.logger,Q.LOG_MICRO,"MessageQueue.clear()","clearing "+this.messages.length+" messages"),this.messages=[],this.emit("idle")}},c7=x4,E7=class{constructor(q,$){this.message=q,this.callback=$,this.merged=!1;let w=q.action;this.sendAttempted=!1,this.ackRequired=typeof w==="number"&&[C.MESSAGE,C.PRESENCE,C.ANNOTATION,C.OBJECT].includes(w)}},d4=class extends V0{constructor(q){super(q.logger);this.transport=q,this.messageQueue=new c7(this.logger),q.on("ack",($,w)=>{this.onAck($,w)}),q.on("nack",($,w,Z)=>{this.onNack($,w,Z)})}onAck(q,$){Q.logAction(this.logger,Q.LOG_MICRO,"Protocol.onAck()","serial = "+q+"; count = "+$),this.messageQueue.completeMessages(q,$)}onNack(q,$,w){if(Q.logAction(this.logger,Q.LOG_ERROR,"Protocol.onNack()","serial = "+q+"; count = "+$+"; err = "+W0(w)),!w)w=new D("Unable to send message; channel not responding",50001,500);this.messageQueue.completeMessages(q,$,w)}onceIdle(q){let $=this.messageQueue;if($.count()===0){q();return}$.once("idle",q)}send(q){if(q.ackRequired)this.messageQueue.push(q);if(this.logger.shouldLog(Q.LOG_MICRO))Q.logActionNoStrip(this.logger,Q.LOG_MICRO,"Protocol.send()","sending msg; "+f8(q.message,this.transport.connectionManager.realtime._RealtimePresence,this.transport.connectionManager.realtime._Annotations,this.transport.connectionManager.realtime._objectsPlugin));q.sendAttempted=!0,this.transport.send(q.message)}getTransport(){return this.transport}getPendingMessages(){return this.messageQueue.copyAll()}clearPendingMessages(){return this.messageQueue.clear()}finish(){let q=this.transport;this.onceIdle(function(){q.disconnect()})}},t4=d4,f4=class{constructor(q,$,w,Z){if(this.previous=q,this.current=$,w)this.retryIn=w;if(Z)this.reason=Z}},rq=f4,$1={DISCONNECTED:80003,SUSPENDED:80002,FAILED:80000,CLOSING:80017,CLOSED:80017,UNKNOWN_CONNECTION_ERR:50002,UNKNOWN_CHANNEL_ERR:50001},m4={disconnected:()=>D.fromValues({statusCode:400,code:$1.DISCONNECTED,message:"Connection to server temporarily unavailable"}),suspended:()=>D.fromValues({statusCode:400,code:$1.SUSPENDED,message:"Connection to server unavailable"}),failed:()=>D.fromValues({statusCode:400,code:$1.FAILED,message:"Connection failed or disconnected by server"}),closing:()=>D.fromValues({statusCode:400,code:$1.CLOSING,message:"Connection closing"}),closed:()=>D.fromValues({statusCode:400,code:$1.CLOSED,message:"Connection closed"}),unknownConnectionErr:()=>D.fromValues({statusCode:500,code:$1.UNKNOWN_CONNECTION_ERR,message:"Internal connection error"}),unknownChannelErr:()=>D.fromValues({statusCode:500,code:$1.UNKNOWN_CONNECTION_ERR,message:"Internal channel error"})};function o4(q){if(!q.statusCode||!q.code||q.statusCode>=500)return!0;return Object.values($1).includes(q.code)}var V1=m4,l4=R0({action:C.CLOSE}),r4=R0({action:C.DISCONNECT}),a4=class extends V0{constructor(q,$,w,Z){super(q.logger);if(Z)w.format=void 0,w.heartbeats=!0;this.connectionManager=q,this.auth=$,this.params=w,this.timeouts=w.options.timeouts,this.format=w.format,this.isConnected=!1,this.isFinished=!1,this.isDisposed=!1,this.maxIdleInterval=null,this.idleTimer=null,this.lastActivity=null}connect(){}close(){if(this.isConnected)this.requestClose();this.finish("closed",V1.closed())}disconnect(q){if(this.isConnected)this.requestDisconnect();this.finish("disconnected",q||V1.disconnected())}fail(q){if(this.isConnected)this.requestDisconnect();this.finish("failed",q||V1.failed())}finish(q,$){var w;if(this.isFinished)return;this.isFinished=!0,this.isConnected=!1,this.maxIdleInterval=null,clearTimeout((w=this.idleTimer)!=null?w:void 0),this.idleTimer=null,this.emit(q,$),this.dispose()}onProtocolMessage(q){if(this.logger.shouldLog(Q.LOG_MICRO))Q.logActionNoStrip(this.logger,Q.LOG_MICRO,"Transport.onProtocolMessage()","received on "+this.shortName+": "+f8(q,this.connectionManager.realtime._RealtimePresence,this.connectionManager.realtime._Annotations,this.connectionManager.realtime._objectsPlugin)+"; connectionId = "+this.connectionManager.connectionId);switch(this.onActivity(),q.action){case C.HEARTBEAT:Q.logActionNoStrip(this.logger,Q.LOG_MICRO,"Transport.onProtocolMessage()",this.shortName+" heartbeat; connectionId = "+this.connectionManager.connectionId),this.emit("heartbeat",q.id);break;case C.CONNECTED:this.onConnect(q),this.emit("connected",q.error,q.connectionId,q.connectionDetails,q);break;case C.CLOSED:this.onClose(q);break;case C.DISCONNECTED:this.onDisconnect(q);break;case C.ACK:this.emit("ack",q.msgSerial,q.count);break;case C.NACK:this.emit("nack",q.msgSerial,q.count,q.error);break;case C.SYNC:this.connectionManager.onChannelMessage(q,this);break;case C.ACTIVATE:break;case C.AUTH:j0(this.auth.authorize(),($)=>{if($)Q.logAction(this.logger,Q.LOG_ERROR,"Transport.onProtocolMessage()","Ably requested re-authentication, but unable to obtain a new token: "+W0($))});break;case C.ERROR:if(Q.logAction(this.logger,Q.LOG_MINOR,"Transport.onProtocolMessage()","received error action; connectionId = "+this.connectionManager.connectionId+"; err = "+B.Config.inspect(q.error)+(q.channel?", channel: "+q.channel:"")),q.channel===void 0){this.onFatalError(q);break}this.connectionManager.onChannelMessage(q,this);break;default:this.connectionManager.onChannelMessage(q,this)}}onConnect(q){if(this.isConnected=!0,!q.connectionDetails)throw Error("Transport.onConnect(): Connect message recieved without connectionDetails");let $=q.connectionDetails.maxIdleInterval;if($)this.maxIdleInterval=$+this.timeouts.realtimeRequestTimeout,this.onActivity()}onDisconnect(q){let $=q&&q.error;Q.logAction(this.logger,Q.LOG_MINOR,"Transport.onDisconnect()","err = "+W0($)),this.finish("disconnected",$)}onFatalError(q){let $=q&&q.error;Q.logAction(this.logger,Q.LOG_MINOR,"Transport.onFatalError()","err = "+W0($)),this.finish("failed",$)}onClose(q){let $=q&&q.error;Q.logAction(this.logger,Q.LOG_MINOR,"Transport.onClose()","err = "+W0($)),this.finish("closed",$)}requestClose(){Q.logAction(this.logger,Q.LOG_MINOR,"Transport.requestClose()",""),this.send(l4)}requestDisconnect(){Q.logAction(this.logger,Q.LOG_MINOR,"Transport.requestDisconnect()",""),this.send(r4)}ping(q){let $={action:C.HEARTBEAT};if(q)$.id=q;this.send(R0($))}dispose(){Q.logAction(this.logger,Q.LOG_MINOR,"Transport.dispose()",""),this.isDisposed=!0,this.off()}onActivity(){if(!this.maxIdleInterval)return;this.lastActivity=this.connectionManager.lastActivity=Date.now(),this.setIdleTimer(this.maxIdleInterval+100)}setIdleTimer(q){if(!this.idleTimer)this.idleTimer=setTimeout(()=>{this.onIdleTimerExpire()},q)}onIdleTimerExpire(){if(!this.lastActivity||!this.maxIdleInterval)throw Error("Transport.onIdleTimerExpire(): lastActivity/maxIdleInterval not set");this.idleTimer=null;let q=Date.now()-this.lastActivity,$=this.maxIdleInterval-q;if($<=0){let w="No activity seen from realtime in "+q+"ms; assuming connection has dropped";Q.logAction(this.logger,Q.LOG_ERROR,"Transport.onIdleTimerExpire()",w),this.disconnect(new D(w,80003,408))}else this.setIdleTimer($+100)}static tryConnect(q,$,w,Z,G){let X=new q($,w,Z),U,O=function(z){clearTimeout(U),G({event:this.event,error:z})},F=$.options.timeouts.realtimeRequestTimeout;return U=setTimeout(()=>{X.off(["preconnect","disconnected","failed"]),X.dispose(),O.call({event:"disconnected"},new D("Timeout waiting for transport to indicate itself viable",50000,500))},F),X.on(["failed","disconnected"],O),X.on("preconnect",function(){Q.logAction($.logger,Q.LOG_MINOR,"Transport.tryConnect()","viable transport "+X),clearTimeout(U),X.off(["failed","disconnected"],O),G(null,X)}),X.connect(),X}static isAvailable(){throw new D("isAvailable not implemented for transport",50000,500)}},_1=a4,M0;((q)=>{q.WebSocket="web_socket",q.Comet="comet",q.XhrPolling="xhr_polling"})(M0||(M0={}));var s4=typeof global<"u"?global:typeof window<"u"?window:self,a8=()=>{var q;return typeof B.WebStorage<"u"&&((q=B.WebStorage)==null?void 0:q.localSupported)},$q=()=>{var q;return typeof B.WebStorage<"u"&&((q=B.WebStorage)==null?void 0:q.sessionSupported)},P7=function(){},s8="ably-transport-preference";function e4(q,$,w){let Z;if(q.channel!==$.channel)return!1;if((Z=q.action)!==C.PRESENCE&&Z!==C.MESSAGE)return!1;if(Z!==$.action)return!1;let G=Z===C.PRESENCE?"presence":"messages",X=q[G].concat($[G]);if(d8(X)>w)return!1;if(!B$(X,"clientId"))return!1;if(!X.every(function(O){return!O.id}))return!1;return q[G]=X,!0}function e8(q){try{return JSON.parse(q)}catch($){return null}}var q2=class{constructor(q,$,w,Z){this.options=q,this.host=$,this.mode=w,this.connectionKey=Z,this.format=q.useBinaryProtocol?"msgpack":"json"}getConnectParams(q){let $=q?Y1(q):{},w=this.options;switch(this.mode){case"resume":$.resume=this.connectionKey;break;case"recover":{let Z=e8(w.recover);if(Z)$.recover=Z.connectionKey;break}default:}if(w.clientId!==void 0)$.clientId=w.clientId;if(w.echoMessages===!1)$.echo="false";if(this.format!==void 0)$.format=this.format;if(this.stream!==void 0)$.stream=this.stream;if(this.heartbeats!==void 0)$.heartbeats=this.heartbeats;if($.v=k.protocolVersion,$.agent=C8(this.options),w.transportParams!==void 0)y($,w.transportParams);return $}toString(){let q="[mode="+this.mode;if(this.host)q+=",host="+this.host;if(this.connectionKey)q+=",connectionKey="+this.connectionKey;if(this.format)q+=",format="+this.format;return q+="]",q}},$2=class q extends V0{constructor($,w){super($.logger);this.supportedTransports={},this.disconnectedRetryCount=0,this.pendingChannelMessagesState={isProcessing:!1,queue:[]},this.realtime=$,this.initTransports(),this.options=w;let Z=w.timeouts,G=Z.webSocketConnectTimeout+Z.realtimeRequestTimeout;if(this.states={initialized:{state:"initialized",terminal:!1,queueEvents:!0,sendEvents:!1,failState:"disconnected"},connecting:{state:"connecting",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:G,failState:"disconnected"},connected:{state:"connected",terminal:!1,queueEvents:!1,sendEvents:!0,failState:"disconnected"},disconnected:{state:"disconnected",terminal:!1,queueEvents:!0,sendEvents:!1,retryDelay:Z.disconnectedRetryTimeout,failState:"disconnected"},suspended:{state:"suspended",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:Z.suspendedRetryTimeout,failState:"suspended"},closing:{state:"closing",terminal:!1,queueEvents:!1,sendEvents:!1,retryDelay:Z.realtimeRequestTimeout,failState:"closed"},closed:{state:"closed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"closed"},failed:{state:"failed",terminal:!0,queueEvents:!1,sendEvents:!1,failState:"failed"}},this.state=this.states.initialized,this.errorReason=null,this.queuedMessages=new c7(this.logger),this.msgSerial=0,this.connectionDetails=void 0,this.connectionId=void 0,this.connectionKey=void 0,this.connectionStateTtl=Z.connectionStateTtl,this.maxIdleInterval=null,this.transports=O$(w.transports||k.defaultTransports,this.supportedTransports),this.transportPreference=null,this.transports.includes(M0.WebSocket))this.webSocketTransportAvailable=!0;if(this.transports.includes(M0.XhrPolling))this.baseTransport=M0.XhrPolling;else if(this.transports.includes(M0.Comet))this.baseTransport=M0.Comet;if(this.domains=k.getHosts(w),this.activeProtocol=null,this.host=null,this.lastAutoReconnectAttempt=null,this.lastActivity=null,this.forceFallbackHost=!1,this.connectCounter=0,this.wsCheckResult=null,this.webSocketSlowTimer=null,this.webSocketGiveUpTimer=null,this.abandonedWebSocket=!1,Q.logAction(this.logger,Q.LOG_MINOR,"Realtime.ConnectionManager()","started"),Q.logAction(this.logger,Q.LOG_MICRO,"Realtime.ConnectionManager()","requested transports = ["+(w.transports||k.defaultTransports)+"]"),Q.logAction(this.logger,Q.LOG_MICRO,"Realtime.ConnectionManager()","available transports = ["+this.transports+"]"),Q.logAction(this.logger,Q.LOG_MICRO,"Realtime.ConnectionManager()","http domains = ["+this.domains+"]"),!this.transports.length)throw Q.logAction(this.logger,Q.LOG_ERROR,"realtime.ConnectionManager()","no requested transports available"),Error("no requested transports available");let X=B.Config.addEventListener;if(X){if($q()&&typeof w.recover==="function")X("beforeunload",this.persistConnection.bind(this));if(w.closeOnUnload===!0)X("beforeunload",()=>{Q.logAction(this.logger,Q.LOG_MAJOR,"Realtime.ConnectionManager()","beforeunload event has triggered the connection to close as closeOnUnload is true"),this.requestState({state:"closing"})});X("online",()=>{var U;if(this.state==this.states.disconnected||this.state==this.states.suspended)Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager caught browser ‘online’ event","reattempting connection"),this.requestState({state:"connecting"});else if(this.state==this.states.connecting)(U=this.pendingTransport)==null||U.off(),this.disconnectAllTransports(),this.startConnect()}),X("offline",()=>{if(this.state==this.states.connected)Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager caught browser ‘offline’ event","disconnecting active transport"),this.disconnectAllTransports()})}}static supportedTransports($){let w={supportedTransports:{}};return this.initTransports($,w),w.supportedTransports}static initTransports($,w){let Z=_(_({},B.Transports.bundledImplementations),$);[M0.WebSocket,...B.Transports.order].forEach((G)=>{let X=Z[G];if(X&&X.isAvailable())w.supportedTransports[G]=X})}initTransports(){q.initTransports(this.realtime._additionalTransportImplementations,this)}createTransportParams($,w){return new q2(this.options,$,w,this.connectionKey)}getTransportParams($){((Z)=>{if(this.connectionKey){Z("resume");return}if(typeof this.options.recover==="string"){Z("recover");return}let G=this.options.recover,X=this.getSessionRecoverData(),U=this.sessionRecoveryName();if(X&&typeof G==="function"){Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.getTransportParams()","Calling clientOptions-provided recover function with last session data (recovery scope: "+U+")"),G(X,(O)=>{if(O)this.options.recover=X.recoveryKey,Z("recover");else Z("clean")});return}Z("clean")})((Z)=>{let G=this.createTransportParams(null,Z);if(Z==="recover"){Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport recovery mode = recover; recoveryKey = "+this.options.recover);let X=e8(this.options.recover);if(X)this.msgSerial=X.msgSerial}else Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.getTransportParams()","Transport params = "+G.toString());$(G)})}tryATransport($,w,Z){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.tryATransport()","trying "+w),this.proposedTransport=_1.tryConnect(this.supportedTransports[w],this,this.realtime.auth,$,(G,X)=>{let U=this.state;if(U==this.states.closing||U==this.states.closed||U==this.states.failed){if(X)Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.tryATransport()","connection "+U.state+" while we were attempting the transport; closing "+X),X.close();Z(!0);return}if(G){if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.tryATransport()","transport "+w+" "+G.event+", err: "+G.error.toString()),t0.isTokenErr(G.error)&&!(this.errorReason&&t0.isTokenErr(this.errorReason)))this.errorReason=G.error,j0(this.realtime.auth._forceNewToken(null,null),(O)=>{if(O){this.actOnErrorFromAuthorize(O);return}this.tryATransport($,w,Z)});else if(G.event==="failed")this.notifyState({state:"failed",error:G.error}),Z(!0);else if(G.event==="disconnected")if(!o4(G.error))this.notifyState({state:this.states.connecting.failState,error:G.error}),Z(!0);else Z(!1);return}Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.tryATransport()","viable transport "+w+"; setting pending"),this.setTransportPending(X,$),Z(null,X)})}setTransportPending($,w){let Z=w.mode;Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.setTransportPending()","transport = "+$+"; mode = "+Z),this.pendingTransport=$,this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),$.once("connected",(X,U,O)=>{if(this.activateTransport(X,$,U,O),Z==="recover"&&this.options.recover)delete this.options.recover,this.unpersistConnection()});let G=this;$.on(["disconnected","closed","failed"],function(X){G.deactivateTransport($,this.event,X)}),this.emit("transport.pending",$)}activateTransport($,w,Z,G){if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.activateTransport()","transport = "+w),$)Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.activateTransport()","error = "+$);if(Z)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.activateTransport()","connectionId =  "+Z);if(G)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.activateTransport()","connectionDetails =  "+JSON.stringify(G));this.persistTransportPreference(w);let X=this.state,U=this.states.connected.state;if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.activateTransport()","current state = "+X.state),X.state==this.states.closing.state||X.state==this.states.closed.state||X.state==this.states.failed.state)return Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.activateTransport()","Disconnecting transport and abandoning"),w.disconnect(),!1;if(delete this.pendingTransport,!w.isConnected)return Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.activateTransport()","Declining to activate transport "+w+" since it appears to no longer be connected"),!1;let O=this.activeProtocol;this.activeProtocol=new t4(w),this.host=w.params.host;let F=G.connectionKey;if(F&&this.connectionKey!=F)this.setConnection(Z,G,!!$);if(this.onConnectionDetailsUpdate(G,w),B.Config.nextTick(()=>{w.on("connected",(z,I,j)=>{this.onConnectionDetailsUpdate(j,w),this.emit("update",new rq(U,U,null,z))})}),X.state===this.states.connected.state){if($)this.errorReason=this.realtime.connection.errorReason=$,this.emit("update",new rq(U,U,null,$))}else this.notifyState({state:"connected",error:$}),this.errorReason=this.realtime.connection.errorReason=$||null;if(this.emit("transport.active",w),O){if(O.messageQueue.count()>0)Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.activateTransport()","Previous active protocol (for transport "+O.transport.shortName+", new one is "+w.shortName+") finishing with "+O.messageQueue.count()+" messages still pending");if(O.transport===w){let z="Assumption violated: activating a transport that was also the transport for the previous active protocol; transport = "+w.shortName+"; stack = "+Error().stack;Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.activateTransport()",z)}else O.finish()}return!0}deactivateTransport($,w,Z){let G=this.activeProtocol,X=G&&G.getTransport()===$,U=$===this.pendingTransport,O=this.noTransportsScheduledForActivation();if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.deactivateTransport()","transport = "+$),Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.deactivateTransport()","state = "+w+(X?"; was active":U?"; was pending":"")+(O?"":"; another transport is scheduled for activation")),Z&&Z.message)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.deactivateTransport()","reason =  "+Z.message);if(X)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.deactivateTransport()","Getting, clearing, and requeuing "+this.activeProtocol.messageQueue.count()+" pending messages"),this.queuePendingMessages(G.getPendingMessages()),G.clearPendingMessages(),this.activeProtocol=this.host=null;if(this.emit("transport.inactive",$),X&&O||X&&w==="failed"||w==="closed"||G===null&&U){if(w==="disconnected"&&Z&&Z.statusCode>500&&this.domains.length>1){this.unpersistTransportPreference(),this.forceFallbackHost=!0,this.notifyState({state:w,error:Z,retryImmediately:!0});return}let F=w==="failed"&&t0.isTokenErr(Z)?"disconnected":w;this.notifyState({state:F,error:Z});return}}noTransportsScheduledForActivation(){return!this.pendingTransport||!this.pendingTransport.isConnected}setConnection($,w,Z){let G=this.connectionId;if(G&&G!==$||!G&&Z)Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.setConnection()","Resetting msgSerial"),this.msgSerial=0,this.queuedMessages.resetSendAttempted();if(this.connectionId!==$)Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.setConnection()","New connectionId; reattaching any attached channels");this.realtime.connection.id=this.connectionId=$,this.realtime.connection.key=this.connectionKey=w.connectionKey}clearConnection(){this.realtime.connection.id=this.connectionId=void 0,this.realtime.connection.key=this.connectionKey=void 0,this.msgSerial=0,this.unpersistConnection()}createRecoveryKey(){if(!this.connectionKey)return null;return JSON.stringify({connectionKey:this.connectionKey,msgSerial:this.msgSerial,channelSerials:this.realtime.channels.channelSerials()})}checkConnectionStateFreshness(){if(!this.lastActivity||!this.connectionId)return;let $=Date.now()-this.lastActivity;if($>this.connectionStateTtl+this.maxIdleInterval)Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.checkConnectionStateFreshness()","Last known activity from realtime was "+$+"ms ago; discarding connection state"),this.clearConnection(),this.states.connecting.failState="suspended"}persistConnection(){if($q()){let $=this.createRecoveryKey();if($)this.setSessionRecoverData({recoveryKey:$,disconnectedAt:Date.now(),location:s4.location,clientId:this.realtime.auth.clientId})}}unpersistConnection(){this.clearSessionRecoverData()}getActiveTransportFormat(){var $;return($=this.activeProtocol)==null?void 0:$.getTransport().format}getError(){if(this.errorReason){let $=r.fromValues(this.errorReason);return $.cause=this.errorReason,$}return this.getStateError()}getStateError(){var $,w;return(w=($=V1)[this.state.state])==null?void 0:w.call($)}activeState(){return this.state.queueEvents||this.state.sendEvents}enactStateChange($){let Z=$.current+($.reason?"; reason: "+$.reason:"");if($.current==="failed")Q.logAction(this.logger,Q.LOG_ERROR,"Connection state",Z);else Q.logAction(this.logger,Q.LOG_MAJOR,"Connection state",Z);Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.enactStateChange","setting new state: "+$.current+"; reason = "+($.reason&&$.reason.message));let G=this.state=this.states[$.current];if($.reason)this.errorReason=$.reason,this.realtime.connection.errorReason=$.reason;if(G.terminal||G.state==="suspended")this.clearConnection();this.emit("connectionstate",$)}startTransitionTimer($){if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.startTransitionTimer()","transitionState: "+$.state),this.transitionTimer)Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.startTransitionTimer()","clearing already-running timer"),clearTimeout(this.transitionTimer);this.transitionTimer=setTimeout(()=>{if(this.transitionTimer)this.transitionTimer=null,Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager "+$.state+" timer expired","requesting new state: "+$.failState),this.notifyState({state:$.failState})},$.retryDelay)}cancelTransitionTimer(){if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.cancelTransitionTimer()",""),this.transitionTimer)clearTimeout(this.transitionTimer),this.transitionTimer=null}startSuspendTimer(){if(this.suspendTimer)return;this.suspendTimer=setTimeout(()=>{if(this.suspendTimer)this.suspendTimer=null,Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager suspend timer expired","requesting new state: suspended"),this.states.connecting.failState="suspended",this.notifyState({state:"suspended"})},this.connectionStateTtl)}checkSuspendTimer($){if($!=="disconnected"&&$!=="suspended"&&$!=="connecting")this.cancelSuspendTimer()}cancelSuspendTimer(){if(this.states.connecting.failState="disconnected",this.suspendTimer)clearTimeout(this.suspendTimer),this.suspendTimer=null}startRetryTimer($){this.retryTimer=setTimeout(()=>{Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager retry timer expired","retrying"),this.retryTimer=null,this.requestState({state:"connecting"})},$)}cancelRetryTimer(){if(this.retryTimer)clearTimeout(this.retryTimer),this.retryTimer=null}startWebSocketSlowTimer(){this.webSocketSlowTimer=setTimeout(()=>{if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager WebSocket slow timer","checking connectivity"),this.checkWsConnectivity().then(()=>{Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager WebSocket slow timer","ws connectivity check succeeded"),this.wsCheckResult=!0}).catch(()=>{Q.logAction(this.logger,Q.LOG_MAJOR,"ConnectionManager WebSocket slow timer","ws connectivity check failed"),this.wsCheckResult=!1}),this.realtime.http.checkConnectivity)j0(this.realtime.http.checkConnectivity(),($,w)=>{if($||!w)Q.logAction(this.logger,Q.LOG_MAJOR,"ConnectionManager WebSocket slow timer","http connectivity check failed"),this.cancelWebSocketGiveUpTimer(),this.notifyState({state:"disconnected",error:new D("Unable to connect (network unreachable)",80003,404)});else Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager WebSocket slow timer","http connectivity check succeeded")})},this.options.timeouts.webSocketSlowTimeout)}cancelWebSocketSlowTimer(){if(this.webSocketSlowTimer)clearTimeout(this.webSocketSlowTimer),this.webSocketSlowTimer=null}startWebSocketGiveUpTimer($){this.webSocketGiveUpTimer=setTimeout(()=>{var w,Z;if(!this.wsCheckResult)if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager WebSocket give up timer","websocket connection took more than 10s; "+(this.baseTransport?"trying base transport":"")),this.baseTransport)this.abandonedWebSocket=!0,(w=this.proposedTransport)==null||w.dispose(),(Z=this.pendingTransport)==null||Z.dispose(),this.connectBase($,++this.connectCounter);else Q.logAction(this.logger,Q.LOG_MAJOR,"ConnectionManager WebSocket give up timer","websocket connectivity appears to be unavailable but no other transports to try")},this.options.timeouts.webSocketConnectTimeout)}cancelWebSocketGiveUpTimer(){if(this.webSocketGiveUpTimer)clearTimeout(this.webSocketGiveUpTimer),this.webSocketGiveUpTimer=null}notifyState($){var w,Z;let G=$.state,X=G==="disconnected"&&(this.state===this.states.connected||$.retryImmediately||this.state===this.states.connecting&&$.error&&t0.isTokenErr($.error)&&!(this.errorReason&&t0.isTokenErr(this.errorReason)));if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.notifyState()","new state: "+G+(X?"; will retry connection immediately":"")),G==this.state.state)return;if(this.cancelTransitionTimer(),this.cancelRetryTimer(),this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),this.checkSuspendTimer($.state),G==="suspended"||G==="connected")this.disconnectedRetryCount=0;if(this.state.terminal)return;let U=this.states[$.state],O=U.retryDelay;if(U.state==="disconnected")this.disconnectedRetryCount++,O=E8(U.retryDelay,this.disconnectedRetryCount);let F=new rq(this.state.state,U.state,O,$.error||((Z=(w=V1)[U.state])==null?void 0:Z.call(w)));if(X){let z=()=>{if(this.state===this.states.disconnected)this.lastAutoReconnectAttempt=Date.now(),this.requestState({state:"connecting"})},I=this.lastAutoReconnectAttempt&&Date.now()-this.lastAutoReconnectAttempt+1;if(I&&I<1000)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.notifyState()","Last reconnect attempt was only "+I+"ms ago, waiting another "+(1000-I)+"ms before trying again"),setTimeout(z,1000-I);else B.Config.nextTick(z)}else if(G==="disconnected"||G==="suspended")this.startRetryTimer(O);if(G==="disconnected"&&!X||G==="suspended"||U.terminal)B.Config.nextTick(()=>{this.disconnectAllTransports()});if(G=="connected"&&!this.activeProtocol)Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.notifyState()","Broken invariant: attempted to go into connected state, but there is no active protocol");if(this.enactStateChange(F),this.state.sendEvents)this.sendQueuedMessages();else if(!this.state.queueEvents)this.realtime.channels.propogateConnectionInterruption(G,F.reason),this.failQueuedMessages(F.reason)}requestState($){var w,Z;let G=$.state;if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.requestState()","requested state: "+G+"; current state: "+this.state.state),G==this.state.state)return;if(this.cancelWebSocketSlowTimer(),this.cancelWebSocketGiveUpTimer(),this.cancelTransitionTimer(),this.cancelRetryTimer(),this.checkSuspendTimer(G),G=="connecting"&&this.state.state=="connected")return;if(G=="closing"&&this.state.state=="closed")return;let X=this.states[G],U=new rq(this.state.state,X.state,null,$.error||((Z=(w=V1)[X.state])==null?void 0:Z.call(w)));if(this.enactStateChange(U),G=="connecting")B.Config.nextTick(()=>{this.startConnect()});if(G=="closing")this.closeImpl()}startConnect(){if(this.state!==this.states.connecting){Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.startConnect()","Must be in connecting state to connect, but was "+this.state.state);return}let $=this.realtime.auth,w=++this.connectCounter,Z=()=>{this.checkConnectionStateFreshness(),this.getTransportParams((G)=>{if(G.mode==="recover"&&G.options.recover){let X=e8(G.options.recover);if(X)this.realtime.channels.recoverChannels(X.channelSerials)}if(w!==this.connectCounter)return;this.connectImpl(G,w)})};if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.startConnect()","starting connection"),this.startSuspendTimer(),this.startTransitionTimer(this.states.connecting),$.method==="basic")Z();else{let G=(X)=>{if(w!==this.connectCounter)return;if(X)this.actOnErrorFromAuthorize(X);else Z()};if(this.errorReason&&t0.isTokenErr(this.errorReason))j0($._forceNewToken(null,null),G);else j0($._ensureValidAuthCredentials(!1),G)}}connectImpl($,w){let Z=this.state.state;if(Z!==this.states.connecting.state){Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.connectImpl()","Must be in connecting state to connect, but was "+Z);return}let G=this.getTransportPreference();if(G&&G===this.baseTransport&&this.webSocketTransportAvailable)this.checkWsConnectivity().then(()=>{if(this.unpersistTransportPreference(),this.state===this.states.connecting)Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.connectImpl():","web socket connectivity available, cancelling connection attempt with "+this.baseTransport),this.disconnectAllTransports(),this.connectWs($,++this.connectCounter)}).catch(P7);if(G&&G===this.baseTransport||this.baseTransport&&!this.webSocketTransportAvailable)this.connectBase($,w);else this.connectWs($,w)}connectWs($,w){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.connectWs()"),this.wsCheckResult=null,this.abandonedWebSocket=!1,this.startWebSocketSlowTimer(),this.startWebSocketGiveUpTimer($),this.tryTransportWithFallbacks("web_socket",$,!0,w,()=>{return this.wsCheckResult!==!1&&!this.abandonedWebSocket})}connectBase($,w){if(Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.connectBase()"),this.baseTransport)this.tryTransportWithFallbacks(this.baseTransport,$,!1,w,()=>!0);else this.notifyState({state:"disconnected",error:new D("No transports left to try",80000,404)})}tryTransportWithFallbacks($,w,Z,G,X){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.tryTransportWithFallbacks()",$);let U=(j)=>{this.notifyState({state:this.states.connecting.failState,error:j})},O=this.domains.slice(),F=(j,A)=>{if(G!==this.connectCounter)return;if(!X()){if(A)A.dispose();return}if(!A&&!j)I()},z=O.shift();if(!z){U(new D("Unable to connect (no available host)",80003,404));return}w.host=z;let I=()=>{if(!O.length){U(new D("Unable to connect (and no more fallback hosts to try)",80003,404));return}if(!this.realtime.http.checkConnectivity){U(new r("Internal error: Http.checkConnectivity not set",null,500));return}j0(this.realtime.http.checkConnectivity(),(j,A)=>{if(G!==this.connectCounter)return;if(!X())return;if(j){U(j);return}if(!A){U(new D("Unable to connect (network unreachable)",80003,404));return}w.host=b8(O),this.tryATransport(w,$,F)})};if(this.forceFallbackHost&&O.length){this.forceFallbackHost=!1,I();return}this.tryATransport(w,$,F)}closeImpl(){if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.closeImpl()","closing connection"),this.cancelSuspendTimer(),this.startTransitionTimer(this.states.closing),this.pendingTransport)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.closeImpl()","Closing pending transport: "+this.pendingTransport),this.pendingTransport.close();if(this.activeProtocol)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.closeImpl()","Closing active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().close();this.notifyState({state:"closed"})}onAuthUpdated($,w){var Z;switch(this.state.state){case"connected":{Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Sending AUTH message on active transport");let G=(Z=this.activeProtocol)==null?void 0:Z.getTransport();if(G&&G.onAuthUpdated)G.onAuthUpdated($);let X=R0({action:C.AUTH,auth:{accessToken:$.token}});this.send(X);let U=()=>{this.off(O),w(null,$)},O=(F)=>{if(F.current==="failed")this.off(U),this.off(O),w(F.reason||this.getStateError())};this.once("connectiondetails",U),this.on("connectionstate",O);break}case"connecting":Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Aborting current connection attempts in order to start again with the new auth details"),this.disconnectAllTransports();default:{Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.onAuthUpdated()","Connection state is "+this.state.state+"; waiting until either connected or failed");let G=(X)=>{switch(X.current){case"connected":this.off(G),w(null,$);break;case"failed":case"closed":case"suspended":this.off(G),w(X.reason||this.getStateError());break;default:break}};if(this.on("connectionstate",G),this.state.state==="connecting")this.startConnect();else this.requestState({state:"connecting"})}}}disconnectAllTransports(){if(Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.disconnectAllTransports()","Disconnecting all transports"),this.connectCounter++,this.pendingTransport)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting pending transport: "+this.pendingTransport),this.pendingTransport.disconnect();if(delete this.pendingTransport,this.proposedTransport)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting proposed transport: "+this.pendingTransport),this.proposedTransport.disconnect();if(delete this.pendingTransport,this.activeProtocol)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.disconnectAllTransports()","Disconnecting active transport: "+this.activeProtocol.getTransport()),this.activeProtocol.getTransport().disconnect()}send($,w,Z){Z=Z||P7;let G=this.state;if(G.sendEvents){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.send()","sending event"),this.sendImpl(new E7($,Z));return}if(!(w&&G.queueEvents)){let U="rejecting event, queueEvent was "+w+", state was "+G.state;Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.send()",U),Z(this.errorReason||new D(U,90000,400));return}if(this.logger.shouldLog(Q.LOG_MICRO))Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.send()","queueing msg; "+f8($,this.realtime._RealtimePresence,this.realtime._Annotations,this.realtime._objectsPlugin));this.queue($,Z)}sendImpl($){let w=$.message;if($.ackRequired&&!$.sendAttempted)w.msgSerial=this.msgSerial++;try{this.activeProtocol.send($)}catch(Z){Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.sendImpl()","Unexpected exception in transport.send(): "+Z.stack)}}queue($,w){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.queue()","queueing event");let Z=this.queuedMessages.last(),G=this.options.maxMessageSize;if(Z&&!Z.sendAttempted&&e4(Z.message,$,G)){if(!Z.merged)Z.callback=k8.create(this.logger,[Z.callback]),Z.merged=!0;Z.callback.push(w)}else this.queuedMessages.push(new E7($,w))}sendQueuedMessages(){Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.sendQueuedMessages()","sending "+this.queuedMessages.count()+" queued messages");let $;while($=this.queuedMessages.shift())this.sendImpl($)}queuePendingMessages($){if($&&$.length)Q.logAction(this.logger,Q.LOG_MICRO,"ConnectionManager.queuePendingMessages()","queueing "+$.length+" pending messages"),this.queuedMessages.prepend($)}failQueuedMessages($){let w=this.queuedMessages.count();if(w>0)Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.failQueuedMessages()","failing "+w+" queued messages, err = "+W0($)),this.queuedMessages.completeAllMessages($)}onChannelMessage($,w){if(this.pendingChannelMessagesState.queue.push({message:$,transport:w}),!this.pendingChannelMessagesState.isProcessing)this.processNextPendingChannelMessage()}processNextPendingChannelMessage(){if(this.pendingChannelMessagesState.queue.length>0){this.pendingChannelMessagesState.isProcessing=!0;let $=this.pendingChannelMessagesState.queue.shift();this.processChannelMessage($.message).catch((w)=>{Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.processNextPendingChannelMessage() received error ",w)}).finally(()=>{this.pendingChannelMessagesState.isProcessing=!1,this.processNextPendingChannelMessage()})}}async processChannelMessage($){await this.realtime.channels.processChannelMessage($)}async ping(){var $;if(this.state.state!=="connected")throw new D("Unable to ping service; not connected",40000,400);let w=($=this.activeProtocol)==null?void 0:$.getTransport();if(!w)throw this.getStateError();Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.ping()","transport = "+w);let Z=Date.now(),G=gq();return c$(new Promise((X)=>{let U=(O)=>{if(O===G)w.off("heartbeat",U),X(Date.now()-Z)};w.on("heartbeat",U),w.ping(G)}),this.options.timeouts.realtimeRequestTimeout,"Timeout waiting for heartbeat response")}abort($){this.activeProtocol.getTransport().fail($)}getTransportPreference(){var $,w;return this.transportPreference||a8()&&((w=($=B.WebStorage)==null?void 0:$.get)==null?void 0:w.call($,s8))}persistTransportPreference($){var w,Z;if(this.transportPreference=$.shortName,a8())(Z=(w=B.WebStorage)==null?void 0:w.set)==null||Z.call(w,s8,$.shortName)}unpersistTransportPreference(){var $,w;if(this.transportPreference=null,a8())(w=($=B.WebStorage)==null?void 0:$.remove)==null||w.call($,s8)}actOnErrorFromAuthorize($){if($.code===40171)this.notifyState({state:"failed",error:$});else if($.code===40102)this.notifyState({state:"failed",error:$});else if($.statusCode===dq.Forbidden)Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.actOnErrorFromAuthorize()","Client configured authentication provider returned 403; failing the connection"),this.notifyState({state:"failed",error:new D("Client configured authentication provider returned 403; failing the connection",80019,403,$)});else Q.logAction(this.logger,Q.LOG_MINOR,"ConnectionManager.actOnErrorFromAuthorize","Client configured authentication provider request failed"),this.notifyState({state:this.state.failState,error:new D("Client configured authentication provider request failed",80019,401,$)})}onConnectionDetailsUpdate($,w){if(!$)return;if(this.connectionDetails=$,$.maxMessageSize)this.options.maxMessageSize=$.maxMessageSize;let Z=$.clientId;if(Z){let X=this.realtime.auth._uncheckedSetClientId(Z);if(X){Q.logAction(this.logger,Q.LOG_ERROR,"ConnectionManager.onConnectionDetailsUpdate()",X.message),w.fail(X);return}}let G=$.connectionStateTtl;if(G)this.connectionStateTtl=G;this.maxIdleInterval=$.maxIdleInterval,this.emit("connectiondetails",$)}checkWsConnectivity(){let $=this.options.wsConnectivityCheckUrl||k.wsConnectivityCheckUrl,w=new B.Config.WebSocket($);return new Promise((Z,G)=>{let X=!1;w.onopen=()=>{if(!X)X=!0,Z(),w.close()},w.onclose=w.onerror=()=>{if(!X)X=!0,G()}})}sessionRecoveryName(){return this.options.recoveryKeyStorageName||"ably-connection-recovery"}getSessionRecoverData(){var $,w;return $q()&&((w=($=B.WebStorage)==null?void 0:$.getSession)==null?void 0:w.call($,this.sessionRecoveryName()))}setSessionRecoverData($){var w,Z;return $q()&&((Z=(w=B.WebStorage)==null?void 0:w.setSession)==null?void 0:Z.call(w,this.sessionRecoveryName(),$))}clearSessionRecoverData(){var $,w;return $q()&&((w=($=B.WebStorage)==null?void 0:$.removeSession)==null?void 0:w.call($,this.sessionRecoveryName()))}},C7=$2,w2=class extends V0{constructor(q,$){super(q.logger);this.whenState=(w)=>{return V0.prototype.whenState.call(this,w,this.state)},this.ably=q,this.connectionManager=new C7(q,$),this.state=this.connectionManager.state.state,this.key=void 0,this.id=void 0,this.errorReason=null,this.connectionManager.on("connectionstate",(w)=>{let Z=this.state=w.current;B.Config.nextTick(()=>{this.emit(Z,w)})}),this.connectionManager.on("update",(w)=>{B.Config.nextTick(()=>{this.emit("update",w)})})}connect(){Q.logAction(this.logger,Q.LOG_MINOR,"Connection.connect()",""),this.connectionManager.requestState({state:"connecting"})}async ping(){return Q.logAction(this.logger,Q.LOG_MINOR,"Connection.ping()",""),this.connectionManager.ping()}close(){Q.logAction(this.logger,Q.LOG_MINOR,"Connection.close()","connectionKey = "+this.key),this.connectionManager.requestState({state:"closing"})}get recoveryKey(){return this.logger.deprecationWarning("The `Connection.recoveryKey` attribute has been replaced by the `Connection.createRecoveryKey()` method. Replace your usage of `recoveryKey` with the return value of `createRecoveryKey()`. `recoveryKey` will be removed in a future version."),this.createRecoveryKey()}createRecoveryKey(){return this.connectionManager.createRecoveryKey()}},u2=w2,k7=class q extends w7{constructor($){var w,Z,G,X;super(k.objectifyOptions($,!1,"BaseRealtime",Q.defaultLogger));if(Q.logAction(this.logger,Q.LOG_MINOR,"Realtime()",""),typeof EdgeRuntime==="string")throw new D(`Ably.Realtime instance cannot be used in Vercel Edge runtime. If you are running Vercel Edge functions, please replace your "new Ably.Realtime()" with "new Ably.Rest()" and use Ably Rest API instead of the Realtime API. If you are server-rendering your application in the Vercel Edge runtime, please use the condition "if (typeof EdgeRuntime === 'string')" to prevent instantiating Ably.Realtime instance during SSR in the Vercel Edge runtime.`,40000,400);if(this._additionalTransportImplementations=q.transportImplementationsFromPlugins(this.options.plugins),this._RealtimePresence=(Z=(w=this.options.plugins)==null?void 0:w.RealtimePresence)!=null?Z:null,this._objectsPlugin=(X=(G=this.options.plugins)==null?void 0:G.Objects)!=null?X:null,this.connection=new u2(this,this.options),this._channels=new Z2(this),this.options.autoConnect!==!1)this.connect()}static transportImplementationsFromPlugins($){let w={};if($==null?void 0:$.WebSocketTransport)w[M0.WebSocket]=$.WebSocketTransport;if($==null?void 0:$.XHRPolling)w[M0.XhrPolling]=$.XHRPolling;return w}get channels(){return this._channels}get clientId(){return this.auth.clientId}connect(){Q.logAction(this.logger,Q.LOG_MINOR,"Realtime.connect()",""),this.connection.connect()}close(){Q.logAction(this.logger,Q.LOG_MINOR,"Realtime.close()",""),this.connection.close()}};k7.EventEmitter=V0;var W2=k7,Z2=class extends V0{constructor(q){super(q.logger);this.realtime=q,this.all=Object.create(null),q.connection.connectionManager.on("transport.active",()=>{this.onTransportActive()})}channelSerials(){let q={};for(let $ of r1(this.all,!0)){let w=this.all[$];if(w.properties.channelSerial)q[$]=w.properties.channelSerial}return q}recoverChannels(q){for(let $ of r1(q,!0)){let w=this.get($);w.properties.channelSerial=q[$]}}async processChannelMessage(q){let $=q.channel;if($===void 0){Q.logAction(this.logger,Q.LOG_ERROR,"Channels.processChannelMessage()","received event unspecified channel, action = "+q.action);return}let w=this.all[$];if(!w){Q.logAction(this.logger,Q.LOG_ERROR,"Channels.processChannelMessage()","received event for non-existent channel: "+$);return}await w.processMessage(q)}onTransportActive(){for(let q in this.all){let $=this.all[q];if($.state==="attaching"||$.state==="detaching")$.checkPendingState();else if($.state==="suspended")$._attach(!1,null);else if($.state==="attached")$.requestState("attaching")}}propogateConnectionInterruption(q,$){let w={closing:"detached",closed:"detached",failed:"failed",suspended:"suspended"},Z=["attaching","attached","detaching","suspended"],G=w[q];for(let X in this.all){let U=this.all[X];if(Z.includes(U.state))U.notifyState(G,$)}}get(q,$){q=String(q);let w=this.all[q];if(!w)w=this.all[q]=new qq(this.realtime,q,$);else if($){if(w._shouldReattachToSetOptions($,w.channelOptions))throw new D("Channels.get() cannot be used to set channel options that would cause the channel to reattach. Please, use RealtimeChannel.setOptions() instead.",40000,400);w.setOptions($)}return w}getDerived(q,$,w){if($.filter){let Z=pq($.filter),G=b$(q);q=`[filter=${Z}${G.qualifierParam}]${G.channelName}`}return this.get(q,w)}release(q){q=String(q);let $=this.all[q];if(!$)return;let w=$.getReleaseErr();if(w)throw w;delete this.all[q]}},G2=W2;function J2(q,$){if(q.isSynthesized()||$.isSynthesized())return q.timestamp>=$.timestamp;let w=q.parseId(),Z=$.parseId();if(w.msgSerial===Z.msgSerial)return w.index>Z.index;else return w.msgSerial>Z.msgSerial}var q5=class extends V0{constructor(q,$,w=J2){super(q.logger);this.presence=q,this.map=Object.create(null),this.syncInProgress=!1,this.residualMembers=null,this.memberKey=$,this.newerThan=w}get(q){return this.map[q]}getClient(q){let $=this.map,w=[];for(let Z in $){let G=$[Z];if(G.clientId==q&&G.action!="absent")w.push(G)}return w}list(q){let $=this.map,w=q&&q.clientId,Z=q&&q.connectionId,G=[];for(let X in $){let U=$[X];if(U.action==="absent")continue;if(w&&w!=U.clientId)continue;if(Z&&Z!=U.connectionId)continue;G.push(U)}return G}put(q){if(q.action==="enter"||q.action==="update")q=f0.fromValues(q),q.action="present";let $=this.map,w=this.memberKey(q);if(this.residualMembers)delete this.residualMembers[w];let Z=$[w];if(Z&&!this.newerThan(q,Z))return!1;return $[w]=q,!0}values(){let q=this.map,$=[];for(let w in q){let Z=q[w];if(Z.action!="absent")$.push(Z)}return $}remove(q){let $=this.map,w=this.memberKey(q),Z=$[w];if(Z&&!this.newerThan(q,Z))return!1;if(this.syncInProgress)q=f0.fromValues(q),q.action="absent",$[w]=q;else delete $[w];return!!Z}startSync(){let q=this.map,$=this.syncInProgress;if(Q.logAction(this.logger,Q.LOG_MINOR,"PresenceMap.startSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+$),!this.syncInProgress)this.residualMembers=Y1(q),this.setInProgress(!0)}endSync(){let q=this.map,$=this.syncInProgress;if(Q.logAction(this.logger,Q.LOG_MINOR,"PresenceMap.endSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+$),$){for(let w in q)if(q[w].action==="absent")delete q[w];this.presence._synthesizeLeaves(h$(this.residualMembers));for(let w in this.residualMembers)delete q[w];this.residualMembers=null,this.setInProgress(!1)}this.emit("sync")}waitSync(q){let $=this.syncInProgress;if(Q.logAction(this.logger,Q.LOG_MINOR,"PresenceMap.waitSync()","channel = "+this.presence.channel.name+"; syncInProgress = "+$),!$){q();return}this.once("sync",q)}clear(){this.map={},this.setInProgress(!1),this.residualMembers=null}setInProgress(q){Q.logAction(this.logger,Q.LOG_MICRO,"PresenceMap.setInProgress()","inProgress = "+q),this.syncInProgress=q,this.presence.syncComplete=!q}};function N2(q){return q.channel.client.auth.clientId}function $5(q){let $=q.channel.client,w=$.auth.clientId;return(!w||w==="*")&&$.connection.state==="connected"}function X2(q,$,w){switch(q.state){case"attached":case"suspended":w();break;case"initialized":case"detached":case"detaching":case"attaching":j0(q.attach(),function(Z){if(Z)$(Z);else w()});break;default:$(D.fromValues(q.invalidStateError()))}}var Q2=class extends V0{constructor(q){super(q.logger);this.channel=q,this.syncComplete=!1,this.members=new q5(this,($)=>$.clientId+":"+$.connectionId),this._myMembers=new q5(this,($)=>$.clientId),this.subscriptions=new V0(this.logger),this.pendingPresence=[]}async enter(q){if($5(this))throw new D("clientId must be specified to enter a presence channel",40012,400);return this._enterOrUpdateClient(void 0,void 0,q,"enter")}async update(q){if($5(this))throw new D("clientId must be specified to update presence data",40012,400);return this._enterOrUpdateClient(void 0,void 0,q,"update")}async enterClient(q,$){return this._enterOrUpdateClient(void 0,q,$,"enter")}async updateClient(q,$){return this._enterOrUpdateClient(void 0,q,$,"update")}async _enterOrUpdateClient(q,$,w,Z){let G=this.channel;if(!G.connectionManager.activeState())throw G.connectionManager.getError();Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence."+Z+"Client()","channel = "+G.name+", id = "+q+", client = "+($||"(implicit) "+N2(this)));let X=f0.fromData(w);if(X.action=Z,q)X.id=q;if($)X.clientId=$;let U=await X.encode(G.channelOptions);switch(G.state){case"attached":return G.sendPresence([U]);case"initialized":case"detached":G.attach();case"attaching":return new Promise((O,F)=>{this.pendingPresence.push({presence:U,callback:(z)=>z?F(z):O()})});default:{let O=new r("Unable to "+Z+" presence channel while in "+G.state+" state",90001);throw O.code=90001,O}}}async leave(q){if($5(this))throw new D("clientId must have been specified to enter or leave a presence channel",40012,400);return this.leaveClient(void 0,q)}async leaveClient(q,$){let w=this.channel;if(!w.connectionManager.activeState())throw w.connectionManager.getError();Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence.leaveClient()","leaving; channel = "+this.channel.name+", client = "+q);let Z=f0.fromData($);if(Z.action="leave",q)Z.clientId=q;let G=await Z.encode(w.channelOptions);switch(w.state){case"attached":return w.sendPresence([G]);case"attaching":return new Promise((X,U)=>{this.pendingPresence.push({presence:G,callback:(O)=>O?U(O):X()})});case"initialized":case"failed":throw new r("Unable to leave presence channel (incompatible state)",90001);default:throw w.invalidStateError()}}async get(q){let $=!q||("waitForSync"in q?q.waitForSync:!0);return new Promise((w,Z)=>{function G(X){w(q?X.list(q):X.values())}if(this.channel.state==="suspended"){if($)Z(D.fromValues({statusCode:400,code:91005,message:"Presence state is out of sync due to channel being in the SUSPENDED state"}));else G(this.members);return}X2(this.channel,(X)=>Z(X),()=>{let X=this.members;if($)X.waitSync(function(){G(X)});else G(X)})})}async history(q){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence.history()","channel = "+this.name);let $=this.channel.client.rest.presenceMixin;if(q&&q.untilAttach)if(this.channel.state==="attached")delete q.untilAttach,q.from_serial=this.channel.properties.attachSerial;else throw new D("option untilAttach requires the channel to be attached, was: "+this.channel.state,40000,400);return $.history(this,q)}setPresence(q,$,w){Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence.setPresence()","received presence for "+q.length+" participants; syncChannelSerial = "+w);let Z,G,X=this.members,U=this._myMembers,O=[],F=this.channel.connectionManager.connectionId;if($){if(this.members.startSync(),w&&(G=w.match(/^[\w-]+:(.*)$/)))Z=G[1]}for(let z of q)switch(z.action){case"leave":if(X.remove(z))O.push(z);if(z.connectionId===F&&!z.isSynthesized())U.remove(z);break;case"enter":case"present":case"update":if(X.put(z))O.push(z);if(z.connectionId===F)U.put(z);break}if($&&!Z)X.endSync(),this.channel.syncChannelSerial=null;for(let z=0;z<O.length;z++){let I=O[z];this.subscriptions.emit(I.action,I)}}onAttached(q){if(Q.logAction(this.logger,Q.LOG_MINOR,"RealtimePresence.onAttached()","channel = "+this.channel.name+", hasPresence = "+q),q)this.members.startSync();else this._synthesizeLeaves(this.members.values()),this.members.clear();this._ensureMyMembersPresent();let $=this.pendingPresence,w=$.length;if(w){this.pendingPresence=[];let Z=[],G=k8.create(this.logger);Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence.onAttached","sending "+w+" queued presence messages");for(let X=0;X<w;X++){let U=$[X];Z.push(U.presence),G.push(U.callback)}this.channel.sendPresence(Z).then(()=>G()).catch((X)=>G(X))}}actOnChannelState(q,$,w){switch(q){case"attached":this.onAttached($);break;case"detached":case"failed":this._clearMyMembers(),this.members.clear();case"suspended":this.failPendingPresence(w);break}}failPendingPresence(q){if(this.pendingPresence.length){Q.logAction(this.logger,Q.LOG_MINOR,"RealtimeChannel.failPendingPresence","channel; name = "+this.channel.name+", err = "+W0(q));for(let $=0;$<this.pendingPresence.length;$++)try{this.pendingPresence[$].callback(q)}catch(w){}this.pendingPresence=[]}}_clearMyMembers(){this._myMembers.clear()}_ensureMyMembersPresent(){let q=this._myMembers,$=this.channel.connectionManager.connectionId;for(let w in q.map){let Z=q.map[w];Q.logAction(this.logger,Q.LOG_MICRO,"RealtimePresence._ensureMyMembersPresent()",'Auto-reentering clientId "'+Z.clientId+'" into the presence set');let G=Z.connectionId===$?Z.id:void 0;this._enterOrUpdateClient(G,Z.clientId,Z.data,"enter").catch((X)=>{let U=new D("Presence auto re-enter failed",91004,400,X);Q.logAction(this.logger,Q.LOG_ERROR,"RealtimePresence._ensureMyMembersPresent()","Presence auto re-enter failed; reason = "+W0(X));let O=new o8(this.channel.state,this.channel.state,!0,!1,U);this.channel.emit("update",O)})}}_synthesizeLeaves(q){let $=this.subscriptions;q.forEach(function(w){let Z=f0.fromValues({action:"leave",connectionId:w.connectionId,clientId:w.clientId,data:w.data,encoding:w.encoding,timestamp:Date.now()});$.emit("leave",Z)})}async subscribe(...q){let $=qq.processListenerArgs(q),w=$[0],Z=$[1],G=this.channel;if(G.state==="failed")throw D.fromValues(G.invalidStateError());if(this.subscriptions.on(w,Z),G.channelOptions.attachOnSubscribe!==!1)await G.attach()}unsubscribe(...q){let $=qq.processListenerArgs(q),w=$[0],Z=$[1];this.subscriptions.off(w,Z)}},H2=Q2,U2=M0.WebSocket;function K2(q){return!!q.on}var O2=class extends _1{constructor(q,$,w){super(q,$,w);this.shortName=U2,w.heartbeats=B.Config.useProtocolHeartbeats,this.wsHost=w.host}static isAvailable(){return!!B.Config.WebSocket}createWebSocket(q,$){return this.uri=q+a1($),new B.Config.WebSocket(this.uri)}toString(){return"WebSocketTransport; uri="+this.uri}connect(){Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.connect()","starting"),_1.prototype.connect.call(this);let q=this,$=this.params,w=$.options,G=(w.tls?"wss://":"ws://")+this.wsHost+":"+k.getPort(w)+"/";Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.connect()","uri: "+G),j0(this.auth.getAuthParams(),function(X,U){if(q.isDisposed)return;let O="";for(let z in U)O+=" "+z+": "+U[z]+";";if(Q.logAction(q.logger,Q.LOG_MINOR,"WebSocketTransport.connect()","authParams:"+O+" err: "+X),X){q.disconnect(X);return}let F=$.getConnectParams(U);try{let z=q.wsConnection=q.createWebSocket(G,F);if(z.binaryType=B.Config.binaryType,z.onopen=function(){q.onWsOpen()},z.onclose=function(I){q.onWsClose(I)},z.onmessage=function(I){q.onWsData(I.data)},z.onerror=function(I){q.onWsError(I)},K2(z))z.on("ping",function(){q.onActivity()})}catch(z){Q.logAction(q.logger,Q.LOG_ERROR,"WebSocketTransport.connect()","Unexpected exception creating websocket: err = "+(z.stack||z.message)),q.disconnect(z)}})}send(q){let $=this.wsConnection;if(!$){Q.logAction(this.logger,Q.LOG_ERROR,"WebSocketTransport.send()","No socket connection");return}try{$.send(k4(q,this.connectionManager.realtime._MsgPack,this.params.format))}catch(w){let Z="Exception from ws connection when trying to send: "+W0(w);Q.logAction(this.logger,Q.LOG_ERROR,"WebSocketTransport.send()",Z),this.finish("disconnected",new D(Z,50000,500))}}onWsData(q){Q.logAction(this.logger,Q.LOG_MICRO,"WebSocketTransport.onWsData()","data received; length = "+q.length+"; type = "+typeof q);try{this.onProtocolMessage(y4(q,this.connectionManager.realtime._MsgPack,this.connectionManager.realtime._RealtimePresence,this.connectionManager.realtime._Annotations,this.connectionManager.realtime._objectsPlugin,this.format))}catch($){Q.logAction(this.logger,Q.LOG_ERROR,"WebSocketTransport.onWsData()","Unexpected exception handing channel message: "+$.stack)}}onWsOpen(){Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.onWsOpen()","opened WebSocket"),this.emit("preconnect")}onWsClose(q){let $,w;if(typeof q=="object")w=q.code,$=q.wasClean||w===1000;else w=q,$=w==1000;if(delete this.wsConnection,$){Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.onWsClose()","Cleanly closed WebSocket");let Z=new D("Websocket closed",80003,400);this.finish("disconnected",Z)}else{let Z="Unclean disconnection of WebSocket ; code = "+w,G=new D(Z,80003,400);Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.onWsClose()",Z),this.finish("disconnected",G)}this.emit("disposed")}onWsError(q){Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.onError()","Error from WebSocket: "+q.message),B.Config.nextTick(()=>{this.disconnect(Error(q.message))})}dispose(){Q.logAction(this.logger,Q.LOG_MINOR,"WebSocketTransport.dispose()",""),this.isDisposed=!0;let q=this.wsConnection;if(q)q.onmessage=function(){},delete this.wsConnection,B.Config.nextTick(()=>{if(Q.logAction(this.logger,Q.LOG_MICRO,"WebSocketTransport.dispose()","closing websocket"),!q)throw Error("WebSocketTransport.dispose(): wsConnection is not defined");q.close()})}},y7=O2,V2=class{static subscribeFilter(q,$,w){let Z=(G)=>{var X,U,O,F,z,I;let j={name:G.name,refTimeserial:(U=(X=G.extras)==null?void 0:X.ref)==null?void 0:U.timeserial,refType:(F=(O=G.extras)==null?void 0:O.ref)==null?void 0:F.type,isRef:!!((I=(z=G.extras)==null?void 0:z.ref)==null?void 0:I.timeserial),clientId:G.clientId};if(Object.entries($).find(([A,M])=>M!==void 0?j[A]!==M:!1))return;w(G)};this.addFilteredSubscription(q,$,w,Z),q.subscriptions.on(Z)}static addFilteredSubscription(q,$,w,Z){var G;if(!q.filteredSubscriptions)q.filteredSubscriptions=new Map;if(q.filteredSubscriptions.has(w)){let X=q.filteredSubscriptions.get(w);X.set($,((G=X==null?void 0:X.get($))==null?void 0:G.concat(Z))||[Z])}else q.filteredSubscriptions.set(w,new Map([[$,[Z]]]))}static getAndDeleteFilteredSubscriptions(q,$,w){if(!q.filteredSubscriptions)return[];if(!w&&$)return Array.from(q.filteredSubscriptions.entries()).map(([X,U])=>{var O;let F=U.get($);if(U.delete($),U.size===0)(O=q.filteredSubscriptions)==null||O.delete(X);return F}).reduce((X,U)=>U?X.concat(...U):X,[]);if(!w||!q.filteredSubscriptions.has(w))return[];let Z=q.filteredSubscriptions.get(w);if(!$){let X=Array.from(Z.values()).reduce((U,O)=>U.concat(...O),[]);return q.filteredSubscriptions.delete(w),X}let G=Z.get($);return Z.delete($),G||[]}},c0=class q extends G2{constructor($){var w;let Z=q._MsgPack;if(!Z)throw Error("Expected DefaultRealtime._MsgPack to have been set");super(k.objectifyOptions($,!0,"Realtime",Q.defaultLogger,c(_({},D7),{Crypto:(w=q.Crypto)!=null?w:void 0,MsgPack:Z,RealtimePresence:{RealtimePresence:H2,PresenceMessage:f0,WirePresenceMessage:s1},Annotations:{Annotation:S1,WireAnnotation:R1,RealtimeAnnotations:l8,RestAnnotations:oq},WebSocketTransport:y7,MessageInteractions:V2})))}static get Crypto(){if(this._Crypto===null)throw Error("Encryption not enabled; use ably.encryption.js instead");return this._Crypto}static set Crypto($){this._Crypto=$}};c0.Utils=z0,c0.ConnectionManager=C7,c0.ProtocolMessage=n4,c0._Crypto=null,c0.Message=B7,c0.PresenceMessage=Y7,c0.Annotation=M7,c0._MsgPack=null,c0._Http=i8,c0._PresenceMap=q5,c0._MessageEncoding=tq;var w5=c0,u5=Uint8Array,wq=Uint32Array,W5=Math.pow,n7=new wq(8),i7=[],uq=new wq(64);function g7(q){return(q-(q|0))*W5(2,32)|0}var Wq=2,Zq=0;while(Zq<64){Z5=!0;for(aq=2;aq<=Wq/2;aq++)if(Wq%aq===0)Z5=!1;if(Z5){if(Zq<8)n7[Zq]=g7(W5(Wq,0.5));i7[Zq]=g7(W5(Wq,0.3333333333333333)),Zq++}Wq++}var Z5,aq,z2=!!new u5(new wq([1]).buffer)[0];function G5(q){if(z2)return q>>>24|(q>>>16&255)<<8|(q&65280)<<8|q<<24;else return q}function g0(q,$){return q>>>$|q<<32-$}function sq(q){var $=n7.slice(),w=q.length,Z=w*8,G=512-(Z+64)%512-1+Z+65,X=new u5(G/8),U=new wq(X.buffer);X.set(q,0),X[w]=128,U[U.length-1]=G5(Z);var O;for(var F=0;F<G/32;F+=16){var z=$.slice();for(O=0;O<64;O++){var I;if(O<16)I=G5(U[F+O]);else{var j=uq[O-15],A=uq[O-2];I=uq[O-7]+uq[O-16]+(g0(j,7)^g0(j,18)^j>>>3)+(g0(A,17)^g0(A,19)^A>>>10)}uq[O]=I|=0;var M=(g0(z[4],6)^g0(z[4],11)^g0(z[4],25))+(z[4]&z[5]^~z[4]&z[6])+z[7]+I+i7[O],E=(g0(z[0],2)^g0(z[0],13)^g0(z[0],22))+(z[0]&z[1]^z[2]&(z[0]^z[1]));for(var T=7;T>0;T--)z[T]=z[T-1];z[0]=M+E|0,z[4]=z[4]+M|0}for(O=0;O<8;O++)$[O]=$[O]+z[O]|0}return new u5(new wq($.map(function(d){return G5(d)})).buffer)}function F2(q,$){if(q.length>64)q=sq(q);if(q.length<64){let O=new Uint8Array(64);O.set(q,0),q=O}var w=new Uint8Array(64),Z=new Uint8Array(64);for(var G=0;G<64;G++)w[G]=54^q[G],Z[G]=92^q[G];var X=new Uint8Array($.length+64);X.set(w,0),X.set($,64);var U=new Uint8Array(96);return U.set(Z,0),U.set(sq(X),64),sq(U)}var h2=class{constructor(){this.base64CharSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",this.hexCharSet="0123456789abcdef"}uint8ViewToBase64(q){let $="",w=this.base64CharSet,Z=q.byteLength,G=Z%3,X=Z-G,U,O,F,z,I;for(let j=0;j<X;j=j+3)I=q[j]<<16|q[j+1]<<8|q[j+2],U=(I&16515072)>>18,O=(I&258048)>>12,F=(I&4032)>>6,z=I&63,$+=w[U]+w[O]+w[F]+w[z];if(G==1)I=q[X],U=(I&252)>>2,O=(I&3)<<4,$+=w[U]+w[O]+"==";else if(G==2)I=q[X]<<8|q[X+1],U=(I&64512)>>10,O=(I&1008)>>4,F=(I&15)<<2,$+=w[U]+w[O]+w[F]+"=";return $}base64ToArrayBuffer(q){let $=atob==null?void 0:atob(q),w=$.length,Z=new Uint8Array(w);for(let G=0;G<w;G++){let X=$.charCodeAt(G);Z[G]=X}return this.toArrayBuffer(Z)}isBuffer(q){return q instanceof ArrayBuffer||ArrayBuffer.isView(q)}toBuffer(q){if(!ArrayBuffer)throw Error("Can't convert to Buffer: browser does not support the necessary types");if(q instanceof ArrayBuffer)return new Uint8Array(q);if(ArrayBuffer.isView(q))return new Uint8Array(this.toArrayBuffer(q));throw Error("BufferUtils.toBuffer expected an ArrayBuffer or a view onto one")}toArrayBuffer(q){if(!ArrayBuffer)throw Error("Can't convert to ArrayBuffer: browser does not support the necessary types");if(q instanceof ArrayBuffer)return q;if(ArrayBuffer.isView(q))return q.buffer.slice(q.byteOffset,q.byteOffset+q.byteLength);throw Error("BufferUtils.toArrayBuffer expected an ArrayBuffer or a view onto one")}base64Encode(q){return this.uint8ViewToBase64(this.toBuffer(q))}base64UrlEncode(q){return this.base64Encode(q).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}base64Decode(q){if(ArrayBuffer&&B.Config.atob)return this.base64ToArrayBuffer(q);else throw Error("Expected ArrayBuffer to exist and Platform.Config.atob to be configured")}hexEncode(q){return this.toBuffer(q).reduce((w,Z)=>w+Z.toString(16).padStart(2,"0"),"")}hexDecode(q){if(q.length%2!==0)throw Error("Can't create a byte array from a hex string of odd length");let $=new Uint8Array(q.length/2);for(let w=0;w<$.length;w++)$[w]=parseInt(q.slice(2*w,2*(w+1)),16);return this.toArrayBuffer($)}utf8Encode(q){if(B.Config.TextEncoder){let $=new B.Config.TextEncoder().encode(q);return this.toArrayBuffer($)}else throw Error("Expected TextEncoder to be configured")}utf8Decode(q){if(!this.isBuffer(q))throw Error("Expected input of utf8decode to be an arraybuffer or typed array");if(TextDecoder)return new TextDecoder().decode(q);else throw Error("Expected TextDecoder to be configured")}areBuffersEqual(q,$){if(!q||!$)return!1;let w=this.toArrayBuffer(q),Z=this.toArrayBuffer($);if(w.byteLength!=Z.byteLength)return!1;let G=new Uint8Array(w),X=new Uint8Array(Z);for(var U=0;U<G.length;U++)if(G[U]!=X[U])return!1;return!0}byteLength(q){if(q instanceof ArrayBuffer||ArrayBuffer.isView(q))return q.byteLength;return-1}arrayBufferViewToBuffer(q){return this.toArrayBuffer(q)}concat(q){let $=q.reduce((G,X)=>G+X.byteLength,0),w=new Uint8Array($),Z=0;for(let G of q){let X=this.toBuffer(G);w.set(X,Z),Z+=X.byteLength}return w.buffer}sha256(q){let $=sq(this.toBuffer(q));return this.toArrayBuffer($)}hmacSha256(q,$){let w=F2(this.toBuffer($),this.toBuffer(q));return this.toArrayBuffer(w)}},p7=new h2,D2=function(q,$){var w="aes",Z=256,G="cbc",X=16;function U(A){if(A.algorithm==="aes"&&A.mode==="cbc"){if(A.keyLength===128||A.keyLength===256)return;throw Error("Unsupported key length "+A.keyLength+" for aes-cbc encryption. Encryption key must be 128 or 256 bits (16 or 32 ASCII characters)")}}function O(A){return A.replace("_","/").replace("-","+")}function F(A){return A instanceof z}class z{constructor(A,M,E,T){this.algorithm=A,this.keyLength=M,this.mode=E,this.key=T}}class I{static getDefaultParams(A){var M;if(!A.key)throw Error("Crypto.getDefaultParams: a key is required");if(typeof A.key==="string")M=$.toArrayBuffer($.base64Decode(O(A.key)));else if(A.key instanceof ArrayBuffer)M=A.key;else M=$.toArrayBuffer(A.key);var E=A.algorithm||w,T=M.byteLength*8,d=A.mode||G,t=new z(E,T,d,M);if(A.keyLength&&A.keyLength!==t.keyLength)throw Error("Crypto.getDefaultParams: a keyLength of "+A.keyLength+" was specified, but the key actually has length "+t.keyLength);return U(t),t}static async generateRandomKey(A){try{return q.getRandomArrayBuffer((A||Z)/8)}catch(M){throw new D("Failed to generate random key: "+M.message,400,50000,M)}}static getCipher(A,M){var E,T=F(A)?A:this.getDefaultParams(A);return{cipherParams:T,cipher:new j(T,(E=A.iv)!=null?E:null,M)}}}I.CipherParams=z;class j{constructor(A,M,E){if(this.logger=E,!crypto.subtle)if(isSecureContext)throw Error("Crypto operations are not possible since the browser’s SubtleCrypto class is unavailable (reason unknown).");else throw Error("Crypto operations are is not possible since the current environment is a non-secure context and hence the browser’s SubtleCrypto class is not available.");this.algorithm=A.algorithm+"-"+String(A.keyLength)+"-"+A.mode,this.webCryptoAlgorithm=A.algorithm+"-"+A.mode,this.key=$.toArrayBuffer(A.key),this.iv=M?$.toArrayBuffer(M):null}concat(A,M){let E=new ArrayBuffer(A.byteLength+M.byteLength),T=new DataView(E),d=new DataView($.toArrayBuffer(A));for(let a=0;a<d.byteLength;a++)T.setInt8(a,d.getInt8(a));let t=new DataView($.toArrayBuffer(M));for(let a=0;a<t.byteLength;a++)T.setInt8(d.byteLength+a,t.getInt8(a));return E}async encrypt(A){Q.logAction(this.logger,Q.LOG_MICRO,"CBCCipher.encrypt()","");let M=await this.getIv(),E=await crypto.subtle.importKey("raw",this.key,this.webCryptoAlgorithm,!1,["encrypt"]),T=await crypto.subtle.encrypt({name:this.webCryptoAlgorithm,iv:M},E,A);return this.concat(M,T)}async decrypt(A){Q.logAction(this.logger,Q.LOG_MICRO,"CBCCipher.decrypt()","");let M=$.toArrayBuffer(A),E=M.slice(0,X),T=M.slice(X),d=await crypto.subtle.importKey("raw",this.key,this.webCryptoAlgorithm,!1,["decrypt"]);return crypto.subtle.decrypt({name:this.webCryptoAlgorithm,iv:E},d,T)}async getIv(){if(this.iv){var A=this.iv;return this.iv=null,A}let M=await q.getRandomArrayBuffer(X);return $.toArrayBuffer(M)}}return I},v7=((q)=>{return q[q.REQ_SEND=0]="REQ_SEND",q[q.REQ_RECV=1]="REQ_RECV",q[q.REQ_RECV_POLL=2]="REQ_RECV_POLL",q[q.REQ_RECV_STREAM=3]="REQ_RECV_STREAM",q})(v7||{}),o0=v7;function x7(){return new D("No HTTP request plugin provided. Provide at least one of the FetchRequest or XHRRequest plugins.",400,40000)}var Gq,d7=(Gq=class{constructor(q){this.checksInProgress=null,this.checkConnectivity=void 0,this.supportsAuthHeaders=!1,this.supportsLinkHeaders=!1;var $;this.client=q!=null?q:null;let w=(q==null?void 0:q.options.connectivityCheckUrl)||k.connectivityCheckUrl,Z=($=q==null?void 0:q.options.connectivityCheckParams)!=null?$:null,G=!(q==null?void 0:q.options.connectivityCheckUrl),X=_(_({},d7.bundledRequestImplementations),q==null?void 0:q._additionalHTTPRequestImplementations),U=X.XHRRequest,O=X.FetchRequest,F=!!(U||O);if(!F)throw x7();if(B.Config.xhrSupported&&U)if(this.supportsAuthHeaders=!0,this.Request=async function(z,I,j,A,M){return new Promise((E)=>{var T;let d=U.createRequest(I,j,A,M,o0.REQ_SEND,(T=q&&q.options.timeouts)!=null?T:null,this.logger,z);d.once("complete",(t,a,D0,n,S0)=>E({error:t,body:a,headers:D0,unpacked:n,statusCode:S0})),d.exec()})},q==null?void 0:q.options.disableConnectivityCheck)this.checkConnectivity=async function(){return!0};else this.checkConnectivity=async function(){var z;Q.logAction(this.logger,Q.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Sending; "+w);let I=await this.doUri(U0.Get,w,null,null,Z),j=!1;if(!G)j=!I.error&&iu(I.statusCode);else j=!I.error&&((z=I.body)==null?void 0:z.replace(/\n/,""))=="yes";return Q.logAction(this.logger,Q.LOG_MICRO,"(XHRRequest)Http.checkConnectivity()","Result: "+j),j};else if(B.Config.fetchSupported&&O)if(this.supportsAuthHeaders=!0,this.Request=async(z,I,j,A,M)=>{return O(z,q!=null?q:null,I,j,A,M)},q==null?void 0:q.options.disableConnectivityCheck)this.checkConnectivity=async function(){return!0};else this.checkConnectivity=async function(){var z;Q.logAction(this.logger,Q.LOG_MICRO,"(Fetch)Http.checkConnectivity()","Sending; "+w);let I=await this.doUri(U0.Get,w,null,null,null),j=!I.error&&((z=I.body)==null?void 0:z.replace(/\n/,""))=="yes";return Q.logAction(this.logger,Q.LOG_MICRO,"(Fetch)Http.checkConnectivity()","Result: "+j),j};else this.Request=async()=>{return{error:F?new r("no supported HTTP transports available",null,400):x7()}}}get logger(){var q,$;return($=(q=this.client)==null?void 0:q.logger)!=null?$:Q.defaultLogger}async doUri(q,$,w,Z,G){if(!this.Request)return{error:new r("Request invoked before assigned to",null,500)};return this.Request(q,$,w,G,Z)}shouldFallback(q){let $=q.statusCode;return $===408&&!q.code||$===400&&!q.code||$>=500&&$<=504}},Gq.methods=[U0.Get,U0.Delete,U0.Post,U0.Put,U0.Patch],Gq.methodsWithoutBody=[U0.Get,U0.Delete],Gq.methodsWithBody=[U0.Post,U0.Put,U0.Patch],Gq),t7=d7,b1="ablyjs-storage-test",T1=typeof global<"u"?global:typeof window<"u"?window:self,B2=class{constructor(){try{T1.sessionStorage.setItem(b1,b1),T1.sessionStorage.removeItem(b1),this.sessionSupported=!0}catch(q){this.sessionSupported=!1}try{T1.localStorage.setItem(b1,b1),T1.localStorage.removeItem(b1),this.localSupported=!0}catch(q){this.localSupported=!1}}get(q){return this._get(q,!1)}getSession(q){return this._get(q,!0)}remove(q){return this._remove(q,!1)}removeSession(q){return this._remove(q,!0)}set(q,$,w){return this._set(q,$,w,!1)}setSession(q,$,w){return this._set(q,$,w,!0)}_set(q,$,w,Z){let G={value:$};if(w)G.expires=Date.now()+w;return this.storageInterface(Z).setItem(q,JSON.stringify(G))}_get(q,$){if($&&!this.sessionSupported)throw Error("Session Storage not supported");if(!$&&!this.localSupported)throw Error("Local Storage not supported");let w=this.storageInterface($).getItem(q);if(!w)return null;let Z=JSON.parse(w);if(Z.expires&&Z.expires<Date.now())return this.storageInterface($).removeItem(q),null;return Z.value}_remove(q,$){return this.storageInterface($).removeItem(q)}storageInterface(q){return q?T1.sessionStorage:T1.localStorage}},f7=new B2,K0=P8(),Y2=typeof EdgeRuntime==="string";if(typeof Window>"u"&&typeof WorkerGlobalScope>"u"&&!Y2)console.log("Warning: this distribution of Ably is intended for browsers. On nodejs, please use the 'ably' package on npm");function I2(){let q=K0.location;return!K0.WebSocket||!q||!q.origin||q.origin.indexOf("http")>-1}function j2(){if(typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope)return!0;else return!1}var A2=K0.navigator&&K0.navigator.userAgent.toString(),M2=K0.location&&K0.location.href,L2={agent:"browser",logTimestamps:!0,userAgent:A2,currentUrl:M2,binaryType:"arraybuffer",WebSocket:K0.WebSocket,fetchSupported:!!K0.fetch,xhrSupported:K0.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest,allowComet:I2(),useProtocolHeartbeats:!0,supportsBinary:!!K0.TextDecoder,preferBinary:!1,ArrayBuffer:K0.ArrayBuffer,atob:K0.atob,nextTick:typeof K0.queueMicrotask==="function"?(q)=>K0.queueMicrotask(q):(q)=>Promise.resolve().then(q),addEventListener:K0.addEventListener,inspect:JSON.stringify,stringByteSize:function(q){return K0.TextDecoder&&new K0.TextEncoder().encode(q).length||q.length},TextEncoder:K0.TextEncoder,TextDecoder:K0.TextDecoder,getRandomArrayBuffer:async function(q){let $=new Uint8Array(q);return K0.crypto.getRandomValues($),$.buffer},isWebworker:j2(),push:{platform:"browser",formFactor:"desktop",storage:f7}},m7=L2;function R2(q){let $=[80015,80017,80030];if(q.code){if(t0.isTokenErr(q))return!1;if($.includes(q.code))return!0;return q.code>=40000&&q.code<50000}else return!1}function J5(q){if(R2(q))return[R0({action:C.ERROR,error:q})];else return[R0({action:C.DISCONNECTED,error:q})]}var S2=class extends _1{constructor(q,$,w){super(q,$,w,!0);this.onAuthUpdated=(Z)=>{this.authParams={access_token:Z.token}},this.stream="stream"in w?w.stream:!0,this.sendRequest=null,this.recvRequest=null,this.pendingCallback=null,this.pendingItems=null}connect(){Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.connect()","starting"),_1.prototype.connect.call(this);let q=this.params,$=q.options,w=q.host||$.primaryDomain,Z=k.getPort($),G=$.tls?"https://":"http://";this.baseUri=G+w+":"+Z+"/comet/";let X=this.baseUri+"connect";Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.connect()","uri: "+X),j0(this.auth.getAuthParams(),(U,O)=>{if(U){this.disconnect(U);return}if(this.isDisposed)return;this.authParams=O;let F=this.params.getConnectParams(O);if("stream"in F)this.stream=F.stream;Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.connect()","connectParams:"+a1(F));let z=!1,I=this.recvRequest=this.createRequest(X,null,F,null,this.stream?o0.REQ_RECV_STREAM:o0.REQ_RECV);I.on("data",(j)=>{if(!this.recvRequest)return;if(!z)z=!0,this.emit("preconnect");this.onData(j)}),I.on("complete",(j)=>{if(!this.recvRequest)j=j||new D("Request cancelled",80003,400);if(this.recvRequest=null,!z&&!j)z=!0,this.emit("preconnect");if(this.onActivity(),j){if(j.code)this.onData(J5(j));else this.disconnect(j);return}B.Config.nextTick(()=>{this.recv()})}),I.exec()})}requestClose(){Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.requestClose()"),this._requestCloseOrDisconnect(!0)}requestDisconnect(){Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.requestDisconnect()"),this._requestCloseOrDisconnect(!1)}_requestCloseOrDisconnect(q){let $=q?this.closeUri:this.disconnectUri;if($){let w=this.createRequest($,null,this.authParams,null,o0.REQ_SEND);w.on("complete",(Z)=>{if(Z)Q.logAction(this.logger,Q.LOG_ERROR,"CometTransport.request"+(q?"Close()":"Disconnect()"),"request returned err = "+W0(Z)),this.finish("disconnected",Z)}),w.exec()}}dispose(){if(Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.dispose()",""),!this.isDisposed){if(this.isDisposed=!0,this.recvRequest)Q.logAction(this.logger,Q.LOG_MINOR,"CometTransport.dispose()","aborting recv request"),this.recvRequest.abort(),this.recvRequest=null;this.finish("disconnected",V1.disconnected()),B.Config.nextTick(()=>{this.emit("disposed")})}}onConnect(q){var $;if(this.isDisposed)return;let w=($=q.connectionDetails)==null?void 0:$.connectionKey;_1.prototype.onConnect.call(this,q);let Z=this.baseUri+w;Q.logAction(this.logger,Q.LOG_MICRO,"CometTransport.onConnect()","baseUri = "+Z),this.sendUri=Z+"/send",this.recvUri=Z+"/recv",this.closeUri=Z+"/close",this.disconnectUri=Z+"/disconnect"}send(q){if(this.sendRequest){this.pendingItems=this.pendingItems||[],this.pendingItems.push(q);return}let $=this.pendingItems||[];$.push(q),this.pendingItems=null,this.sendItems($)}sendAnyPending(){let q=this.pendingItems;if(!q)return;this.pendingItems=null,this.sendItems(q)}sendItems(q){let $=this.sendRequest=this.createRequest(this.sendUri,null,this.authParams,this.encodeRequest(q),o0.REQ_SEND);$.on("complete",(w,Z)=>{if(w)Q.logAction(this.logger,Q.LOG_ERROR,"CometTransport.sendItems()","on complete: err = "+W0(w));if(this.sendRequest=null,w){if(w.code)this.onData(J5(w));else this.disconnect(w);return}if(Z)this.onData(Z);if(this.pendingItems)B.Config.nextTick(()=>{if(!this.sendRequest)this.sendAnyPending()})}),$.exec()}recv(){if(this.recvRequest)return;if(!this.isConnected)return;let q=this.recvRequest=this.createRequest(this.recvUri,null,this.authParams,null,this.stream?o0.REQ_RECV_STREAM:o0.REQ_RECV_POLL);q.on("data",($)=>{this.onData($)}),q.on("complete",($)=>{if(this.recvRequest=null,this.onActivity(),$){if($.code)this.onData(J5($));else this.disconnect($);return}B.Config.nextTick(()=>{this.recv()})}),q.exec()}onData(q){try{let $=this.decodeResponse(q);if($&&$.length)for(let w=0;w<$.length;w++)this.onProtocolMessage(t8($[w],this.connectionManager.realtime._RealtimePresence,this.connectionManager.realtime._Annotations,this.connectionManager.realtime._objectsPlugin))}catch($){Q.logAction(this.logger,Q.LOG_ERROR,"CometTransport.onData()","Unexpected exception handing channel event: "+$.stack)}}encodeRequest(q){return JSON.stringify(q)}decodeResponse(q){if(typeof q=="string")return JSON.parse(q);return q}},_2=S2;function b2(q,$){return c8(r1($)).includes("x-ably-errorcode")}function T2(q,$){if(b2(q,$))return q.error&&D.fromValues(q.error)}var c2=function(){},E2=0,o7={};function P2(q,$){return q.getResponseHeader&&q.getResponseHeader($)}function C2(q){return q.getResponseHeader&&(q.getResponseHeader("transfer-encoding")||!q.getResponseHeader("content-length"))}function k2(q){let $=q.getAllResponseHeaders().trim().split(`\r
`),w={};for(let Z=0;Z<$.length;Z++){let G=$[Z].split(":").map((X)=>X.trim());w[G[0].toLowerCase()]=G[1]}return w}var y2=class q extends V0{constructor($,w,Z,G,X,U,O,F){super(O);Z=Z||{},Z.rnd=gq(),this.uri=$+a1(Z),this.headers=w||{},this.body=G,this.method=F?F.toUpperCase():E0(G)?"GET":"POST",this.requestMode=X,this.timeouts=U,this.timedOut=!1,this.requestComplete=!1,this.id=String(++E2),o7[this.id]=this}static createRequest($,w,Z,G,X,U,O,F){let z=U||k.TIMEOUTS;return new q($,w,Y1(Z),G,X,z,O,F)}complete($,w,Z,G,X){if(!this.requestComplete){if(this.requestComplete=!0,!$&&w)this.emit("data",w);this.emit("complete",$,w,Z,G,X),this.dispose()}}abort(){this.dispose()}exec(){let $=this.headers,w=this.requestMode==o0.REQ_SEND?this.timeouts.httpRequestTimeout:this.timeouts.recvTimeout,Z=this.timer=setTimeout(()=>{this.timedOut=!0,X.abort()},w),G=this.method,X=this.xhr=new XMLHttpRequest,U=$.accept,O=this.body,F="text";if(!U)$.accept="application/json";else if(U.indexOf("application/x-msgpack")===0)F="arraybuffer";if(O){if(($["content-type"]||($["content-type"]="application/json")).indexOf("application/json")>-1&&typeof O!="string")O=JSON.stringify(O)}if(X.open(G,this.uri,!0),X.responseType=F,"authorization"in $)X.withCredentials=!0;for(let n in $)X.setRequestHeader(n,$[n]);let z=(n,S0,B0,Qq)=>{var c1;let H5=S0+" (event type: "+n.type+")";if((c1=this==null?void 0:this.xhr)==null?void 0:c1.statusText)H5+=", current statusText is "+this.xhr.statusText;Q.logAction(this.logger,Q.LOG_ERROR,"Request.on"+n.type+"()",H5),this.complete(new r(H5,B0,Qq))};X.onerror=(n)=>{z(n,"XHR error occurred",null,400)},X.onabort=(n)=>{if(this.timedOut)z(n,"Request aborted due to request timeout expiring",null,408);else z(n,"Request cancelled",null,400)},X.ontimeout=(n)=>{z(n,"Request timed out",null,408)};let I,j,A,M=0,E=!1,T=()=>{if(clearTimeout(Z),A=j<400,j==204){this.complete(null,null,null,null,j);return}I=this.requestMode==o0.REQ_RECV_STREAM&&A&&C2(X)},d=()=>{let n;try{let B0=P2(X,"content-type");if(B0?B0.indexOf("application/json")>=0:X.responseType=="text"){let c1=X.responseType==="arraybuffer"?B.BufferUtils.utf8Decode(X.response):String(X.responseText);if(c1.length)n=JSON.parse(c1);else n=c1;E=!0}else n=X.response;if(n.response!==void 0)j=n.statusCode,A=j<400,$=n.headers,n=n.response;else $=k2(X)}catch(B0){this.complete(new r("Malformed response body from server: "+B0.message,null,400));return}if(A||Array.isArray(n)){this.complete(null,n,$,E,j);return}let S0=T2(n,$);if(!S0)S0=new r("Error response received from server: "+j+" body was: "+B.Config.inspect(n),null,j);this.complete(S0,n,$,E,j)};function t(){let n=X.responseText,S0=n.length-1,B0,Qq;while(M<S0&&(B0=n.indexOf(`
`,M))>-1)Qq=n.slice(M,B0),M=B0+1,a(Qq)}let a=(n)=>{try{n=JSON.parse(n)}catch(S0){this.complete(new r("Malformed response body from server: "+S0.message,null,400));return}this.emit("data",n)},D0=()=>{t(),this.streamComplete=!0,B.Config.nextTick(()=>{this.complete()})};X.onreadystatechange=()=>{let n=X.readyState;if(n<3)return;if(X.status!==0){if(j===void 0)j=X.status,T();if(n==3&&I)t();else if(n==4)if(I)D0();else d()}},X.send(O)}dispose(){let $=this.xhr;if($){$.onreadystatechange=$.onerror=$.onabort=$.ontimeout=c2,this.xhr=null;let w=this.timer;if(w)clearTimeout(w),this.timer=null;if(!this.requestComplete)$.abort()}delete o7[this.id]}},l7=y2,r7=M0.XhrPolling,n2=class extends _2{constructor(q,$,w){super(q,$,w);this.shortName=r7,w.stream=!1,this.shortName=r7}static isAvailable(){return!!(B.Config.xhrSupported&&B.Config.allowComet)}toString(){return"XHRPollingTransport; uri="+this.baseUri+"; isConnected="+this.isConnected}createRequest(q,$,w,Z,G){return l7.createRequest(q,$,w,Z,G,this.timeouts,this.logger)}},i2=n2,g2=["xhr_polling"],p2={order:g2,bundledImplementations:{web_socket:y7,xhr_polling:i2}},v2=p2,x2={connectivityCheckUrl:"https://internet-up.ably-realtime.com/is-the-internet-up.txt",wsConnectivityCheckUrl:"wss://ws-up.ably-realtime.com",defaultTransports:[M0.XhrPolling,M0.WebSocket]},d2=x2;function t2(q){if(q===void 0)return"undefined";let $,w;if(q instanceof ArrayBuffer)w="ArrayBuffer",$=new DataView(q);else if(q instanceof DataView)w="DataView",$=q;if(!$)return JSON.stringify(q);let Z=[];for(let G=0;G<q.byteLength;G++){if(G>20){Z.push("...");break}let X=$.getUint8(G).toString(16);if(X.length===1)X="0"+X;Z.push(X)}return"<"+w+" "+Z.join(" ")+">"}function Jq(q,$,w){for(let Z=0,G=w.length;Z<G;Z++){let X=w.charCodeAt(Z);if(X<128){q.setUint8($++,X>>>0&127|0);continue}if(X<2048){q.setUint8($++,X>>>6&31|192),q.setUint8($++,X>>>0&63|128);continue}if(X<65536){q.setUint8($++,X>>>12&15|224),q.setUint8($++,X>>>6&63|128),q.setUint8($++,X>>>0&63|128);continue}if(X<1114112){q.setUint8($++,X>>>18&7|240),q.setUint8($++,X>>>12&63|128),q.setUint8($++,X>>>6&63|128),q.setUint8($++,X>>>0&63|128);continue}throw Error("bad codepoint "+X)}}function a7(q,$,w){let Z="";for(let G=$,X=$+w;G<X;G++){let U=q.getUint8(G);if((U&128)===0){Z+=String.fromCharCode(U);continue}if((U&224)===192){Z+=String.fromCharCode((U&15)<<6|q.getUint8(++G)&63);continue}if((U&240)===224){Z+=String.fromCharCode((U&15)<<12|(q.getUint8(++G)&63)<<6|(q.getUint8(++G)&63)<<0);continue}if((U&248)===240){Z+=String.fromCharCode((U&7)<<18|(q.getUint8(++G)&63)<<12|(q.getUint8(++G)&63)<<6|(q.getUint8(++G)&63)<<0);continue}throw Error("Invalid byte "+U.toString(16))}return Z}function N5(q){let $=0;for(let w=0,Z=q.length;w<Z;w++){let G=q.charCodeAt(w);if(G<128){$+=1;continue}if(G<2048){$+=2;continue}if(G<65536){$+=3;continue}if(G<1114112){$+=4;continue}throw Error("bad codepoint "+G)}return $}function f2(q,$){let w=Xq(q,$);if(w===0)return;let Z=new ArrayBuffer(w),G=new DataView(Z);return Nq(q,G,0,$),Z}var X5=4294967296,s7=1/X5;function m2(q,$){return $=$||0,q.getInt32($)*X5+q.getUint32($+4)}function o2(q,$){return $=$||0,q.getUint32($)*X5+q.getUint32($+4)}function l2(q,$,w){if(w<9223372036854776000)q.setInt32($,Math.floor(w*s7)),q.setInt32($+4,w&-1);else q.setUint32($,2147483647),q.setUint32($+4,2147483647)}function r2(q,$,w){if(w<18446744073709552000)q.setUint32($,Math.floor(w*s7)),q.setInt32($+4,w&-1);else q.setUint32($,4294967295),q.setUint32($+4,4294967295)}var a2=class{constructor(q,$){this.map=(w)=>{let Z={};for(let G=0;G<w;G++){let X=this.parse();Z[X]=this.parse()}return Z},this.bin=(w)=>{let Z=new ArrayBuffer(w);return new Uint8Array(Z).set(new Uint8Array(this.view.buffer,this.offset,w),0),this.offset+=w,Z},this.buf=this.bin,this.str=(w)=>{let Z=a7(this.view,this.offset,w);return this.offset+=w,Z},this.array=(w)=>{let Z=Array(w);for(let G=0;G<w;G++)Z[G]=this.parse();return Z},this.ext=(w)=>{return this.offset+=w,{type:this.view.getInt8(this.offset),data:this.buf(w)}},this.parse=()=>{let w=this.view.getUint8(this.offset),Z,G;if((w&128)===0)return this.offset++,w;if((w&240)===128)return G=w&15,this.offset++,this.map(G);if((w&240)===144)return G=w&15,this.offset++,this.array(G);if((w&224)===160)return G=w&31,this.offset++,this.str(G);if((w&224)===224)return Z=this.view.getInt8(this.offset),this.offset++,Z;switch(w){case 192:return this.offset++,null;case 193:this.offset++;return;case 194:return this.offset++,!1;case 195:return this.offset++,!0;case 196:return G=this.view.getUint8(this.offset+1),this.offset+=2,this.bin(G);case 197:return G=this.view.getUint16(this.offset+1),this.offset+=3,this.bin(G);case 198:return G=this.view.getUint32(this.offset+1),this.offset+=5,this.bin(G);case 199:return G=this.view.getUint8(this.offset+1),this.offset+=2,this.ext(G);case 200:return G=this.view.getUint16(this.offset+1),this.offset+=3,this.ext(G);case 201:return G=this.view.getUint32(this.offset+1),this.offset+=5,this.ext(G);case 202:return Z=this.view.getFloat32(this.offset+1),this.offset+=5,Z;case 203:return Z=this.view.getFloat64(this.offset+1),this.offset+=9,Z;case 204:return Z=this.view.getUint8(this.offset+1),this.offset+=2,Z;case 205:return Z=this.view.getUint16(this.offset+1),this.offset+=3,Z;case 206:return Z=this.view.getUint32(this.offset+1),this.offset+=5,Z;case 207:return Z=o2(this.view,this.offset+1),this.offset+=9,Z;case 208:return Z=this.view.getInt8(this.offset+1),this.offset+=2,Z;case 209:return Z=this.view.getInt16(this.offset+1),this.offset+=3,Z;case 210:return Z=this.view.getInt32(this.offset+1),this.offset+=5,Z;case 211:return Z=m2(this.view,this.offset+1),this.offset+=9,Z;case 212:return G=1,this.offset++,this.ext(G);case 213:return G=2,this.offset++,this.ext(G);case 214:return G=4,this.offset++,this.ext(G);case 215:return G=8,this.offset++,this.ext(G);case 216:return G=16,this.offset++,this.ext(G);case 217:return G=this.view.getUint8(this.offset+1),this.offset+=2,this.str(G);case 218:return G=this.view.getUint16(this.offset+1),this.offset+=3,this.str(G);case 219:return G=this.view.getUint32(this.offset+1),this.offset+=5,this.str(G);case 220:return G=this.view.getUint16(this.offset+1),this.offset+=3,this.array(G);case 221:return G=this.view.getUint32(this.offset+1),this.offset+=5,this.array(G);case 222:return G=this.view.getUint16(this.offset+1),this.offset+=3,this.map(G);case 223:return G=this.view.getUint32(this.offset+1),this.offset+=5,this.map(G)}throw Error("Unknown type 0x"+w.toString(16))},this.offset=$||0,this.view=q}};function s2(q){let $=new DataView(q),w=new a2($),Z=w.parse();if(w.offset!==q.byteLength)throw Error(q.byteLength-w.offset+" trailing bytes");return Z}function e7(q,$){return Object.keys(q).filter(function(w){let Z=q[w];return(!$||Z!==void 0&&Z!==null)&&(typeof Z!=="function"||!!Z.toJSON)})}function Nq(q,$,w,Z){let G=typeof q;if(typeof q==="string"){let X=N5(q);if(X<32)return $.setUint8(w,X|160),Jq($,w+1,q),1+X;if(X<256)return $.setUint8(w,217),$.setUint8(w+1,X),Jq($,w+2,q),2+X;if(X<65536)return $.setUint8(w,218),$.setUint16(w+1,X),Jq($,w+3,q),3+X;if(X<4294967296)return $.setUint8(w,219),$.setUint32(w+1,X),Jq($,w+5,q),5+X}if(ArrayBuffer.isView&&ArrayBuffer.isView(q))q=q.buffer;if(q instanceof ArrayBuffer){let X=q.byteLength;if(X<256)return $.setUint8(w,196),$.setUint8(w+1,X),new Uint8Array($.buffer).set(new Uint8Array(q),w+2),2+X;if(X<65536)return $.setUint8(w,197),$.setUint16(w+1,X),new Uint8Array($.buffer).set(new Uint8Array(q),w+3),3+X;if(X<4294967296)return $.setUint8(w,198),$.setUint32(w+1,X),new Uint8Array($.buffer).set(new Uint8Array(q),w+5),5+X}if(typeof q==="number"){if(Math.floor(q)!==q)return $.setUint8(w,203),$.setFloat64(w+1,q),9;if(q>=0){if(q<128)return $.setUint8(w,q),1;if(q<256)return $.setUint8(w,204),$.setUint8(w+1,q),2;if(q<65536)return $.setUint8(w,205),$.setUint16(w+1,q),3;if(q<4294967296)return $.setUint8(w,206),$.setUint32(w+1,q),5;if(q<18446744073709552000)return $.setUint8(w,207),r2($,w+1,q),9;throw Error("Number too big 0x"+q.toString(16))}if(q>=-32)return $.setInt8(w,q),1;if(q>=-128)return $.setUint8(w,208),$.setInt8(w+1,q),2;if(q>=-32768)return $.setUint8(w,209),$.setInt16(w+1,q),3;if(q>=-2147483648)return $.setUint8(w,210),$.setInt32(w+1,q),5;if(q>=-9223372036854776000)return $.setUint8(w,211),l2($,w+1,q),9;throw Error("Number too small -0x"+(-q).toString(16).substr(1))}if(G==="undefined"){if(Z)return 0;return $.setUint8(w,212),$.setUint8(w+1,0),$.setUint8(w+2,0),3}if(q===null){if(Z)return 0;return $.setUint8(w,192),1}if(G==="boolean")return $.setUint8(w,q?195:194),1;if(typeof q.toJSON==="function")return Nq(q.toJSON(),$,w,Z);if(G==="object"){let X,U=0,O,F=Array.isArray(q);if(F)X=q.length;else O=e7(q,Z),X=O.length;if(X<16)$.setUint8(w,X|(F?144:128)),U=1;else if(X<65536)$.setUint8(w,F?220:222),$.setUint16(w+1,X),U=3;else if(X<4294967296)$.setUint8(w,F?221:223),$.setUint32(w+1,X),U=5;if(F)for(let z=0;z<X;z++)U+=Nq(q[z],$,w+U,Z);else if(O)for(let z=0;z<X;z++){let I=O[z];U+=Nq(I,$,w+U),U+=Nq(q[I],$,w+U,Z)}return U}if(G==="function")return 0;throw Error("Unknown type "+G)}function Xq(q,$){let w=typeof q;if(w==="string"){let Z=N5(q);if(Z<32)return 1+Z;if(Z<256)return 2+Z;if(Z<65536)return 3+Z;if(Z<4294967296)return 5+Z}if(ArrayBuffer.isView&&ArrayBuffer.isView(q))q=q.buffer;if(q instanceof ArrayBuffer){let Z=q.byteLength;if(Z<256)return 2+Z;if(Z<65536)return 3+Z;if(Z<4294967296)return 5+Z}if(typeof q==="number"){if(Math.floor(q)!==q)return 9;if(q>=0){if(q<128)return 1;if(q<256)return 2;if(q<65536)return 3;if(q<4294967296)return 5;if(q<18446744073709552000)return 9;throw Error("Number too big 0x"+q.toString(16))}if(q>=-32)return 1;if(q>=-128)return 2;if(q>=-32768)return 3;if(q>=-2147483648)return 5;if(q>=-9223372036854776000)return 9;throw Error("Number too small -0x"+q.toString(16).substr(1))}if(w==="boolean")return 1;if(q===null)return $?0:1;if(q===void 0)return $?0:3;if(typeof q.toJSON==="function")return Xq(q.toJSON(),$);if(w==="object"){let Z,G=0;if(Array.isArray(q)){Z=q.length;for(let X=0;X<Z;X++)G+=Xq(q[X],$)}else{let X=e7(q,$);Z=X.length;for(let U=0;U<Z;U++){let O=X[U];G+=Xq(O)+Xq(q[O],$)}}if(Z<16)return 1+G;if(Z<65536)return 3+G;if(Z<4294967296)return 5+G;throw Error("Array or object too long 0x"+Z.toString(16))}if(w==="function")return 0;throw Error("Unknown type "+w)}var Q5={encode:f2,decode:s2,inspect:t2,utf8Write:Jq,utf8Read:a7,utf8ByteCount:N5};function e2(q,$){return!!$.get("x-ably-errorcode")}function q9(q,$){if(e2(q,$))return q.error&&D.fromValues(q.error)}function $9(q){let $={};return q.forEach((w,Z)=>{$[Z]=w}),$}async function w9(q,$,w,Z,G,X){let U=new Headers(Z||{}),O=q?q.toUpperCase():E0(X)?"GET":"POST",F=new AbortController,z,I=new Promise((M)=>{z=setTimeout(()=>{F.abort(),M({error:new r("Request timed out",null,408)})},$?$.options.timeouts.httpRequestTimeout:k.TIMEOUTS.httpRequestTimeout)}),j={method:O,headers:U,body:X,signal:F.signal};if(!B.Config.isWebworker)j.credentials=U.has("authorization")?"include":"same-origin";let A=(async()=>{try{let M=new URLSearchParams(G||{});M.set("rnd",gq());let E=w+"?"+M,T=await P8().fetch(E,j);if(clearTimeout(z),T.status==204)return{error:null,statusCode:T.status};let d=T.headers.get("Content-Type"),t;if(d&&d.indexOf("application/x-msgpack")>-1)t=await T.arrayBuffer();else if(d&&d.indexOf("application/json")>-1)t=await T.json();else t=await T.text();let a=!!d&&d.indexOf("application/x-msgpack")===-1,D0=$9(T.headers);if(!T.ok)return{error:q9(t,T.headers)||new r("Error response received from server: "+T.status+" body was: "+B.Config.inspect(t),null,T.status),body:t,headers:D0,unpacked:a,statusCode:T.status};else return{error:null,body:t,headers:D0,unpacked:a,statusCode:T.status}}catch(M){return clearTimeout(z),{error:M}}})();return Promise.race([I,A])}var u9={XHRRequest:l7,FetchRequest:w9},qw=D2(m7,p7);B.Crypto=qw,B.BufferUtils=p7,B.Http=t7,B.Config=m7,B.Transports=v2,B.WebStorage=f7;for(let q of[r8,w5])q.Crypto=qw,q._MsgPack=Q5;if(t7.bundledRequestImplementations=u9,Q.initLogHandlers(),B.Defaults=yu(d2),B.Config.agent)B.Defaults.agent+=" "+B.Config.agent;var W9={ErrorInfo:D,Rest:r8,Realtime:w5,msgpack:Q5,makeProtocolMessageFromDeserialized:_7};if(typeof W.exports=="object"&&typeof u=="object"){var Z9=(q,$,w,Z)=>{if($&&typeof $==="object"||typeof $==="function"){for(let G of Object.getOwnPropertyNames($))if(!Object.prototype.hasOwnProperty.call(q,G)&&G!==w)Object.defineProperty(q,G,{get:()=>$[G],enumerable:!(Z=Object.getOwnPropertyDescriptor($,G))||Z.enumerable})}return q};W.exports=Z9(W.exports,u)}return W.exports})});var X6=w0((YN,N6)=>{N6.exports=function(){return typeof Promise==="function"&&Promise.prototype&&Promise.prototype.then}});var N1=w0((SW)=>{var C5,RW=[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706];SW.getSymbolSize=function(W){if(!W)throw Error('"version" cannot be null or undefined');if(W<1||W>40)throw Error('"version" should be in range from 1 to 40');return W*4+17};SW.getSymbolTotalCodewords=function(W){return RW[W]};SW.getBCHDigit=function(u){let W=0;while(u!==0)W++,u>>>=1;return W};SW.setToSJISFunction=function(W){if(typeof W!=="function")throw Error('"toSJISFunc" is not a valid function.');C5=W};SW.isKanjiModeEnabled=function(){return typeof C5<"u"};SW.toSJIS=function(W){return C5(W)}});var B8=w0((kW)=>{kW.L={bit:1};kW.M={bit:0};kW.Q={bit:3};kW.H={bit:2};function CW(u){if(typeof u!=="string")throw Error("Param is not a string");switch(u.toLowerCase()){case"l":case"low":return kW.L;case"m":case"medium":return kW.M;case"q":case"quartile":return kW.Q;case"h":case"high":return kW.H;default:throw Error("Unknown EC Level: "+u)}}kW.isValid=function(W){return W&&typeof W.bit<"u"&&W.bit>=0&&W.bit<4};kW.from=function(W,J){if(kW.isValid(W))return W;try{return CW(W)}catch(N){return J}}});var F6=w0((AN,z6)=>{function V6(){this.buffer=[],this.length=0}V6.prototype={get:function(u){let W=Math.floor(u/8);return(this.buffer[W]>>>7-u%8&1)===1},put:function(u,W){for(let J=0;J<W;J++)this.putBit((u>>>W-J-1&1)===1)},getLengthInBits:function(){return this.length},putBit:function(u){let W=Math.floor(this.length/8);if(this.buffer.length<=W)this.buffer.push(0);if(u)this.buffer[W]|=128>>>this.length%8;this.length++}};z6.exports=V6});var D6=w0((MN,h6)=>{function Eq(u){if(!u||u<1)throw Error("BitMatrix size must be defined and greater than 0");this.size=u,this.data=new Uint8Array(u*u),this.reservedBit=new Uint8Array(u*u)}Eq.prototype.set=function(u,W,J,N){let H=u*this.size+W;if(this.data[H]=J,N)this.reservedBit[H]=!0};Eq.prototype.get=function(u,W){return this.data[u*this.size+W]};Eq.prototype.xor=function(u,W,J){this.data[u*this.size+W]^=J};Eq.prototype.isReserved=function(u,W){return this.reservedBit[u*this.size+W]};h6.exports=Eq});var Y6=w0((iW)=>{var nW=N1().getSymbolSize;iW.getRowColCoords=function(W){if(W===1)return[];let J=Math.floor(W/7)+2,N=nW(W),H=N===145?26:Math.ceil((N-13)/(2*J-2))*2,K=[N-7];for(let V=1;V<J-1;V++)K[V]=K[V-1]-H;return K.push(6),K.reverse()};iW.getPositions=function(W){let J=[],N=iW.getRowColCoords(W),H=N.length;for(let K=0;K<H;K++)for(let V=0;V<H;V++){if(K===0&&V===0||K===0&&V===H-1||K===H-1&&V===0)continue;J.push([N[K],N[V]])}return J}});var I6=w0((vW)=>{var pW=N1().getSymbolSize;vW.getPositions=function(W){let J=pW(W);return[[0,0],[J-7,0],[0,J-7]]}});var S6=w0((tW)=>{tW.Patterns={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};var B1={N1:3,N2:3,N3:40,N4:10};tW.isValid=function(W){return W!=null&&W!==""&&!isNaN(W)&&W>=0&&W<=7};tW.from=function(W){return tW.isValid(W)?parseInt(W,10):void 0};tW.getPenaltyN1=function(W){let J=W.size,N=0,H=0,K=0,V=null,h=null;for(let Y=0;Y<J;Y++){H=K=0,V=h=null;for(let S=0;S<J;S++){let b=W.get(Y,S);if(b===V)H++;else{if(H>=5)N+=B1.N1+(H-5);V=b,H=1}if(b=W.get(S,Y),b===h)K++;else{if(K>=5)N+=B1.N1+(K-5);h=b,K=1}}if(H>=5)N+=B1.N1+(H-5);if(K>=5)N+=B1.N1+(K-5)}return N};tW.getPenaltyN2=function(W){let J=W.size,N=0;for(let H=0;H<J-1;H++)for(let K=0;K<J-1;K++){let V=W.get(H,K)+W.get(H,K+1)+W.get(H+1,K)+W.get(H+1,K+1);if(V===4||V===0)N++}return N*B1.N2};tW.getPenaltyN3=function(W){let J=W.size,N=0,H=0,K=0;for(let V=0;V<J;V++){H=K=0;for(let h=0;h<J;h++){if(H=H<<1&2047|W.get(V,h),h>=10&&(H===1488||H===93))N++;if(K=K<<1&2047|W.get(h,V),h>=10&&(K===1488||K===93))N++}}return N*B1.N3};tW.getPenaltyN4=function(W){let J=0,N=W.data.length;for(let K=0;K<N;K++)J+=W.data[K];return Math.abs(Math.ceil(J*100/N/5)-10)*B1.N4};function dW(u,W,J){switch(u){case tW.Patterns.PATTERN000:return(W+J)%2===0;case tW.Patterns.PATTERN001:return W%2===0;case tW.Patterns.PATTERN010:return J%3===0;case tW.Patterns.PATTERN011:return(W+J)%3===0;case tW.Patterns.PATTERN100:return(Math.floor(W/2)+Math.floor(J/3))%2===0;case tW.Patterns.PATTERN101:return W*J%2+W*J%3===0;case tW.Patterns.PATTERN110:return(W*J%2+W*J%3)%2===0;case tW.Patterns.PATTERN111:return(W*J%3+(W+J)%2)%2===0;default:throw Error("bad maskPattern:"+u)}}tW.applyMask=function(W,J){let N=J.size;for(let H=0;H<N;H++)for(let K=0;K<N;K++){if(J.isReserved(K,H))continue;J.xor(K,H,dW(W,K,H))}};tW.getBestMask=function(W,J){let N=Object.keys(tW.Patterns).length,H=0,K=1/0;for(let V=0;V<N;V++){J(V),tW.applyMask(V,W);let h=tW.getPenaltyN1(W)+tW.getPenaltyN2(W)+tW.getPenaltyN3(W)+tW.getPenaltyN4(W);if(tW.applyMask(V,W),h<K)K=h,H=V}return H}});var y5=w0((oW)=>{var X1=B8(),Y8=[1,1,1,1,1,1,1,1,1,1,2,2,1,2,2,4,1,2,4,4,2,4,4,4,2,4,6,5,2,4,6,6,2,5,8,8,4,5,8,8,4,5,8,11,4,8,10,11,4,9,12,16,4,9,16,16,6,10,12,18,6,10,17,16,6,11,16,19,6,13,18,21,7,14,21,25,8,16,20,25,8,17,23,25,9,17,23,34,9,18,25,30,10,20,27,32,12,21,29,35,12,23,34,37,12,25,34,40,13,26,35,42,14,28,38,45,15,29,40,48,16,31,43,51,17,33,45,54,18,35,48,57,19,37,51,60,19,38,53,63,20,40,56,66,21,43,59,70,22,45,62,74,24,47,65,77,25,49,68,81],I8=[7,10,13,17,10,16,22,28,15,26,36,44,20,36,52,64,26,48,72,88,36,64,96,112,40,72,108,130,48,88,132,156,60,110,160,192,72,130,192,224,80,150,224,264,96,176,260,308,104,198,288,352,120,216,320,384,132,240,360,432,144,280,408,480,168,308,448,532,180,338,504,588,196,364,546,650,224,416,600,700,224,442,644,750,252,476,690,816,270,504,750,900,300,560,810,960,312,588,870,1050,336,644,952,1110,360,700,1020,1200,390,728,1050,1260,420,784,1140,1350,450,812,1200,1440,480,868,1290,1530,510,924,1350,1620,540,980,1440,1710,570,1036,1530,1800,570,1064,1590,1890,600,1120,1680,1980,630,1204,1770,2100,660,1260,1860,2220,720,1316,1950,2310,750,1372,2040,2430];oW.getBlocksCount=function(W,J){switch(J){case X1.L:return Y8[(W-1)*4+0];case X1.M:return Y8[(W-1)*4+1];case X1.Q:return Y8[(W-1)*4+2];case X1.H:return Y8[(W-1)*4+3];default:return}};oW.getTotalCodewordsCount=function(W,J){switch(J){case X1.L:return I8[(W-1)*4+0];case X1.M:return I8[(W-1)*4+1];case X1.Q:return I8[(W-1)*4+2];case X1.H:return I8[(W-1)*4+3];default:return}}});var _6=w0((aW)=>{var Pq=new Uint8Array(512),j8=new Uint8Array(256);(function(){let W=1;for(let J=0;J<255;J++)if(Pq[J]=W,j8[W]=J,W<<=1,W&256)W^=285;for(let J=255;J<512;J++)Pq[J]=Pq[J-255]})();aW.log=function(W){if(W<1)throw Error("log("+W+")");return j8[W]};aW.exp=function(W){return Pq[W]};aW.mul=function(W,J){if(W===0||J===0)return 0;return Pq[j8[W]+j8[J]]}});var T6=w0(($Z)=>{var n5=_6();$Z.mul=function(W,J){let N=new Uint8Array(W.length+J.length-1);for(let H=0;H<W.length;H++)for(let K=0;K<J.length;K++)N[H+K]^=n5.mul(W[H],J[K]);return N};$Z.mod=function(W,J){let N=new Uint8Array(W);while(N.length-J.length>=0){let H=N[0];for(let V=0;V<J.length;V++)N[V]^=n5.mul(J[V],H);let K=0;while(K<N.length&&N[K]===0)K++;N=N.slice(K)}return N};$Z.generateECPolynomial=function(W){let J=new Uint8Array([1]);for(let N=0;N<W;N++)J=$Z.mul(J,new Uint8Array([1,n5.exp(N)]));return J}});var P6=w0((cN,E6)=>{var c6=T6();function i5(u){if(this.genPoly=void 0,this.degree=u,this.degree)this.initialize(this.degree)}i5.prototype.initialize=function(W){this.degree=W,this.genPoly=c6.generateECPolynomial(this.degree)};i5.prototype.encode=function(W){if(!this.genPoly)throw Error("Encoder not initialized");let J=new Uint8Array(W.length+this.degree);J.set(W);let N=c6.mod(J,this.genPoly),H=this.degree-N.length;if(H>0){let K=new Uint8Array(this.degree);return K.set(N,H),K}return N};E6.exports=i5});var g5=w0((WZ)=>{WZ.isValid=function(W){return!isNaN(W)&&W>=1&&W<=40}});var p5=w0((QZ)=>{var Cq="(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+";Cq=Cq.replace(/u/g,"\\u");var GZ="(?:(?![A-Z0-9 $%*+\\-./:]|"+Cq+`)(?:.|[\r
]))+`;QZ.KANJI=new RegExp(Cq,"g");QZ.BYTE_KANJI=new RegExp("[^A-Z0-9 $%*+\\-./:]+","g");QZ.BYTE=new RegExp(GZ,"g");QZ.NUMERIC=new RegExp("[0-9]+","g");QZ.ALPHANUMERIC=new RegExp("[A-Z $%*+\\-./:]+","g");var JZ=new RegExp("^"+Cq+"$"),NZ=new RegExp("^[0-9]+$"),XZ=new RegExp("^[A-Z0-9 $%*+\\-./:]+$");QZ.testKanji=function(W){return JZ.test(W)};QZ.testNumeric=function(W){return NZ.test(W)};QZ.testAlphanumeric=function(W){return XZ.test(W)}});var Q1=w0((YZ)=>{var DZ=g5(),v5=p5();YZ.NUMERIC={id:"Numeric",bit:1,ccBits:[10,12,14]};YZ.ALPHANUMERIC={id:"Alphanumeric",bit:2,ccBits:[9,11,13]};YZ.BYTE={id:"Byte",bit:4,ccBits:[8,16,16]};YZ.KANJI={id:"Kanji",bit:8,ccBits:[8,10,12]};YZ.MIXED={bit:-1};YZ.getCharCountIndicator=function(W,J){if(!W.ccBits)throw Error("Invalid mode: "+W);if(!DZ.isValid(J))throw Error("Invalid version: "+J);if(J>=1&&J<10)return W.ccBits[0];else if(J<27)return W.ccBits[1];return W.ccBits[2]};YZ.getBestModeForData=function(W){if(v5.testNumeric(W))return YZ.NUMERIC;else if(v5.testAlphanumeric(W))return YZ.ALPHANUMERIC;else if(v5.testKanji(W))return YZ.KANJI;else return YZ.BYTE};YZ.toString=function(W){if(W&&W.id)return W.id;throw Error("Invalid mode")};YZ.isValid=function(W){return W&&W.bit&&W.ccBits};function BZ(u){if(typeof u!=="string")throw Error("Param is not a string");switch(u.toLowerCase()){case"numeric":return YZ.NUMERIC;case"alphanumeric":return YZ.ALPHANUMERIC;case"kanji":return YZ.KANJI;case"byte":return YZ.BYTE;default:throw Error("Unknown mode: "+u)}}YZ.from=function(W,J){if(YZ.isValid(W))return W;try{return BZ(W)}catch(N){return J}}});var g6=w0((TZ)=>{var A8=N1(),RZ=y5(),k6=B8(),H1=Q1(),m5=g5(),y6=A8.getBCHDigit(7973);function SZ(u,W,J){for(let N=1;N<=40;N++)if(W<=TZ.getCapacity(N,J,u))return N;return}function n6(u,W){return H1.getCharCountIndicator(u,W)+4}function _Z(u,W){let J=0;return u.forEach(function(N){let H=n6(N.mode,W);J+=H+N.getBitsLength()}),J}function bZ(u,W){for(let J=1;J<=40;J++)if(_Z(u,J)<=TZ.getCapacity(J,W,H1.MIXED))return J;return}TZ.from=function(W,J){if(m5.isValid(W))return parseInt(W,10);return J};TZ.getCapacity=function(W,J,N){if(!m5.isValid(W))throw Error("Invalid QR Code version");if(typeof N>"u")N=H1.BYTE;let H=A8.getSymbolTotalCodewords(W),K=RZ.getTotalCodewordsCount(W,J),V=(H-K)*8;if(N===H1.MIXED)return V;let h=V-n6(N,W);switch(N){case H1.NUMERIC:return Math.floor(h/10*3);case H1.ALPHANUMERIC:return Math.floor(h/11*2);case H1.KANJI:return Math.floor(h/13);case H1.BYTE:default:return Math.floor(h/8)}};TZ.getBestVersionForData=function(W,J){let N,H=k6.from(J,k6.M);if(Array.isArray(W)){if(W.length>1)return bZ(W,H);if(W.length===0)return 1;N=W[0]}else N=W;return SZ(N.mode,N.getLength(),H)};TZ.getEncodedBits=function(W){if(!m5.isValid(W)||W<7)throw Error("Invalid QR Code version");let J=W<<12;while(A8.getBCHDigit(J)-y6>=0)J^=7973<<A8.getBCHDigit(J)-y6;return W<<12|J}});var v6=w0((CZ)=>{var o5=N1(),p6=o5.getBCHDigit(1335);CZ.getEncodedBits=function(W,J){let N=W.bit<<3|J,H=N<<10;while(o5.getBCHDigit(H)-p6>=0)H^=1335<<o5.getBCHDigit(H)-p6;return(N<<10|H)^21522}});var d6=w0((nN,x6)=>{var yZ=Q1();function d1(u){this.mode=yZ.NUMERIC,this.data=u.toString()}d1.getBitsLength=function(W){return 10*Math.floor(W/3)+(W%3?W%3*3+1:0)};d1.prototype.getLength=function(){return this.data.length};d1.prototype.getBitsLength=function(){return d1.getBitsLength(this.data.length)};d1.prototype.write=function(W){let J,N,H;for(J=0;J+3<=this.data.length;J+=3)N=this.data.substr(J,3),H=parseInt(N,10),W.put(H,10);let K=this.data.length-J;if(K>0)N=this.data.substr(J),H=parseInt(N,10),W.put(H,K*3+1)};x6.exports=d1});var f6=w0((iN,t6)=>{var nZ=Q1(),l5=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"," ","$","%","*","+","-",".","/",":"];function t1(u){this.mode=nZ.ALPHANUMERIC,this.data=u}t1.getBitsLength=function(W){return 11*Math.floor(W/2)+6*(W%2)};t1.prototype.getLength=function(){return this.data.length};t1.prototype.getBitsLength=function(){return t1.getBitsLength(this.data.length)};t1.prototype.write=function(W){let J;for(J=0;J+2<=this.data.length;J+=2){let N=l5.indexOf(this.data[J])*45;N+=l5.indexOf(this.data[J+1]),W.put(N,11)}if(this.data.length%2)W.put(l5.indexOf(this.data[J]),6)};t6.exports=t1});var o6=w0((gN,m6)=>{var iZ=Q1();function f1(u){if(this.mode=iZ.BYTE,typeof u==="string")this.data=new TextEncoder().encode(u);else this.data=new Uint8Array(u)}f1.getBitsLength=function(W){return W*8};f1.prototype.getLength=function(){return this.data.length};f1.prototype.getBitsLength=function(){return f1.getBitsLength(this.data.length)};f1.prototype.write=function(u){for(let W=0,J=this.data.length;W<J;W++)u.put(this.data[W],8)};m6.exports=f1});var r6=w0((pN,l6)=>{var gZ=Q1(),pZ=N1();function m1(u){this.mode=gZ.KANJI,this.data=u}m1.getBitsLength=function(W){return W*13};m1.prototype.getLength=function(){return this.data.length};m1.prototype.getBitsLength=function(){return m1.getBitsLength(this.data.length)};m1.prototype.write=function(u){let W;for(W=0;W<this.data.length;W++){let J=pZ.toSJIS(this.data[W]);if(J>=33088&&J<=40956)J-=33088;else if(J>=57408&&J<=60351)J-=49472;else throw Error("Invalid SJIS character: "+this.data[W]+`
Make sure your charset is UTF-8`);J=(J>>>8&255)*192+(J&255),u.put(J,13)}};l6.exports=m1});var a6=w0((vN,r5)=>{var kq={single_source_shortest_paths:function(u,W,J){var N={},H={};H[W]=0;var K=kq.PriorityQueue.make();K.push(W,0);var V,h,Y,S,b,_,c,u0,x;while(!K.empty()){V=K.pop(),h=V.value,S=V.cost,b=u[h]||{};for(Y in b)if(b.hasOwnProperty(Y)){if(_=b[Y],c=S+_,u0=H[Y],x=typeof H[Y]>"u",x||u0>c)H[Y]=c,K.push(Y,c),N[Y]=h}}if(typeof J<"u"&&typeof H[J]>"u"){var P=["Could not find a path from ",W," to ",J,"."].join("");throw Error(P)}return N},extract_shortest_path_from_predecessor_list:function(u,W){var J=[],N=W,H;while(N)J.push(N),H=u[N],N=u[N];return J.reverse(),J},find_path:function(u,W,J){var N=kq.single_source_shortest_paths(u,W,J);return kq.extract_shortest_path_from_predecessor_list(N,J)},PriorityQueue:{make:function(u){var W=kq.PriorityQueue,J={},N;u=u||{};for(N in W)if(W.hasOwnProperty(N))J[N]=W[N];return J.queue=[],J.sorter=u.sorter||W.default_sorter,J},default_sorter:function(u,W){return u.cost-W.cost},push:function(u,W){var J={value:u,cost:W};this.queue.push(J),this.queue.sort(this.sorter)},pop:function(){return this.queue.shift()},empty:function(){return this.queue.length===0}}};if(typeof r5<"u")r5.exports=kq});var Zu=w0((fZ)=>{var s=Q1(),qu=d6(),$u=f6(),wu=o6(),uu=r6(),yq=p5(),M8=N1(),vZ=a6();function s6(u){return unescape(encodeURIComponent(u)).length}function nq(u,W,J){let N=[],H;while((H=u.exec(J))!==null)N.push({data:H[0],index:H.index,mode:W,length:H[0].length});return N}function Wu(u){let W=nq(yq.NUMERIC,s.NUMERIC,u),J=nq(yq.ALPHANUMERIC,s.ALPHANUMERIC,u),N,H;if(M8.isKanjiModeEnabled())N=nq(yq.BYTE,s.BYTE,u),H=nq(yq.KANJI,s.KANJI,u);else N=nq(yq.BYTE_KANJI,s.BYTE,u),H=[];return W.concat(J,N,H).sort(function(V,h){return V.index-h.index}).map(function(V){return{data:V.data,mode:V.mode,length:V.length}})}function a5(u,W){switch(W){case s.NUMERIC:return qu.getBitsLength(u);case s.ALPHANUMERIC:return $u.getBitsLength(u);case s.KANJI:return uu.getBitsLength(u);case s.BYTE:return wu.getBitsLength(u)}}function xZ(u){return u.reduce(function(W,J){let N=W.length-1>=0?W[W.length-1]:null;if(N&&N.mode===J.mode)return W[W.length-1].data+=J.data,W;return W.push(J),W},[])}function dZ(u){let W=[];for(let J=0;J<u.length;J++){let N=u[J];switch(N.mode){case s.NUMERIC:W.push([N,{data:N.data,mode:s.ALPHANUMERIC,length:N.length},{data:N.data,mode:s.BYTE,length:N.length}]);break;case s.ALPHANUMERIC:W.push([N,{data:N.data,mode:s.BYTE,length:N.length}]);break;case s.KANJI:W.push([N,{data:N.data,mode:s.BYTE,length:s6(N.data)}]);break;case s.BYTE:W.push([{data:N.data,mode:s.BYTE,length:s6(N.data)}])}}return W}function tZ(u,W){let J={},N={start:{}},H=["start"];for(let K=0;K<u.length;K++){let V=u[K],h=[];for(let Y=0;Y<V.length;Y++){let S=V[Y],b=""+K+Y;h.push(b),J[b]={node:S,lastCount:0},N[b]={};for(let _=0;_<H.length;_++){let c=H[_];if(J[c]&&J[c].node.mode===S.mode)N[c][b]=a5(J[c].lastCount+S.length,S.mode)-a5(J[c].lastCount,S.mode),J[c].lastCount+=S.length;else{if(J[c])J[c].lastCount=S.length;N[c][b]=a5(S.length,S.mode)+4+s.getCharCountIndicator(S.mode,W)}}}H=h}for(let K=0;K<H.length;K++)N[H[K]].end=0;return{map:N,table:J}}function e6(u,W){let J,N=s.getBestModeForData(u);if(J=s.from(W,N),J!==s.BYTE&&J.bit<N.bit)throw Error('"'+u+'" cannot be encoded with mode '+s.toString(J)+`.
 Suggested mode is: `+s.toString(N));if(J===s.KANJI&&!M8.isKanjiModeEnabled())J=s.BYTE;switch(J){case s.NUMERIC:return new qu(u);case s.ALPHANUMERIC:return new $u(u);case s.KANJI:return new uu(u);case s.BYTE:return new wu(u)}}fZ.fromArray=function(W){return W.reduce(function(J,N){if(typeof N==="string")J.push(e6(N,null));else if(N.data)J.push(e6(N.data,N.mode));return J},[])};fZ.fromString=function(W,J){let N=Wu(W,M8.isKanjiModeEnabled()),H=dZ(N),K=tZ(H,J),V=vZ.find_path(K.map,"start","end"),h=[];for(let Y=1;Y<V.length-1;Y++)h.push(K.table[V[Y]].node);return fZ.fromArray(xZ(h))};fZ.rawSplit=function(W){return fZ.fromArray(Wu(W,M8.isKanjiModeEnabled()))}});var Gu=w0((QG)=>{var R8=N1(),e5=B8(),lZ=F6(),rZ=D6(),aZ=Y6(),sZ=I6(),w$=S6(),u$=y5(),eZ=P6(),L8=g6(),qG=v6(),$G=Q1(),q$=Zu();function wG(u,W){let J=u.size,N=sZ.getPositions(W);for(let H=0;H<N.length;H++){let K=N[H][0],V=N[H][1];for(let h=-1;h<=7;h++){if(K+h<=-1||J<=K+h)continue;for(let Y=-1;Y<=7;Y++){if(V+Y<=-1||J<=V+Y)continue;if(h>=0&&h<=6&&(Y===0||Y===6)||Y>=0&&Y<=6&&(h===0||h===6)||h>=2&&h<=4&&Y>=2&&Y<=4)u.set(K+h,V+Y,!0,!0);else u.set(K+h,V+Y,!1,!0)}}}}function uG(u){let W=u.size;for(let J=8;J<W-8;J++){let N=J%2===0;u.set(J,6,N,!0),u.set(6,J,N,!0)}}function WG(u,W){let J=aZ.getPositions(W);for(let N=0;N<J.length;N++){let H=J[N][0],K=J[N][1];for(let V=-2;V<=2;V++)for(let h=-2;h<=2;h++)if(V===-2||V===2||h===-2||h===2||V===0&&h===0)u.set(H+V,K+h,!0,!0);else u.set(H+V,K+h,!1,!0)}}function ZG(u,W){let J=u.size,N=L8.getEncodedBits(W),H,K,V;for(let h=0;h<18;h++)H=Math.floor(h/3),K=h%3+J-8-3,V=(N>>h&1)===1,u.set(H,K,V,!0),u.set(K,H,V,!0)}function $$(u,W,J){let N=u.size,H=qG.getEncodedBits(W,J),K,V;for(K=0;K<15;K++){if(V=(H>>K&1)===1,K<6)u.set(K,8,V,!0);else if(K<8)u.set(K+1,8,V,!0);else u.set(N-15+K,8,V,!0);if(K<8)u.set(8,N-K-1,V,!0);else if(K<9)u.set(8,15-K-1+1,V,!0);else u.set(8,15-K-1,V,!0)}u.set(N-8,8,1,!0)}function GG(u,W){let J=u.size,N=-1,H=J-1,K=7,V=0;for(let h=J-1;h>0;h-=2){if(h===6)h--;while(!0){for(let Y=0;Y<2;Y++)if(!u.isReserved(H,h-Y)){let S=!1;if(V<W.length)S=(W[V]>>>K&1)===1;if(u.set(H,h-Y,S),K--,K===-1)V++,K=7}if(H+=N,H<0||J<=H){H-=N,N=-N;break}}}}function JG(u,W,J){let N=new lZ;J.forEach(function(Y){N.put(Y.mode.bit,4),N.put(Y.getLength(),$G.getCharCountIndicator(Y.mode,u)),Y.write(N)});let H=R8.getSymbolTotalCodewords(u),K=u$.getTotalCodewordsCount(u,W),V=(H-K)*8;if(N.getLengthInBits()+4<=V)N.put(0,4);while(N.getLengthInBits()%8!==0)N.putBit(0);let h=(V-N.getLengthInBits())/8;for(let Y=0;Y<h;Y++)N.put(Y%2?17:236,8);return NG(N,u,W)}function NG(u,W,J){let N=R8.getSymbolTotalCodewords(W),H=u$.getTotalCodewordsCount(W,J),K=N-H,V=u$.getBlocksCount(W,J),h=N%V,Y=V-h,S=Math.floor(N/V),b=Math.floor(K/V),_=b+1,c=S-b,u0=new eZ(c),x=0,P=Array(V),f=Array(V),p=0,B=new Uint8Array(u.buffer);for(let l=0;l<V;l++){let H0=l<Y?b:_;P[l]=B.slice(x,x+H0),f[l]=u0.encode(P[l]),x+=H0,p=Math.max(p,H0)}let e=new Uint8Array(N),N0=0,$0,G0;for($0=0;$0<p;$0++)for(G0=0;G0<V;G0++)if($0<P[G0].length)e[N0++]=P[G0][$0];for($0=0;$0<c;$0++)for(G0=0;G0<V;G0++)e[N0++]=f[G0][$0];return e}function XG(u,W,J,N){let H;if(Array.isArray(u))H=q$.fromArray(u);else if(typeof u==="string"){let S=W;if(!S){let b=q$.rawSplit(u);S=L8.getBestVersionForData(b,J)}H=q$.fromString(u,S||40)}else throw Error("Invalid data");let K=L8.getBestVersionForData(H,J);if(!K)throw Error("The amount of data is too big to be stored in a QR Code");if(!W)W=K;else if(W<K)throw Error(`
The chosen QR Code version cannot contain this amount of data.
Minimum version required to store current data is: `+K+`.
`);let V=JG(W,J,H),h=R8.getSymbolSize(W),Y=new rZ(h);if(wG(Y,W),uG(Y),WG(Y,W),$$(Y,J,0),W>=7)ZG(Y,W);if(GG(Y,V),isNaN(N))N=w$.getBestMask(Y,$$.bind(null,Y,J));return w$.applyMask(N,Y),$$(Y,J,N),{modules:Y,version:W,errorCorrectionLevel:J,maskPattern:N,segments:H}}QG.create=function(W,J){if(typeof W>"u"||W==="")throw Error("No input text");let N=e5.M,H,K;if(typeof J<"u"){if(N=e5.from(J.errorCorrectionLevel,e5.M),H=L8.from(J.version),K=w$.from(J.maskPattern),J.toSJISFunc)R8.setToSJISFunction(J.toSJISFunc)}return XG(W,H,N,K)}});var Z$=w0((UG)=>{function Ju(u){if(typeof u==="number")u=u.toString();if(typeof u!=="string")throw Error("Color should be defined as hex string");let W=u.slice().replace("#","").split("");if(W.length<3||W.length===5||W.length>8)throw Error("Invalid hex color: "+u);if(W.length===3||W.length===4)W=Array.prototype.concat.apply([],W.map(function(N){return[N,N]}));if(W.length===6)W.push("F","F");let J=parseInt(W.join(""),16);return{r:J>>24&255,g:J>>16&255,b:J>>8&255,a:J&255,hex:"#"+W.slice(0,6).join("")}}UG.getOptions=function(W){if(!W)W={};if(!W.color)W.color={};let J=typeof W.margin>"u"||W.margin===null||W.margin<0?4:W.margin,N=W.width&&W.width>=21?W.width:void 0,H=W.scale||4;return{width:N,scale:N?4:H,margin:J,color:{dark:Ju(W.color.dark||"#000000ff"),light:Ju(W.color.light||"#ffffffff")},type:W.type,rendererOpts:W.rendererOpts||{}}};UG.getScale=function(W,J){return J.width&&J.width>=W+J.margin*2?J.width/(W+J.margin*2):J.scale};UG.getImageWidth=function(W,J){let N=UG.getScale(W,J);return Math.floor((W+J.margin*2)*N)};UG.qrToImageData=function(W,J,N){let H=J.modules.size,K=J.modules.data,V=UG.getScale(H,N),h=Math.floor((H+N.margin*2)*V),Y=N.margin*V,S=[N.color.light,N.color.dark];for(let b=0;b<h;b++)for(let _=0;_<h;_++){let c=(b*h+_)*4,u0=N.color.light;if(b>=Y&&_>=Y&&b<h-Y&&_<h-Y){let x=Math.floor((b-Y)/V),P=Math.floor((_-Y)/V);u0=S[K[x*H+P]?1:0]}W[c++]=u0.r,W[c++]=u0.g,W[c++]=u0.b,W[c]=u0.a}}});var Xu=w0((hG)=>{var G$=Z$();function zG(u,W,J){if(u.clearRect(0,0,W.width,W.height),!W.style)W.style={};W.height=J,W.width=J,W.style.height=J+"px",W.style.width=J+"px"}function FG(){try{return document.createElement("canvas")}catch(u){throw Error("You need to specify a canvas element")}}hG.render=function(W,J,N){let H=N,K=J;if(typeof H>"u"&&(!J||!J.getContext))H=J,J=void 0;if(!J)K=FG();H=G$.getOptions(H);let V=G$.getImageWidth(W.modules.size,H),h=K.getContext("2d"),Y=h.createImageData(V,V);return G$.qrToImageData(Y.data,W,H),zG(h,K,V),h.putImageData(Y,0,0),K};hG.renderToDataURL=function(W,J,N){let H=N;if(typeof H>"u"&&(!J||!J.getContext))H=J,J=void 0;if(!H)H={};let K=hG.render(W,J,H),V=H.type||"image/png",h=H.rendererOpts||{};return K.toDataURL(V,h.quality)}});var Hu=w0((IG)=>{var BG=Z$();function Qu(u,W){let J=u.a/255,N=W+'="'+u.hex+'"';return J<1?N+" "+W+'-opacity="'+J.toFixed(2).slice(1)+'"':N}function J$(u,W,J){let N=u+W;if(typeof J<"u")N+=" "+J;return N}function YG(u,W,J){let N="",H=0,K=!1,V=0;for(let h=0;h<u.length;h++){let Y=Math.floor(h%W),S=Math.floor(h/W);if(!Y&&!K)K=!0;if(u[h]){if(V++,!(h>0&&Y>0&&u[h-1]))N+=K?J$("M",Y+J,0.5+S+J):J$("m",H,0),H=0,K=!1;if(!(Y+1<W&&u[h+1]))N+=J$("h",V),V=0}else H++}return N}IG.render=function(W,J,N){let H=BG.getOptions(J),K=W.modules.size,V=W.modules.data,h=K+H.margin*2,Y=!H.color.light.a?"":"<path "+Qu(H.color.light,"fill")+' d="M0 0h'+h+"v"+h+'H0z"/>',S="<path "+Qu(H.color.dark,"stroke")+' d="'+YG(V,K,H.margin)+'"/>',b='viewBox="0 0 '+h+" "+h+'"',c='<svg xmlns="http://www.w3.org/2000/svg" '+(!H.width?"":'width="'+H.width+'" height="'+H.width+'" ')+b+' shape-rendering="crispEdges">'+Y+S+`</svg>
`;if(typeof N==="function")N(null,c);return c}});function _0(u){if(u==null)return u;if(u instanceof Function)return u;let W=typeof u;if(W==="string")return(J,N)=>{return L(J,u,N)};if(W==="object")return(J,N)=>{return L(u,J,N)};return u}var ww=Object.prototype.hasOwnProperty;function uw(u,W,J){for(J of u.keys())if(Hq(J,W))return J}function Hq(u,W){if(u===W)return!0;var J,N,H;if(u&&W&&(J=u.constructor)===W.constructor){if(J===Array){if((N=u.length)===W.length)while(N--&&Hq(u[N],W[N]));return N===-1}if(J===Set){if(u.size!==W.size)return!1;for(let K of u){if(H=K,H&&typeof H==="object"){if(H=uw(W,H),!H)return!1}if(!W.has(H))return!1}return!0}if(J===Map){if(u.size!==W.size)return!1;for(let K of u){if(H=K[0],H&&typeof H==="object"){if(H=uw(W,H),!H)return!1}if(!Hq(N[1],W.get(H)))return!1}return!0}if(!J||typeof u==="object"){N=0;for(let K in u){if(ww.call(u,K)&&++N&&!ww.call(W,K))return!1;if(!(K in W)||!Hq(u[K],W[K]))return!1}return Object.keys(W).length===N}}return!1}function H9(u,W){return u.every(function(J,N){return N===0||W(u[N-1],J)})}function w1(...u){return H9(u,(W,J)=>Hq(W,J))}function Kq(...u){return u.reduce((W,J)=>W+J,0)}function U5(u,W,J,...N){if(N.length%2!==0)throw Error("Illegal argument: assoc expects an odd number of arguments.");switch(p0(u)){case r0:u.set(W,J);for(let H=0;H<N.length;H+=2)u.set(N[H],N[H+1]);break;case a0:case l0:u[W]=J;for(let H=0;H<N.length;H+=2)u[N[H]]=N[H+1];break;default:throw Error(`Illegal argument: assoc! expects a Map, Array, or Object as the first argument, but got ${typeof u}.`)}return u}function Ww(u){switch(p0(u)){case r0:return new Map(u);case z1:return new u.constructor(u);case a0:return[...u];case l0:return{...u};default:throw Error(`Don't know how to copy object of type ${typeof u}.`)}}function J0(u,W,J,...N){if(!u)u={};let H=Ww(u);return U5(H,W,J,...N),H}var r0=1,a0=2,l0=3,eq=4,z1=5,K5=6;function O5(u){switch(u){case r0:return new Map;case a0:return[];case l0:return{};case eq:return new Fq;case z1:return new Set;case K5:return Z0(function*(){return})}return}function Zw(u){return u.constructor===Object}function p0(u){if(u==null)return;if(Zw(u))return l0;if(u instanceof Map)return r0;if(u instanceof Set)return z1;if(u instanceof Fq)return eq;if(Array.isArray(u))return a0;if(u instanceof $8)return K5;if(u instanceof Z8)return z1;if(u instanceof Object)return l0;return}function U9(u,W,J,N,H){N=q1(N),J=J||{};let K=p0(J);if(K!==r0&&K!==a0&&K!==l0)throw Error(`Illegal argument: ${W} expects the first argument to be a Map, Array, or Object.`);let V=[J],h=J;for(let Y=0;Y<N.length-1;Y+=1){let S=N[Y],b;if(h instanceof Map)b=h.get(S);else b=h[S];if(!b)b=O5(K);V.push(b),h=b}V.push(H);for(let Y=V.length-2;Y>=0;Y-=1)V[Y]=u(V[Y],N[Y],V[Y+1]);return V[0]}function Oq(u,W,J){return U9(J0,"assoc-in",u,W,J)}function Gw(u,W){for(let J of W)u.add(J);return u}function Jw(...u){if(u.length===0)return W1();let[W,...J]=u,N=W;if(N===null||N===void 0)N=[];switch(p0(N)){case z1:Gw(N,J);break;case eq:N.unshift(...J.reverse());break;case a0:N.push(...J);break;case r0:for(let H of J)if(!Array.isArray(H))g(H).forEach((K)=>{N.set(K[0],K[1])});else N.set(H[0],H[1]);break;case l0:for(let H of J)if(!Array.isArray(H))Object.assign(N,H);else N[H[0]]=H[1];break;default:throw Error("Illegal argument: conj! expects a Set, Array, List, Map, or Object as the first argument.")}return N}function Vq(...u){if(u.length===0)return W1();let[W,...J]=u,N=W;if(N===null||N===void 0)N=j9();let H,K;switch(p0(N)){case z1:if(N instanceof Z8)return Gw(new N.constructor(N),J);else return new N.constructor([...N,...J]);case eq:return new Fq(...J.reverse(),...N);case a0:return[...N,...J];case r0:H=new Map(N);for(let V of J)if(!Array.isArray(V))g(V).forEach((h)=>{H.set(h[0],h[1])});else H.set(V[0],V[1]);return H;case K5:return Z0(function*(){yield*J,yield*N});case l0:K={...N};for(let V of J)if(!Array.isArray(V))Object.assign(K,V);else K[V[0]]=V[1];return K;default:throw Error("Illegal argument: conj expects a Set, Array, List, Map, or Object as the first argument.")}}function K9(u){return u+1}function v0(...u){console.log(...u)}function b0(u,W,J){if(u){var N=void 0;if(Array.isArray(u))N=u[W];else{let H=g(u),K=0;for(let V of H)if(K++==W){N=V;break}}if(N!==void 0)return N}return J}function L(u,W,J=void 0){if(u==null)return J;let N;if(Zw(u))if(N=u[W],N===void 0)return J;else return N;let H;switch(p0(u)){case z1:if(u.has(W))N=W;break;case r0:N=u.get(W);break;case a0:N=u[W];break;default:if(H=u.get,H instanceof Function)try{N=u.get(W);break}catch(K){}N=u[W];break}return N!==void 0?N:J}function O9(u){return u===null||u===void 0||!!u[Symbol.iterator]}function g(u){if(u===null||u===void 0)return[];if(O9(u))return u;if(u instanceof Object)return Object.entries(u);throw TypeError(`${u} is not iterable`)}var V9=Symbol("Iterable");function z9(u){return u[Symbol.iterator]()}var F9=z9;function Y0(u){if(u==null)return u;let W=g(u);if(W.length===0||W.size===0)return null;if(W[Symbol.iterator]().next().done)return null;return W}function s0(u){let[W]=g(u);return W}function Nw(u){return Z0(function*(){let W=!0;for(let J of g(u))if(W)W=!1;else yield J})}class Uq{value;constructor(u){this.value=u}_deref(){return this.value}}function q8(u){u=g(u);let W;switch(p0(u)){case a0:return u[u.length-1];default:for(let J of u)W=J;return W}}function h9(u){return new Uq(u)}function D9(u){return u instanceof Uq}function E1(u,W,J){u=_0(u);let N,H;if(arguments.length===2){let K=g(W)[Symbol.iterator](),V=K.next();if(V.done)H=u();else H=V.value;N=K}else H=W,N=g(J);if(H instanceof Uq)return H.value;for(let K of N)if(H=u(H,K),H instanceof Uq){H=H.value;break}return H}var B9=!1;class $8{constructor(u){this.gen=u,this.usages=0}[Symbol.iterator](){if(this.usages++,this.usages>=2&&B9)try{throw Error()}catch(u){console.warn("Re-use of lazy value",u.stack)}return this.gen()}}$8.prototype[V9]=!0;function Z0(u){return new $8(u)}class Xw{constructor(u,W){this.x=u,this.coll=W}*[Symbol.iterator](){yield this.x,yield*g(this.coll)}}function Qw(u,W){return new Xw(u,W)}function u1(u,...W){switch(u=_0(u),W.length){case 0:return(J)=>{return(...N)=>{switch(N.length){case 0:return J();case 1:return J(N[0]);case 2:return J(N[0],u(N[1]));default:return J(N[0],u(...N.slice(1)))}}};case 1:return Z0(function*(){for(let J of g(W[0]))yield u(J)});default:return Z0(function*(){let J=W.map((N)=>F9(g(N)));while(!0){let N=[];for(let H of J){let K=H.next();if(K.done)return;N.push(K.value)}yield u(...N)}})}}function Y9(u){return(W)=>{return(...J)=>{switch(J.length){case 0:return W();case 1:return W(J[0]);case 2:{let N=J[0],H=J[1];if(R(u(H)))return W(N,H);else return N}}}}}function V5(u,W){if(arguments.length===1)return Y9(u);return u=_0(u),Z0(function*(){for(let J of g(W))if(R(u(J)))yield J})}function Hw(u,W){return[...V5(u,W)]}function I9(u){return(W)=>{let J=-1;return(...N)=>{switch(N.length){case 0:return W();case 1:return W(N[0]);case 2:return W(N[0],u((J=J+1,J),N[1]))}}}}function F1(u,W){if(u=_0(u),arguments.length===1)return I9(u);return Z0(function*(){let J=0;for(let N of g(W))yield u(J,N),J++})}function m(...u){return u.join("")}function zq(u){return!R(u)}class Uw{constructor(u){this.val=u,this._watches={},this._deref=()=>this.val,this._hasWatches=!1,this._reset_BANG_=(W)=>{let J=this.val;if(this.val=W,this._hasWatches)for(let N of Object.entries(this._watches)){let H=N[0],K=N[1];K(H,this,J,W)}return W},this._add_watch=(W,J)=>{this._watches[W]=J,this._hasWatches=!0},this._remove_watch=(W)=>{delete this._watches[W]}}}function e0(u){return new Uw(u)}function i(u){return u._deref()}function P1(u,W){u._reset_BANG_(W)}function q0(u,W,...J){W=_0(W);let N=W(i(u),...J);return P1(u,N),N}function z5(u,W,J){return Z0(function*(){let N=u,H=W,K=J;if(W===void 0)N=0,H=u;let V=N||0;K=J??1;let h=K>=0;while(H===void 0||h&&V<H||!h&&H<V)yield V,V+=K})}function W1(...u){return u}function Kw(...u){if(u.length===2){let[N,H]=u,K=g(H);if(Array.isArray(K)){let V=Array(K.length);for(var W=0;W<K.length;W++)V[W]=N(K[W]);return V}else{var J=[];for(let V of K)J.push(N(V));return J}}return[...u1(...u)]}function q1(u){if(A9(u))return u;return[...g(u)]}var Ow=Symbol("IApply__apply");function C1(u,...W){u=_0(u);let J=W.slice(0,W.length-1),N=g(W[W.length-1]),H=u[Ow];if(H)return H(...J,N);return u(...J,...N)}class Fq extends Array{constructor(...u){super();this.push(...u)}}function j9(...u){return new Fq(...u)}function A9(u){return Array.isArray(u)}function Vw(u){return Z0(function*(){for(let W of u)yield*g(W)})}function F5(...u){return Vw(u)}F5[Ow]=(u)=>{return Vw(u)};function k1(u){return u}function y1(u,W){let J=p0(u),N=O5(J)||{};for(let H of W){let K=L(u,H);if(K!=null)U5(N,H,K)}return N}function M9(u){let W=p0(u);if(W!=null)return O5(W);else throw Error(`Can't create empty of ${typeof u}`)}function Z1(...u){let W=u[0],J;if(W===null||W===void 0)J={};else J=hq(M9(W),W);return Jw(J,...u.slice(1))}function hq(...u){let W,J,N,H,K;switch(u.length){case 0:return[];case 1:return u[0];case 2:return Vq(u[0]??[],...g(u[1]));case 3:return W=u[0],J=u[1],N=u[2],H=Ww(W),K=(V,h)=>{if(h===void 0)return V;return Jw(V,h)},Lw(J,K,H,N);default:throw TypeError(`Invalid arity call of into: ${u.length}`)}}function L9(u){if(D9(u))return u;else return h9(u)}function R9(u){return(W)=>{let J=u;return(...N)=>{let H=N.length;if(H===0)return W();if(H===1){let K=N[0];return W(K)}if(H===2){let K=N[0],V=N[1],h=J,Y=(J=J-1,J);if(h>0)K=W(K,V);if(!(Y>0))return L9(K);else return K}}}}function zw(u,W){if(arguments.length===1)return R9(u);return Z0(function*(){let J=u-1;for(let N of g(W)){if(J-->=0)yield N;if(J<0)return}})}function Fw(u,W){if(u==0)return null;if(Array.isArray(W))return Y0(W.slice(-Math.abs(u)));else{let J=Array(u),N=0;for(let H of g(W))J[N%u]=H,N++;if(N%u!==0&&N>=u)return J.slice(N%u).concat(J.slice(0,N%u));else return J.length=Math.min(N,u),J}}function w8(u,W,J,...N){return J=_0(J),J0(u,W,J(L(u,W),...N))}function L0(u,W,J){let N=u;for(let H of W)N=L(N,H);if(N===void 0)return J;return N}function hw(u,W,J,...N){return J=_0(J),Oq(u,W,J(L0(u,W),...N))}function h5(u,W,...J){return u=_0(u),function(N,...H){if(!N)return u(W,...J,...H);else return u(N,...J,...H)}}function Dw(u,W){if(arguments.length===1)W=u,u=void 0;return u=_0(u),W=g(W),[...W].sort(u||Bq)}function S9(u){if(u===Bq)return u;return(W,J)=>{let N=u(W,J);if(b9(N))return N;if(N)return-1;if(u(J,W))return 1;return 0}}function Bw(u,W,J){if(arguments.length===2)J=W,W=Bq;return u=_0(u),W=_0(W),Dw((N,H)=>{let K=S9(W),V=u(N),h=u(H);return K(V,h)},J)}function Yw(u,W){u=_0(u);for(let J of g(W)){let N=u(J);if(R(N))return N}return}function Iw(u){return Y0(u)?!1:!0}function D5(u){return Math.floor(Math.random()*u)}function jw(u){let W=D5(I0(u));return b0(u,W)}function _9(u,W,J,...N){let H=L(u,W);return U5(u,W,J(H,...N))}function B5(u){let W={},J=h5(K9,0);for(let N of g(u))_9(W,N,J);return W}function I0(u){if(!u)return 0;let W=u.length||u.size;if(typeof W==="number")return W;let J=0;for(let N of g(u))J++;return J}function G1(u,W,J){return u._add_watch(W,J)}function Dq(u,W,...J){if(W==null)return u;return Math.max(u,W,...J)}function Aw(u,W,...J){if(W==null)return u;return Math.min(u,W,...J)}function Bq(u,W){if(u===W)return 0;else{if(u==null)return-1;if(W==null)return 1;let J=typeof u,N=typeof W;if(J==="number"&&N==="number"||J==="string"&&N==="string"){if(u===W)return 0;if(u<W)return-1;return 1}else if(Array.isArray(u)&&Array.isArray(W))if(u.length<W.length)return-1;else if(u.length>W.length)return 1;else{for(let H=0;H<u.length;H++){let K=Bq(u[H],W[H]);if(K!=0)return K}return 0}else throw Error(`comparing ${J} to ${N}`)}}function R(u){return u!=null&&u!==!1}function Mw(u,W,J){return u.substring(W,J)}function b9(u){return typeof u=="number"}function u8(u){if(u==null)return;switch(p0(u)){case l0:return Object.values(u);case r0:return Array.from(u.values())}}function W8(u){return typeof u==="string"}var IJ=Symbol("meta");function Lw(u,...W){switch(W.length){case 2:{let J=W[0],N=W[1];return Lw(u,J,J(),N)}default:{let J=W[0],N=W[1],H=W[2];J=u(J);let K=E1(J,N,H);return J(K)}}}class Z8{constructor(u){if(!(u instanceof Z8))u=Dw(u);let J=new Set(u);this._elts=[...J],this._set=J}add(u){if(this._set.has(u))return this;let W=this._elts,J=!1;for(let N=0;N<W.length;N++)if(Bq(u,W[N])<=0){W.splice(N,0,u),J=!0;break}if(!J)W.push(u),this._set.add(u);else this._set=new Set(W);return this.size=W.length,this}delete(u){if(!this._set.has(u))return this;let W=this._elts,J=W.indexOf(u);return W.splice(J,1),this._set=new Set(W),this.size=W.length,this}has(u){return this._set.has(u)}keys(){return this.values()}values(){return this._elts[Symbol.iterator]()}entries(){return this._set.entries()}forEach(...u){return this.set.forEach(...u)}clear(){this._elts=[],this._set=new Set(this._elts)}[Symbol.iterator](){return this.keys()}}function G8(){return crypto.randomUUID()}function Yq(u){if(u==null)return u;if(u instanceof Function)return u;let W=typeof u;if(W==="string")return(J,N)=>{return Y5(J,u,N)};if(W==="object")return(J,N)=>{return Y5(u,J,N)};return u}function T9(u,W,J,...N){if(N.length%2!==0)throw Error("Illegal argument: assoc expects an odd number of arguments.");switch(H8(u)){case X8:u.set(W,J);for(let H=0;H<N.length;H+=2)u.set(N[H],N[H+1]);break;case Iq:case J8:u[W]=J;for(let H=0;H<N.length;H+=2)u[N[H]]=N[H+1];break;default:throw Error(`Illegal argument: assoc! expects a Map, Array, or Object as the first argument, but got ${typeof u}.`)}return u}var X8=1,Iq=2,J8=3,Rw=4,N8=5,Sw=6;function Q8(u){return u.constructor===Object}function _w(u){return u!=null&&Q8(u)}function H8(u){if(u==null)return;if(Q8(u))return J8;if(u instanceof Map)return X8;if(u instanceof Set)return N8;if(u instanceof O8)return Rw;if(Array.isArray(u))return Iq;if(u instanceof K8)return Sw;if(u instanceof z8)return N8;if(u instanceof Object)return J8;return}function c9(u,W){for(let J of W)u.add(J);return u}function bw(...u){if(u.length===0)return y9();let[W,...J]=u,N=W;if(N===null||N===void 0)N=n9();let H,K;switch(H8(N)){case N8:if(N instanceof z8)return c9(new N.constructor(N),J);else return new N.constructor([...N,...J]);case Rw:return new O8(...J.reverse(),...N);case Iq:return[...N,...J];case X8:H=new Map(N);for(let V of J)if(!Array.isArray(V))y0(V).forEach((h)=>{H.set(h[0],h[1])});else H.set(V[0],V[1]);return H;case Sw:return Pw(function*(){yield*J,yield*N});case J8:K={...N};for(let V of J)if(!Array.isArray(V))Object.assign(K,V);else K[V[0]]=V[1];return K;default:throw Error("Illegal argument: conj expects a Set, Array, List, Map, or Object as the first argument.")}}function E9(u,...W){for(let J of W)u.delete(J);return u}function Tw(u,...W){let J=new u.constructor([...u]);return E9(J,...W)}function U8(u,W,J){if(u){var N=void 0;if(Array.isArray(u))N=u[W];else{let H=y0(u),K=0;for(let V of H)if(K++==W){N=V;break}}if(N!==void 0)return N}return J}function Y5(u,W,J=void 0){if(u==null)return J;let N;if(Q8(u))if(N=u[W],N===void 0)return J;else return N;let H;switch(H8(u)){case N8:if(u.has(W))N=W;break;case X8:N=u.get(W);break;case Iq:N=u[W];break;default:if(H=u.get,H instanceof Function)try{N=u.get(W);break}catch(K){}N=u[W];break}return N!==void 0?N:J}function cw(u){return u!=null&&!!u[Symbol.iterator]}function P9(u){return u===null||u===void 0||!!u[Symbol.iterator]}function y0(u){if(u===null||u===void 0)return[];if(P9(u))return u;if(u instanceof Object)return Object.entries(u);throw TypeError(`${u} is not iterable`)}var C9=Symbol("Iterable");class I5{value;constructor(u){this.value=u}_deref(){return this.value}}function Ew(u,W,J){u=Yq(u);let N,H;if(arguments.length===2){let K=y0(W)[Symbol.iterator](),V=K.next();if(V.done)H=u();else H=V.value;N=K}else H=W,N=y0(J);if(H instanceof I5)return H.value;for(let K of N)if(H=u(H,K),H instanceof I5){H=H.value;break}return H}var k9=!1;class K8{constructor(u){this.gen=u,this.usages=0}[Symbol.iterator](){if(this.usages++,this.usages>=2&&k9)try{throw Error()}catch(u){console.warn("Re-use of lazy value",u.stack)}return this.gen()}}K8.prototype[C9]=!0;function Pw(u){return new K8(u)}function jq(u){return!v(u)}function y9(...u){return u}function j5(u){return H8(u)===Iq}var Cw=Symbol("IApply__apply");function kw(u,...W){u=Yq(u);let J=W.slice(0,W.length-1),N=y0(W[W.length-1]),H=u[Cw];if(H)return H(...J,N);return u(...J,...N)}class O8 extends Array{constructor(...u){super();this.push(...u)}}function n9(...u){return new O8(...u)}function yw(u){return Pw(function*(){for(let W of u)yield*y0(W)})}function i9(...u){return yw(u)}i9[Cw]=(u)=>{return yw(u)};function nw(u,W,...J){return u=Yq(u),function(N,...H){if(!N)return u(W,...J,...H);else return u(N,...J,...H)}}function g9(u,W){if(arguments.length===1)W=u,u=void 0;return u=Yq(u),W=y0(W),[...W].sort(u||M5)}function A5(u,W,J,...N){J=Yq(J);let H=Y5(u,W);return T9(u,W,J(H,...N))}function n1(u){if(!u)return 0;let W=u.length||u.size;if(typeof W==="number")return W;let J=0;for(let N of y0(u))J++;return J}function iw(u){if(u==null)return!1;if(Q8(u))return!0;if(u instanceof Map)return!0;return!1}function M5(u,W){if(u===W)return 0;else{if(u==null)return-1;if(W==null)return 1;let J=typeof u,N=typeof W;if(J==="number"&&N==="number"||J==="string"&&N==="string"){if(u===W)return 0;if(u<W)return-1;return 1}else if(Array.isArray(u)&&Array.isArray(W))if(u.length<W.length)return-1;else if(u.length>W.length)return 1;else{for(let H=0;H<u.length;H++){let K=M5(u[H],W[H]);if(K!=0)return K}return 0}else throw Error(`comparing ${J} to ${N}`)}}function v(u){return u!=null&&u!==!1}function gw(u,W,J){return u.substring(W,J)}function pw(u){return typeof u==="function"}function vw(u){return typeof u=="number"}function V8(u){return typeof u==="string"}var AJ=Symbol("meta");function xw(u){return u===!0||u===!1}class z8{constructor(u){if(!(u instanceof z8))u=g9(u);let J=new Set(u);this._elts=[...J],this._set=J}add(u){if(this._set.has(u))return this;let W=this._elts,J=!1;for(let N=0;N<W.length;N++)if(M5(u,W[N])<=0){W.splice(N,0,u),J=!0;break}if(!J)W.push(u),this._set.add(u);else this._set=new Set(W);return this.size=W.length,this}delete(u){if(!this._set.has(u))return this;let W=this._elts,J=W.indexOf(u);return W.splice(J,1),this._set=new Set(W),this.size=W.length,this}has(u){return this._set.has(u)}keys(){return this.values()}values(){return this._elts[Symbol.iterator]()}entries(){return this._set.entries()}forEach(...u){return this.set.forEach(...u)}clear(){this._elts=[],this._set=new Set(this._elts)}[Symbol.iterator](){return this.keys()}}var p9="http://www.w3.org/2000/svg",v9=function(u){let W=(()=>{let N=u.indexOf("#");if(N>0)return N})(),J=(()=>{let N=u.indexOf(".");if(N>0)return N})();return[v(W)?u.substring(0,W):v(J)?u.substring(0,J):u,v(W)?v(J)?u.substring(W+1,J):u.substring(W+1):null,v(J)?u.substring(J+1):null]},x9=new Set(["checked","disabled","selected","value","innerHTML"]),d9=function(u){return x9.has(u)};var t9=function(u){return jq(V8(u))&&(()=>{let W=cw(u);if(v(W))return jq(j5(u));else return W})()},dw=function(u,W){if(W in u){let J=u[W];return delete u[W],u[W]=J}},F8=function(u,W){if(v((()=>{let J=u==null;if(J)return J;else{let N=V8(u);if(v(N))return N;else{let H=vw(u);if(v(H))return H;else return xw(u)}}})()))return{tag:"#text",text:`${u??""}`};else if(v(j5(u))){let J=u[0],N=1,H=v(V8(J))?v9(J):[J],K=U8(H,0,null),V=U8(H,1,null),h=U8(H,2,null),Y=v(h)?h.split("."):null,S=u[1],b=v(iw(S))?1:-1,_=b===-1?1:2,c=(()=>{let x=W;if(v(x))return x;else return K==="svg"})();return v(pw(K))?(()=>{let x=kw(K,u.slice(1));return F8(x,c)})():(()=>{let x=[],P={type:"element",svg:c,tag:v(c)?K:K.toUpperCase(),children:x},f={},p={};P["reagami.core/props"]=f,P["reagami.core/attrs"]=p;let B=u.length-_;for(let e=0;e<B;e++)(()=>{let N0=u[e+_];if(v(t9(N0))){for(let $0 of y0(N0)){let G0=$0;x.push(F8(G0,c))}return null}else return x.push(F8(N0,c))})();if(b===-1);else{let e=u[1],N0=Object.getOwnPropertyNames(e),$0=N0.length;if(v((()=>{let l="max"in e;if(l)return l;else return"min"in e})()))dw(e,"default-value"),dw(e,"value");let G0=$0;for(let l=0;l<G0;l++)(()=>{let H0=N0[l],Q=e[H0];if(H0==="on-render")return P["reagami.core/on-render"]=Q;else if(v(H0.startsWith("on"))){let z0=H0.replaceAll("-","");return f[z0]=Q}else if(v(H0.startsWith("default"))){let z0=gw(H0,7).replaceAll("-","");return p[z0]=Q}else if(v(H0==="style"&&_w(Q))){let z0=Ew(function(i0,D){return`${i0??""}${D[0]??""}: ${D[1]??""};`},"",Object.entries(Q));return p.style=z0}else if(v(d9(H0)))return f[H0]=Q;else if(v(Q))return p[H0]=Q})()}if(v(Y!=null&&Y.length>0))p.class=`${(()=>{let e=p.class;if(v(e))return`${e??""} `})()??""}${Y.join(" ")??""}`;if(v(V))p.id=V;return P})()}else throw(()=>{return console.error("Invalid hiccup:",u),Error(`Invalid hiccup: ${u??""}`)})()},f9=function(u){return F8(u,!1)},L5=new Map,R5=function(u,W){let J=(()=>{let N=u.text;if(v(N)){let H=N;return document.createTextNode(H)}else{let H=u.tag,K=v(u.svg)?document.createElementNS(p9,H):document.createElement(H),V=u["reagami.core/props"],h=u["reagami.core/attrs"],Y=Object.getOwnPropertyNames(h),S=Object.getOwnPropertyNames(V),b=Y.length;for(let x=0;x<b;x++)(()=>{let P=Y[x],f=h[P];return K.setAttribute(P,f)})();let _=S.length;for(let x=0;x<_;x++)(()=>{let P=S[x],f=V[P],p=f===void 0?null:f;return K[P]=p})();let c=u.children;if(v(c)){let x=c,f=x.length;for(let p=0;p<f;p++)(()=>{let B=x[p];return K.appendChild(R5(B,W))})()}let u0=u["reagami.core/on-render"];if(v(u0)){let x=u0;K["reagami.core/on-render"]=x,A5(L5,W,nw(bw,new Set([])),K)}return K}})();return J["reagami.core/vnode"]=u,J},tw=function(u,W,J){let N=u["reagami.core/vnode"],H=v((()=>{let K=N;if(v(K))return jq(u["reagami.core/root"]);else return K})())?N.children.length:J===u?u.childNodes.length:-1;if(H===-1)return null;else{let K=u.childNodes,V=n1(W);if(H!==V)return u.replaceChildren.apply(u,W.map(function(h){return R5(h,J)}));else{let h=V;for(let Y=0;Y<h;Y++)(()=>{let S=K[Y],b=S["reagami.core/vnode"],_=W[Y],c=b.text,u0=_.text,x=_.tag;if(v((()=>{let P=c;if(v(P))return u0;else return P})()))if(u0===c)return null;else return S.textContent=u0,S["reagami.core/vnode"]=_;else if(v((()=>{let P=S;if(v(P)){let f=b;if(v(f)){let p=_;if(v(p))return x===b.tag;else return p}else return f}else return P})())){let P=b["reagami.core/props"],f=b["reagami.core/attrs"],p=_["reagami.core/props"],B=_["reagami.core/attrs"],e=Object.getOwnPropertyNames(P),N0=Object.getOwnPropertyNames(f),$0=Object.getOwnPropertyNames(B),G0=Object.getOwnPropertyNames(p),l=n1(e);for(let D=0;D<l;D++)(()=>{let r=e[D];if(r in p)return null;else return S[r]=null})();let H0=n1(N0);for(let D=0;D<H0;D++)(()=>{let r=N0[D];if(r in B)return null;else return S.removeAttribute(r)})();let Q=n1($0);for(let D=0;D<Q;D++)(()=>{let r=$0[D],K1=B[r];if(K1===f[r])return null;else return S.setAttribute(r,K1)})();let z0=n1(G0);for(let D=0;D<z0;D++)(()=>{let r=G0[D],K1=(()=>{let y=p[r];if(y===void 0)return null;else return y})();if(P[r]===K1)return null;else return S[r]=K1})();let i0=_.children;if(v(i0))tw(S,i0,J);return S["reagami.core/vnode"]=_}else{let P=R5(_,J);return u.replaceChild(P,S)}})();return null}}},fw=function(u,W){if(v(u["reagami.core/root"]));else u.textContent="",u["reagami.core/root"]=!0;let J=f9(W);tw(u,[J],u);for(let N of y0(L5.get(u))){let H=N,K=H["reagami.core/on-render"];if(v(H.isConnected))if(jq(K["reagami.core/is-run"])){let V=K(H,"mount",null);K["reagami.core/is-run"]=!0,K["reagami.core/data"]=V}else{let V=K(H,"update",K["reagami.core/data"]);K["reagami.core/data"]=V}else K(H,"unmount",K["reagami.core/data"]),delete K["reagami.core/data"],A5(L5,u,Tw,H)}return null};var ow=Q9(mw(),1),o9=function(){let u=localStorage.getItem("client-id");if(R(u))return u;else{let W=m(G8());return localStorage.setItem("client-id",W),W}},Lq=o9(),n0=e0({ably:null,"connection-status":"initialized"}),lw=function(){return L(i(n0),"ably")},rw=function(){return L(i(n0),"connection-status")},i1=function(){return L(i(n0),"connection-status")==="connected"},l9=ow.default.Realtime,aw=function(u){v0("Ably init!");let W=new l9({key:u,clientId:Lq});return W.connection.on(function(J){let N=J.current;return v0("Ably connection:",N),q0(n0,J0,"connection-status",N)}),q0(n0,J0,"ably",W),W},g1=function(u){return lw().channels.get(u)},Rq=(()=>{let u=function(...W){switch(W.length){case 1:return u.cljs$core$IFn$_invoke$arity$1(W[0]);case 2:return u.cljs$core$IFn$_invoke$arity$2(W[0],W[1]);default:throw Error(m("Invalid arity: ",W.length))}};return u.cljs$core$IFn$_invoke$arity$1=function(W){return Rq(W,null)},u.cljs$core$IFn$_invoke$arity$2=function(W,J){return g1(W).presence.enter(J).catch(function(N){return v0("Presence enter failed:",N)})},u.cljs$lang$maxFixedArity=2,u})(),sw=function(u,W){return g1(u).presence.update(W).catch(function(J){return v0("Presence update failed:",J)})},Sq=function(u,W){return g1(u).presence.subscribe(function(N){return W()}),lw().connection.once("connected",W)},_q=function(u,W){return g1(u).presence.get().then(function(J){return W(q1(J))}).catch(function(J){return v0("Get presence failed:",J)})},h1=function(u,W,J){return g1(u).publish(W,J).catch(function(N){return v0("Publish failed:",N)})},D1=function(u,W){return g1(u).subscribe(function(J){return W(J.data)})};var p1=function(){let u=rw();if(R(i1()))return null;else return["div",{class:"fixed bottom-4 left-1/2 -translate-x-1/2 px-4 py-2 bg-yellow-500 text-white rounded-full text-sm font-medium shadow-lg"},"Connection status: ",u]};var q6=["title","about",["wotc","q1","q1-results","wotc-answer"],["rules","q2","q2-results"],["independence","q3","q3-results","q3-trend"],["diversity","q4","q4-results","q4-trend"],["ground-truth","q5","q5-results","q5-trend"],["point","search-engines","llms","but-not-really"],["the-end","tech-stack"]],x0=q1(C1(F5,u1(function(u){if(R(W8(u)))return[u];else return u},q6))),r9={q1:{id:"q1",text:'Who has heard of "Wisdom of the Crowd" before?',kind:"choice",options:["Yes","No","Maybe"]},q2:{id:"q2",text:"How heavy is this Persimmon (in grams)?",kind:"scale",options:{min:1,max:500,unit:"g","bin-size":50}},q3:{id:"q3",text:"What year did the first person reach the peak of Mount Everest?",kind:"scale",options:{min:1800,max:2000,"bin-size":10}},q4:{id:"q4",text:"What percentage of the world population has internet access?",kind:"scale",options:{min:0,max:100,unit:"%","bin-size":10}},q5:{id:"q5",text:"How ethical is it to train LLMs on public code on GitHub?",kind:"scale",options:{min:0,max:10,"bin-size":1,"min-label":"Not ethical","max-label":"Very ethical"}}},a9={diversity:["Diversity in errors helps reduce overall error"],"ground-truth":["There needs to obviously be a precise answer to the question"],llms:["That's what I thought","But thinking further"],about:["This is my backup idea...","So let's just have fun"],rules:["1. No peeking!","2. Feel free to change your answers as much as you like","3. That's it"],"search-engines":["I mean..."],"but-not-really":["Not independent, even with temperature","They're fairly diverse","They seem to give reasonable answers without ground truth"],independence:["For errors to cancel out, the errors need to be unbiased"],point:["Originally I had a point to this talk","Because this sounds very similar to"]},J1=function(u){return L(r9,u)},s9={"slide-id":s0(x0),"audience-count":0,"selected-speaker":null,"audience-members":[]},e9=function(){return localStorage.setItem("presenter-state",JSON.stringify(y1(i(Q0),["slide-id","selected-speaker"])))},qW=function(){let u=localStorage.getItem("presenter-state");if(R(u)){let J=JSON.parse(u);return{"slide-id":(()=>{let N=L(J,"slide-id");if(R(N))return N;else return s0(x0)})(),"selected-speaker":L(J,"selected-speaker")}}},Q0=e0(Z1(s9,qW())),h8="presenter",x1=function(u){return _q(h8,function(W){return u(R(Y0(W))?s0(W).data:null)})},D8=function(u){return Sq(h8,u)},Tq=function(){return e9(),sw(h8,{"slide-id":L(i(Q0),"slide-id"),"selected-speaker":L(i(Q0),"selected-speaker")})},$6=function(){let u=L(i(Q0),"audience-members");if(R(Y0(u))){let W=jw(u);return q0(Q0,J0,"selected-speaker",W),Tq()}},$W=function(){return h1("speaker","message",{command:"clear"})},wW=function(){let u=L(i(Q0),"selected-speaker"),W=L(i(Q0),"audience-members"),J=u;if(R(J))return Yw(function(N){return w1(N,u)},W);else return J},b5=function(){let u=L(i(Q0),"slide-id"),W=x0.indexOf(u);if(R(W))return W;else return 0},uW=function(){let u=b5(),W=Aw(I0(x0)-1,u+1);return q0(Q0,J0,"slide-id",b0(x0,W)),Tq()},WW=function(){let u=b5(),W=Dq(0,u-1);return q0(Q0,J0,"slide-id",b0(x0,W)),Tq()},ZW=function(u){return q0(Q0,J0,"slide-id",u),Tq()},GW=function(){return localStorage.removeItem("presenter-state"),q0(Q0,J0,"slide-id",s0(x0),"selected-speaker",null),Tq(),h1("control","reset",{timestamp:Date.now()})},v1=(()=>{let u=function(W){let J=[],N=arguments.length,H=0;while(!0){if(H<N){J.push(arguments[H]),H=H+1;continue}break}let K=1<J.length?J.slice(1):null;return u.cljs$core$IFn$_invoke$arity$variadic(arguments[0],K)};return u.cljs$core$IFn$_invoke$arity$variadic=function(W,J){return hq(["button",Z1({class:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 active:bg-blue-800 disabled:bg-gray-400"},W)],J)},u.cljs$lang$maxFixedArity=1,u})(),ew=function(u,W){let J=w1(u,L(i(Q0),"slide-id"));return[v1,{class:R(J)?"px-4 py-2 bg-green-600 text-white rounded-lg disabled:bg-gray-400":"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400","on-click":function(){return ZW(u)},disabled:W},u]},JW=function(u){let W=L(i(Q0),"selected-speaker"),J=wW();return["div",{class:"p-3 bg-purple-900/50 border border-purple-700 rounded-lg space-y-2"},["h2",{class:"text-sm font-semibold text-purple-400"},"Selected Speaker"],R(W)?["div",{class:"flex items-center gap-2"},["span",{class:R(J)?"text-green-400":"text-red-400"},"●"],["span",{class:"font-mono text-sm truncate flex-1"},W],["span",{class:"text-xs text-gray-400"},R(J)?"online":"offline"]]:["div",{class:"text-gray-400 text-sm"},"No speaker selected"],["div",{class:"flex gap-2"},[v1,{"on-click":$6,disabled:u,class:"px-3 py-1 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 disabled:bg-gray-600"},R(W)?"Re-roll":"Select Random"],[v1,{"on-click":$W,disabled:u,class:"px-3 py-1 bg-gray-600 text-white text-sm rounded-lg hover:bg-gray-500 disabled:bg-gray-700"},"Clear Messages"]]]},w6=function(){let u=zq(i1()),W=L(i(Q0),"slide-id"),J=b5(),N=W==="q3";if(R((()=>{let H=N;if(R(H)){let K=zq(L(i(Q0),"selected-speaker"));if(K)return Y0(L(i(Q0),"audience-members"));else return K}else return H})()))$6();return["div",{class:"min-h-screen bg-gray-900 text-white"},["div",{class:"p-4 space-y-6 max-w-md mx-auto"},["h1",{class:"text-2xl font-bold"},"Presenter Controls"],["div",{class:"text-lg"},"Audience connected: ",L(i(Q0),"audience-count")],["div",{class:"space-y-2"},["h2",{class:"text-xl font-semibold"},"Current Slide"],["div",{class:"flex gap-2 items-center"},[v1,{"on-click":WW,disabled:u},"Prev"],[v1,{"on-click":uW,disabled:u},"Next"],["span",{class:"px-4 py-2 font-mono text-lg"},W],["span",{class:"text-gray-400"},"(",J+1,"/",I0(x0),")"]]],R(N)?[JW,u]:null,(()=>{let H=L(a9,W);if(R(H)){let K=H;return["div",{class:"p-3 bg-yellow-900/50 border border-yellow-700 rounded-lg"},["h2",{class:"text-sm font-semibold text-yellow-400 mb-2"},"Notes"],["div",{class:"space-y-1"},Z0(function*(){for(let V of g(F1(W1,K))){let h=V,Y=b0(h,0,null),S=b0(h,1,null);yield["p",{class:"text-yellow-200"},S]}})]]}})(),["div",{class:"space-y-2"},["h2",{class:"text-xl font-semibold"},"All Slides"],["div",{class:"flex flex-col gap-2"},Z0(function*(){for(let H of g(F1(W1,q6))){let K=H,V=b0(K,0,null),h=b0(K,1,null);yield R(W8(h))?[ew,h,u]:["div",{class:"flex gap-2"},Z0(function*(){for(let Y of g(h))yield[ew,Y,u]})]}})]],["div",{class:"pt-4 border-t border-gray-700"},[v1,{class:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-600","on-click":function(){if(R(confirm("Reset all state for presenter, display, and audience?")))return GW()},disabled:u},"Reset"]],[p1]]]},u6=function(){return G1(n0,"talk.presenter/connection",function(u,W,J,N){return q0(Q0,k1)}),Rq(h8,{"slide-id":L(i(Q0),"slide-id")}),Sq("audience",function(){return _q("audience",function(u){let W=Kw(function(J){return J.clientId},u);return q0(Q0,J0,"audience-count",I0(u),"audience-members",W)})})};var W6={"slide-id":null,"my-votes":{},"selected-speaker":null,"my-message":""},NW=function(){return localStorage.setItem("audience-state",JSON.stringify(y1(i(T0),["my-votes"])))},XW=function(){let u=localStorage.getItem("audience-state");if(R(u))return JSON.parse(u)},T0=e0(Z1(W6,XW())),QW=function(){return localStorage.removeItem("audience-state"),P1(T0,W6),x1(function(u){if(R(u))return q0(T0,J0,"slide-id",L(u,"slide-id"),"selected-speaker",L(u,"selected-speaker"))})},HW="audience",UW="speaker",KW="reactions",c5=function(u){return L(L(i(T0),"my-votes"),u)},OW=function(){return w1(Lq,L(i(T0),"selected-speaker"))},Z6=function(u,W){let J=e0(null),N=function(H){let K=[],V=arguments.length,h=0;while(!0){if(h<V){K.push(arguments[h]),h=h+1;continue}break}let Y=0<K.length?K.slice(0):null;return N.cljs$core$IFn$_invoke$arity$variadic(Y)};return N.cljs$core$IFn$_invoke$arity$variadic=function(H){let K=i(J);if(R(K))clearTimeout(K);return P1(J,setTimeout(function(){return C1(u,H)},W))},N.cljs$lang$maxFixedArity=0,N},VW=function(u){return q0(T0,J0,"my-message",u),h1(UW,"message",{"client-id":Lq,message:u,timestamp:Date.now()})},zW=Z6(function(u){return h1(KW,"reaction",{emoji:u,id:m(G8()),timestamp:Date.now()})},200),FW=Z6(function(u,W){return h1("votes","vote",{"client-id":Lq,"question-id":u,value:W,timestamp:Date.now()})},100),E5=function(u,W){return q0(T0,Oq,["my-votes",u],W),NW(),FW(u,W)},P5=(()=>{let u=function(W){let J=[],N=arguments.length,H=0;while(!0){if(H<N){J.push(arguments[H]),H=H+1;continue}break}let K=1<J.length?J.slice(1):null;return u.cljs$core$IFn$_invoke$arity$variadic(arguments[0],K)};return u.cljs$core$IFn$_invoke$arity$variadic=function(W,J){return hq(["button",Z1({class:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 active:bg-blue-800 disabled:bg-gray-600",disabled:zq(i1())},W)],J)},u.cljs$lang$maxFixedArity=1,u})(),hW=function(u,W){let J=c5(u),N=L(W,"options"),H=L(N,"min"),K=L(N,"max"),V=L(N,"unit"),h=L(N,"min-label"),Y=L(N,"max-label"),S=(()=>{let _=J;if(R(_))return _;else return H})(),b=function(_){let c=Math.min(K,Math.max(H,_));return E5(u,c)};return["div",{class:"space-y-4"},["h2",{class:"text-xl font-semibold text-center"},L(W,"text")],["div",{class:"flex items-center justify-center gap-2"},["input",{type:"number",min:H,max:K,value:S,class:"w-full text-4xl font-bold text-center border-b-2 border-gray-600 focus:border-blue-500 outline-none bg-transparent","on-change":function(_){let c=parseInt(_.target.value);if(R(isNaN(c)))return null;else return b(c)}}],R(V)?["span",{class:"text-xl text-gray-400"},V]:null],["div",{class:"space-y-1"},["input",{type:"range",min:H,max:K,value:S,class:"w-full h-3 bg-gray-700 rounded-lg appearance-none cursor-pointer","on-change":function(_){return b(parseInt(_.target.value))}}],["div",{class:"flex justify-between text-sm text-gray-400"},["span",(()=>{let _=h;if(R(_))return _;else return H})()],["span",(()=>{let _=Y;if(R(_))return _;else return K})()]]]]},DW=function(u,W){let J=c5(u);return["div",{class:"space-y-4"},["h2",{class:"text-xl font-semibold text-center"},L(W,"text")],["div",{class:"flex flex-col gap-2"},Z0(function*(){for(let N of g(L(W,"options"))){let H=N;yield[P5,{class:R(w1(H,J))?"px-4 py-2 bg-green-600 text-white rounded-lg":"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700","on-click":function(){return E5(u,H)}},H]}})]]},BW=function(u,W){let J=m("text-input-",u),N=c5(u);return["div",{class:"space-y-4"},["h2",{class:"text-xl font-semibold text-center"},L(W,"text")],["div",{class:"flex flex-col gap-2"},["input",{id:J,type:"text",class:"px-4 py-2 border border-gray-600 rounded-lg bg-transparent",placeholder:"Type your answer..."}],[P5,{"on-click":function(){let H=document.getElementById(J),K=H.value;if(R(Y0(K)))return E5(u,K),H.value=""}},"Submit"],R(N)?["div",{class:"text-sm text-gray-400"},"Your answer: ",N]:null]]},cq=function(u){let W=J1(u);switch(L(W,"kind")){case"scale":return[hW,u,W];case"choice":return[DW,u,W];case"text":return[BW,u,W];default:return["div","Unknown question type"]}},YW=function(){let W=L(i(T0),"my-message");return["div",{class:"p-4 bg-purple-900/50 border border-purple-500 rounded-lg space-y-3"},["div",{class:"flex items-center gap-2"},["span",{class:"text-purple-400 text-lg"},"✨"],["span",{class:"text-purple-300 font-semibold"},"You've been selected to share!"]],["textarea",{id:"speaker-message-input",class:"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white resize-none focus:border-purple-500 focus:outline-none",rows:3,placeholder:"Share your thoughts...","default-value":W}],[P5,{class:"w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-600","on-click":function(){let J=document.getElementById("speaker-message-input"),N=J.value;if(R(Y0(N.trim())))return VW(N),J.value=""}},"Send Message"],R(Y0(W))?["div",{class:"text-xs text-gray-400"},"Your message is live on screen"]:null]},IW=["❤️","\uD83D\uDC4D","\uD83D\uDE2E","\uD83E\uDDE0"],jW=function(u){return["button",{class:"text-4xl p-3 hover:scale-125 transition-transform active:scale-90","on-click":function(){return zW(u)}},u]},AW=function(){return["div",{class:"text-center text-gray-400 space-y-8"},["div",["h2",{class:"text-xl"},"Waiting for next question..."],["p","The presenter will activate a question soon."]],["div",{class:"flex justify-center gap-4"},Z0(function*(){for(let u of g(IW))yield[jW,u]})]]},MW=function(u){switch(u){case"q1":return[cq,"q1"];case"q2":return[cq,"q2"];case"q3":return["div",{class:"space-y-4"},[cq,"q3"],R(OW())?[YW]:null];case"q4":return[cq,"q4"];case"q5":return[cq,"q5"];default:return[AW]}},G6=function(){let u=L(i(T0),"slide-id");return["div",{class:"min-h-screen bg-gray-900 text-white"},["div",{class:"p-4 max-w-md mx-auto"},["h1",{class:"text-2xl font-bold mb-4 text-center"},"Vote"],[MW,u],[p1]]]},J6=function(){return G1(n0,"talk.audience/connection",function(u,W,J,N){return q0(T0,k1)}),Rq(HW),D8(function(){return x1(function(u){if(R(u))return q0(T0,J0,"slide-id",L(u,"slide-id"),"selected-speaker",L(u,"selected-speaker"))})}),D1("control",function(u){return QW()})};var AG=X6(),N$=Gu(),Uu=Xu(),MG=Hu();function X$(u,W,J,N,H){let K=[].slice.call(arguments,1),V=K.length,h=typeof K[V-1]==="function";if(!h&&!AG())throw Error("Callback required as last argument");if(h){if(V<2)throw Error("Too few arguments provided");if(V===2)H=J,J=W,W=N=void 0;else if(V===3)if(W.getContext&&typeof H>"u")H=N,N=void 0;else H=N,N=J,J=W,W=void 0}else{if(V<1)throw Error("Too few arguments provided");if(V===1)J=W,W=N=void 0;else if(V===2&&!W.getContext)N=J,J=W,W=void 0;return new Promise(function(Y,S){try{let b=N$.create(J,N);Y(u(b,W,N))}catch(b){S(b)}})}try{let Y=N$.create(J,N);H(null,u(Y,W,N))}catch(Y){H(Y)}}var RG=N$.create,SG=X$.bind(null,Uu.render),S8=X$.bind(null,Uu.renderToDataURL),_G=X$.bind(null,function(u,W,J){return MG.render(u,J)});function Ku(u,W){if(W===void 0)W=u,u="";if(W instanceof Array)return W.join(u);let J="",N=!1;for(let H of g(W)){if(N)J+=u;J+=H,N=!0}return J}function Ou(u,W){return u.endsWith(W)}var U1=(()=>{let u=location.pathname;if(R(Ou(u,"/")))return Mw(u,0,I0(u)-1);else return u})(),TG=m(U1,"/persimmon.jpeg"),Vu="blog.bythe.rocks/talk/christmas",zu={"slide-id":null,votes:{},"audience-count":0,"speaker-messages":[],reactions:[],"qr-code-data":null,"selected-speaker":null},cG=function(){return localStorage.setItem("display-state",JSON.stringify(y1(i(o),["votes"])))},EG=function(){let u=localStorage.getItem("display-state");if(R(u))return JSON.parse(u)},o=e0(Z1(zu,EG())),PG=function(){let u=L(i(o),"audience-count");return localStorage.removeItem("display-state"),P1(o,J0(zu,"audience-count",u)),x1(function(W){if(R(W))return q0(o,J0,"slide-id",L(W,"slide-id"))})},CG=function(u){let W=L(u,"client-id"),J=L(u,"question-id");return q0(o,function(N){return hw(Oq(N,["votes",J,"latest-vote",W],u),["votes",J,"all-votes"],h5(Vq,[]),u)}),cG()},kG=function(u){if(R(L(u,"command")==="clear"))return q0(o,J0,"speaker-messages",[]);else return q0(o,w8,"speaker-messages",function(W){return q1(zw(5,Qw(u,W)))})},yG=100,nG=4000,iG=function(u){let W=10+D5(80),J=J0(u,"x",W,"created-at",Date.now());return q0(o,w8,"reactions",function(N){return q1(Fw(yG,Vq(N,J)))})},gG=function(){let W=Date.now()-nG;return q0(o,w8,"reactions",function(J){return Hw(function(N){return L(N,"created-at")>W},J)})},_8=function(u){return u8(L0(i(o),["votes",u,"latest-vote"]))},pG=function(u){let W=_8(u),J=u1("value",W);if(R(Y0(J)))return{count:I0(J),average:E1(Kq,J)/I0(J),distribution:B5(J)}},vG=function(u){return B5(u1("value",_8(u)))},xG=function(u){return u1("value",_8(u))},Fu=function(u){return I0(_8(u))},dG=function(u){let W=L0(i(o),["votes",u,"all-votes"],[]),N=Bw("timestamp",W),H={},K=[];while(!0){if(R(Iw(N)))return K;else{let V=s0(N),h=L(V,"client-id"),Y=L(V,"value"),S=L(V,"timestamp"),b=J0(H,h,Y),_=u8(b),c=E1(Kq,_)/I0(_),u0=Nw(N),x=b,P=Vq(K,{timestamp:S,average:c,count:I0(b)});N=u0,H=x,K=P;continue}break}},tG=function(u){let W=u,J=L(W,"emoji"),N=L(W,"x"),H=L(W,"id"),K=L(W,"created-at"),h=-(Date.now()-K)/1000;return["div",{key:H,class:"absolute text-5xl pointer-events-none animate-float-up",style:{left:m(N,"%"),bottom:"0%",transform:"translateX(-50%)","animation-delay":m(h,"s")}},J]},fG=function(){let u=L(i(o),"reactions");return["div",{class:"fixed inset-0 overflow-hidden pointer-events-none z-50"},["style",`
       @keyframes float-up {
         0% { bottom: 0%; opacity: 1; }
         100% { bottom: 100%; opacity: 0; }
       }
       .animate-float-up {
         animation: float-up 4s linear forwards;
       }
     `],Z0(function*(){for(let W of g(u))yield[tG,W]})]},O0=function(u){let W=L(i(o),"slide-id"),J=x0,N=J.indexOf(W),H=I0(J);return["div",{class:"w-screen h-screen bg-gray-900 text-white relative"},["div",{class:"w-full h-full flex items-center justify-center p-8"},u],["div",{class:"absolute bottom-4 left-4 text-gray-400 text-sm"},L(i(o),"audience-count")," \uD83D\uDC65"],["div",{class:"absolute bottom-4 right-4 text-gray-400 text-sm"},N+1," of ",H],[p1]]},mG=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-7xl font-bold mb-8"},"Wisdom of the Crowd"],R(L(i(o),"qr-code-data"))?["img",{src:L(i(o),"qr-code-data"),class:"mx-auto mb-4 rounded-lg"}]:null,["p",{class:"text-2xl text-gray-400"},"Join at ",Vu]]]},oG=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold"},"What is this talk about?"]]]},lG=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold"},"What is Wisdom of the Crowd?"]]]},rG=function(){return[O0,["div",{class:"text-center space-y-8"},["p",{class:"text-4xl"},"Ask a crowd a question"],["p",{class:"text-4xl"},"get a surprisingly accurate answer back"]]]},aG=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold"},"First some ground rules"]]]},sG=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold"},"Independence"]]]},eG=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold"},"Diversity"]]]},qJ=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold"},"A ground truth exists"]]]},$J=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold mb-8"},"So what's the point?"],["p",{class:"text-3xl text-gray-400"},"Does this sound familiar to any widely used technology currently?"]]]},wJ=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-6xl font-bold"},"Search Engines!"]]]},uJ=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-6xl font-bold"},"LLMs"]]]},WJ=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold mb-12"},"But not really"],["table",{class:"mx-auto text-2xl border-collapse"},["thead",["tr",{class:"border-b border-gray-600"},["th",{class:"px-8 py-4 text-left"}],["th",{class:"px-8 py-4"},"Wisdom of the Crowd"],["th",{class:"px-8 py-4"},"LLMs"]]],["tbody",["tr",{class:"border-b border-gray-700"},["td",{class:"px-8 py-4 text-left text-gray-400"},"Independence"],["td",{class:"px-8 py-4 text-green-400"},"✅"],["td",{class:"px-8 py-4 text-red-400"},"❌"]],["tr",{class:"border-b border-gray-700"},["td",{class:"px-8 py-4 text-left text-gray-400"},"Diversity"],["td",{class:"px-8 py-4 text-green-400"},"✅"],["td",{class:"px-8 py-4 text-green-400"},"✅"]],["tr",["td",{class:"px-8 py-4 text-left text-gray-400"},"Requires Ground Truth"],["td",{class:"px-8 py-4 text-green-400"},"✅"],["td",{class:"px-8 py-4 text-red-400"},"❌"]]]]]]},ZJ=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-7xl font-bold"},"The end"]]]},GJ="https://github.com/Akeboshiwind/christmas-talk-2025",JJ=function(){return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold mb-8"},"Tech Stack"],["div",{class:"flex justify-center gap-16"},["div",{class:"space-y-4 text-left"},["div",{class:"flex items-center gap-4"},["img",{src:m(U1,"/logos/squint.png"),class:"w-12 h-12"}],["span",{class:"text-2xl"},"Squint"]],["div",{class:"flex items-center gap-4"},["img",{src:m(U1,"/logos/babashka.png"),class:"w-12 h-12"}],["span",{class:"text-2xl"},"Babashka"]],["div",{class:"flex items-center gap-4"},["img",{src:m(U1,"/logos/babashka.png"),class:"w-12 h-12 opacity-50"}],["span",{class:"text-2xl"},"Reagami"],["span",{class:"text-sm text-gray-400"},"(yet another borkdude project)"]],["div",{class:"flex items-center gap-4"},["img",{src:m(U1,"/logos/ably.png"),class:"w-12 h-12"}],["span",{class:"text-2xl"},"Ably"],["span",{class:"text-sm text-gray-400"},"(for the realtime stuff)"]],["div",{class:"flex items-center gap-4"},["img",{src:m(U1,"/logos/bun.svg"),class:"w-12 h-12"}],["span",{class:"text-2xl"},"Bun"]],["div",{class:"flex items-center gap-4"},["img",{src:m(U1,"/logos/tailwind.svg"),class:"w-12 h-12"}],["span",{class:"text-2xl"},"Tailwind"]],["div",{class:"flex items-center gap-4"},["img",{src:m(U1,"/logos/claude.png"),class:"w-12 h-12"}],["span",{class:"text-2xl"},"Claude Code"],["span",{class:"text-sm text-gray-400"},"(a whole lot of it)"]]],["div",{class:"flex flex-col items-center justify-center"},R(L(i(o),"github-qr-code-data"))?["img",{src:L(i(o),"github-qr-code-data"),class:"rounded-lg mb-2"}]:null,["p",{class:"text-sm text-gray-400"},"View source"]]]]]},NJ=function(){let u=L(i(o),"speaker-messages"),W=V5(function(V){return Y0(L(V,"message"))},u),J=L(i(o),"selected-speaker"),N=(()=>{let V=L(s0(u),"client-id");if(R(V))return V;else return J})(),H=R(N)?L0(i(o),["votes","q3","latest-vote",N,"value"]):null,K=(()=>{let V=Y0(W);if(R(V))return V;else return H})();if(R(K))return["div",{class:"absolute top-8 right-8 max-w-md space-y-3"},["div",{class:"bg-gray-800 rounded-2xl p-3 shadow-xl border border-gray-700"},["div",{class:"flex items-center gap-3"},["div",{class:"w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-lg"},"\uD83C\uDF1F"],["div",{class:"flex-1"},["div",{class:"font-bold text-white"},"Cool influencer"],["div",{class:"text-gray-400 text-sm"},"Live from the audience"]],R(H)?["div",{class:"text-2xl font-bold text-blue-400"},H]:null]],Z0(function*(){for(let V of g(F1(W1,W))){let h=V,Y=b0(h,0,null),S=b0(h,1,null);yield(()=>{return["div",{class:"bg-gray-800 rounded-xl p-3 shadow-lg border border-gray-700",style:{opacity:(100-Y*20)/100}},["div",{class:"text-white text-lg leading-relaxed"},L(S,"message")]]})()}})]},XJ=function(){let u=J1("q3"),W=Fu("q3"),J=L(i(o),"audience-count");return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold mb-8"},L(u,"text")],["p",{class:"text-2xl text-gray-400"},W," / ",J," Responses Received"],[NJ]]]},l1=(()=>{let u=function(...W){switch(W.length){case 1:return u.cljs$core$IFn$_invoke$arity$1(W[0]);case 2:return u.cljs$core$IFn$_invoke$arity$2(W[0],W[1]);case 3:return u.cljs$core$IFn$_invoke$arity$3(W[0],W[1],W[2]);default:throw Error(m("Invalid arity: ",W.length))}};return u.cljs$core$IFn$_invoke$arity$1=function(W){return l1(W,null,null)},u.cljs$core$IFn$_invoke$arity$2=function(W,J){return l1(W,J,null)},u.cljs$core$IFn$_invoke$arity$3=function(W,J,N){let H=J1(W),K=Fu(W),V=L(i(o),"audience-count");return[O0,["div",{class:"text-center"},["h1",{class:"text-5xl font-bold mb-4"},L(H,"text")],R(N)?["p",{class:"text-2xl text-gray-400 italic mb-8"},N]:null,R(J)?["img",{src:J,class:"max-h-64 mx-auto mb-8 rounded-lg"}]:null,["p",{class:"text-2xl text-gray-400"},K," / ",V," Responses Received"]]]},u.cljs$lang$maxFixedArity=3,u})(),hu=(()=>{let u=function(...W){switch(W.length){case 2:return u.cljs$core$IFn$_invoke$arity$2(W[0],W[1]);case 3:return u.cljs$core$IFn$_invoke$arity$3(W[0],W[1],W[2]);default:throw Error(m("Invalid arity: ",W.length))}};return u.cljs$core$IFn$_invoke$arity$2=function(W,J){return hu(W,J,null)},u.cljs$core$IFn$_invoke$arity$3=function(W,J,N){let H=pG(W),K=L0(J,["options","min"]),V=L0(J,["options","max"]),h=L0(J,["options","unit"]),Y=L0(J,["options","min-label"]),S=L0(J,["options","max-label"]),b=V-K,_=(()=>{let P=L0(J,["options","bin-size"]);if(R(P))return P;else return Math.ceil((b+1)/Math.min(10,b+1))})(),c=Math.ceil((b+1)/_),u0=q1(Z0(function*(){for(let P of g(z5(c))){let f=P;yield(()=>{let p=K+f*_,B=Math.min(V,p+(_-1));return{start:p,end:B,count:R(H)?E1(Kq,Z0(function*(){for(let e of g(z5(p,B+1))){let N0=e;yield L(L(H,"distribution"),N0,0)}})):0}})()}})),x=C1(Dq,1,u1("count",u0));if(R(H))return["div",{class:"text-center space-y-4"},["div",{class:"flex items-baseline justify-center gap-6"},["div",{class:"text-8xl font-bold text-blue-400"},L(H,"average").toFixed(1),R(h)?["span",{class:"text-4xl ml-2"},h]:null],R(N)?["div",{class:"text-4xl text-green-400"},"(",N,R(h)?["span",{class:"text-2xl ml-1"},h]:null,")"]:null],["div",{class:"text-xl text-gray-400"},"Average from ",L(H,"count")," responses"],["div",{class:"flex justify-center items-end gap-1 mt-8 px-4"},Z0(function*(){for(let P of g(u0)){let f=P,p=L(f,"start"),B=L(f,"end"),e=L(f,"count");yield(()=>{let N0=x>0?150*(e/x):0;return["div",{class:"flex-1 text-center min-w-0"},["div",{class:"bg-blue-500 rounded-t mx-auto",style:{height:m(N0,"px")}}],["div",{class:"text-xs text-gray-400 mt-1 truncate"},R(w1(p,B))?p:m(p,"-",B)]]})()}})],R((()=>{let P=Y;if(R(P))return P;else return S})())?["div",{class:"flex justify-between text-sm text-gray-400 mt-2 px-4"},["span",(()=>{let P=Y;if(R(P))return P;else return""})()],["span",(()=>{let P=S;if(R(P))return P;else return""})()]]:null];else return["div",{class:"text-2xl text-gray-500"},"No responses yet"]},u.cljs$lang$maxFixedArity=3,u})(),QJ=function(u,W){let J=vG(u),N=E1(Kq,u8(J));if(N>0)return["div",{class:"w-full max-w-2xl space-y-4"},Z0(function*(){for(let H of g(L(W,"options"))){let K=H;yield(()=>{let V=L(J,K,0),h=N>0?100*(V/N):0;return["div",{class:"flex items-center gap-4"},["div",{class:"w-40 text-right text-lg"},K],["div",{class:"flex-1 bg-gray-700 rounded h-10"},["div",{class:"bg-blue-500 h-10 rounded flex items-center justify-end pr-2",style:{width:m(h,"%")}},V>0?["span",{class:"text-sm font-bold"},V]:null]],["div",{class:"w-16 text-gray-400"},h.toFixed(0),"%"]]})()}})];else return["div",{class:"text-2xl text-gray-500"},"No responses yet"]},HJ=function(u){let W=xG(u);if(R(Y0(W)))return["div",{class:"w-full max-w-2xl max-h-96 overflow-y-auto space-y-2"},Z0(function*(){for(let J of g(F1(W1,W))){let N=J,H=b0(N,0,null),K=b0(N,1,null);yield["div",{class:"p-3 bg-gray-700 rounded text-lg"},K]}})];else return["div",{class:"text-2xl text-gray-500"},"No responses yet"]},o1=(()=>{let u=function(...W){switch(W.length){case 1:return u.cljs$core$IFn$_invoke$arity$1(W[0]);case 2:return u.cljs$core$IFn$_invoke$arity$2(W[0],W[1]);default:throw Error(m("Invalid arity: ",W.length))}};return u.cljs$core$IFn$_invoke$arity$1=function(W){return o1(W,null)},u.cljs$core$IFn$_invoke$arity$2=function(W,J){let N=J1(W);return[O0,["div",{class:"text-center w-full"},["h1",{class:"text-4xl font-bold mb-8"},L(N,"text")],(()=>{switch(L(N,"kind")){case"scale":return[hu,W,N,J];case"choice":return[QJ,W,N];case"text":return[HJ,W];default:return["div","Unknown question type"]}})()]]},u.cljs$lang$maxFixedArity=2,u})(),UJ=function(u,W){let J=dG(u),N=J1(u),H=L0(N,["options","min"]),K=L0(N,["options","max"]),V=L0(N,["options","unit"]),h=800,Y=400,S=60,b=680,_=280;if(R(Y0(J))){let c=L(s0(J),"timestamp"),u0=L(q8(J),"timestamp"),x=Dq(1,u0-c),P=K-H,f=function($0){return 60+680*(($0-c)/x)},p=function($0){return 340-280*(($0-H)/P)},B=F1(function($0,G0){let l=G0,H0=L(l,"timestamp"),Q=L(l,"average"),z0=f(H0),i0=p(Q);if($0===0)return m("M ",z0," ",i0);else return m("L ",z0," ",i0)},J),e=Ku(" ",B),N0=L(q8(J),"average");return["div",{class:"w-full flex flex-col items-center"},["svg",{width:800,height:400,class:"bg-gray-800 rounded-lg"},["line",{x1:60,y1:60,x2:60,y2:340,stroke:"#4B5563","stroke-width":2}],["line",{x1:60,y1:340,x2:740,y2:340,stroke:"#4B5563","stroke-width":2}],Z0(function*(){for(let $0 of g([H,(H+K)/2,K])){let G0=$0;yield["text",{x:50,y:p(G0),fill:"#9CA3AF","text-anchor":"end","dominant-baseline":"middle","font-size":14},G0]}}),R(W)?["g",["line",{x1:60,y1:p(W),x2:740,y2:p(W),stroke:"#34D399","stroke-width":2,"stroke-dasharray":"8,4"}],["text",{x:750,y:p(W),fill:"#34D399","dominant-baseline":"middle","font-size":14},m(W,R(V)?V:null)]]:null,["path",{d:e,fill:"none",stroke:"#60A5FA","stroke-width":3}],Z0(function*(){for(let $0 of g(J)){let G0=$0,l=L(G0,"timestamp"),H0=L(G0,"average");yield["circle",{cx:f(l),cy:p(H0),r:4,fill:"#60A5FA"}]}}),["text",{x:f(L(q8(J),"timestamp"))+10,y:p(N0),fill:"#60A5FA","dominant-baseline":"middle","font-size":16,"font-weight":"bold"},N0.toFixed(1)]],["div",{class:"mt-4 text-xl text-gray-400"},"Average over ",I0(J)," responses"]]}else return["div",{class:"text-2xl text-gray-500"},"No responses yet"]},Q$=function(u,W){let J=J1(u);return[O0,["div",{class:"text-center w-full"},["h1",{class:"text-4xl font-bold mb-8"},"Convergence Over Time"],[UJ,u,W]]]},KJ=function(u){return[O0,["div",{class:"text-center"},["h1",{class:"text-6xl font-bold font-mono"},u]]]},OJ=function(u){switch(u){case"title":return[mG];case"about":return[oG];case"wotc":return[lG];case"q1":return[l1,"q1"];case"q1-results":return[o1,"q1"];case"wotc-answer":return[rG];case"rules":return[aG];case"q2":return[l1,"q2",TG];case"q2-results":return[o1,"q2",221];case"independence":return[sG];case"q3":return[XJ];case"q3-results":return[o1,"q3",1953];case"q3-trend":return[Q$,"q3",1953];case"diversity":return[eG];case"q4":return[l1,"q4"];case"q4-results":return[o1,"q4",73];case"q4-trend":return[Q$,"q4",73];case"ground-truth":return[qJ];case"q5":return[l1,"q5"];case"q5-results":return[o1,"q5"];case"q5-trend":return[Q$,"q5",null];case"point":return[$J];case"search-engines":return[wJ];case"llms":return[uJ];case"but-not-really":return[WJ];case"the-end":return[ZJ];case"tech-stack":return[JJ];default:return[KJ,u]}},Du=function(){let u=L(i(o),"slide-id");return["div",{class:"relative"},R(u)?[OJ,u]:[O0,["div",{class:"text-2xl text-gray-500"},"Waiting for presenter..."]],[fG]]},Bu=function(){return S8(m("https://",Vu),{width:200,margin:1}).then(function(u){return q0(o,J0,"qr-code-data",u)}).catch(function(u){return v0("QR code generation failed:",u)}),S8(GJ,{width:150,margin:1}).then(function(u){return q0(o,J0,"github-qr-code-data",u)}).catch(function(u){return v0("GitHub QR code generation failed:",u)}),G1(n0,"talk.display/connection",function(u,W,J,N){return q0(o,k1)}),Sq("audience",function(){return _q("audience",function(u){return q0(o,J0,"audience-count",I0(u))})}),D8(function(){return x1(function(u){if(R(u))return q0(o,J0,"slide-id",L(u,"slide-id"),"selected-speaker",L(u,"selected-speaker"))})}),D1("votes",CG),D1("speaker",kG),D1("reactions",iG),D1("control",function(u){return PG()}),setInterval(gG,5000)};var zJ="1tATiA.Rlyw7w:ZAjKA1HQea3nu2jtBE0-u_WVMXWtF4ONodw_MZn4kc0",FJ=function(){let u=new URLSearchParams(location.search);if(R(u.get("display")))return"display";else if(R(u.get("control")))return"presenter";else return"audience"},H$=FJ(),hJ=function(){let u=H$;switch(u){case"display":return[Du];case"presenter":return[w6];case"audience":return[G6];default:throw Error(m("No matching clause: ",u))}},Yu=function(){return fw(document.getElementById("app"),[hJ])},DJ=(()=>{let u=H$;switch(u){case"display":return o;case"presenter":return Q0;case"audience":return T0;default:throw Error(m("No matching clause: ",u))}})();G1(DJ,"talk.app/render",function(u,W,J,N){return Yu()});var BJ=function(){Yu(),aw(zJ);let u=H$;switch(u){case"display":return Bu();case"presenter":return u6();case"audience":return J6();default:throw Error(m("No matching clause: ",u))}};BJ();export{H$ as role,Yu as render,BJ as init_BANG_,FJ as get_role,DJ as current_state,hJ as app,zJ as ABLY_API_KEY};

//# debugId=522BD52B8E77212D64756E2164756E21
